<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="screen-orientation" content="portrait">
    <meta name="orientation" content="portrait">
    <meta name="theme-color" content="#F3F4F6" id="themeColorMeta">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="google" content="notranslate">
    
    <title>Naad Music Player</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        /* --- LOCAL FONTS SETUP --- */
        @font-face { font-family: 'Asap'; src: url('Asap-Light.otf') format('opentype'); font-weight: 300; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Asap'; src: url('Asap-Regular.otf') format('opentype'); font-weight: 400; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Asap'; src: url('Asap-Medium.otf') format('opentype'); font-weight: 500; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Asap'; src: url('Asap-SemiBold.otf') format('opentype'); font-weight: 600; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Asap'; src: url('Asap-Bold.otf') format('opentype'); font-weight: 700; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Tiro Devanagari Hindi'; src: url('TiroDevanagariHindi-Regular.ttf') format('truetype'); font-weight: 400; font-display: swap; }

        :root {
            /* --- THEME: VIOLET STORM --- */
            --bg-body: #F3F4F6;
            --surface: #FFFFFF;
            --surface-2: #E5E7EB;
            
            --text-main: #111827;
            --text-sub: #6B7280;
            --accent: #111827;
            --accent-text: #FFFFFF;
            
            --active-color: #7C3AED; 
            --active-bg-tint: rgba(124, 58, 237, 0.15);
            
            --border: #E5E7EB;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-float: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --safe-top: max(env(safe-area-inset-top), 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            
            --anim: cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-body: #09090b;
            --surface: #18181b;
            --surface-2: #27272a;
            --text-main: #fafafa;
            --text-sub: #a1a1aa;
            --accent: #fafafa;
            --accent-text: #09090b;
            --border: #27272a;
            
            --active-color: #8B5CF6; 
            --active-bg-tint: rgba(139, 92, 246, 0.2);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; touch-action: pan-y; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Asap', sans-serif;
            background-color: var(--bg-body); 
            background-image: radial-gradient(circle at 50% -10%, var(--active-bg-tint), transparent 70%);
            background-attachment: fixed;
            color: var(--text-main);
            height: 100dvh; overflow: hidden;
            display: flex; flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
            overscroll-behavior-y: none;
        }

        svg { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        svg.solid { fill: currentColor; stroke: none; }
        .icon-dots { fill: currentColor; stroke: none; }

        /* --- NEW ICON CLASS --- */
        .icon-std {
            width: 20px; height: 20px;
            fill: none; stroke: currentColor; 
            stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
            display: block; /* Helps with centering */
        }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--surface-2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-sub); }

        .btn {
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: 600; transition: transform 0.1s; border-radius: 12px;
        }
        .btn:active { transform: scale(0.94); }
        
        .btn-icon {
            width: 44px; height: 44px; background: var(--surface); color: var(--text-main);
            box-shadow: var(--shadow-card); flex-shrink: 0;
        }
        
        .btn-solid {
            background: var(--active-color); color: #fff;
            padding: 12px 24px; border-radius: 30px;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        header {
            height: calc(54px + var(--safe-top)); 
            padding-top: var(--safe-top);
            display: flex; align-items: center; justify-content: space-between;
            padding-inline: 20px; z-index: 50; 
            background: transparent; 
            flex-shrink: 0;
        }
        header .btn-icon { background: transparent; box-shadow: none; }
        
        /* Fixed dimensions and alignment */
        .header-actions .btn-icon {
            width: 38px; height: 38px;
            margin: 0;
            display: flex; align-items: center; justify-content: center;
        }

        .logo-btn {
            font-family: 'Tiro Devanagari Hindi', serif; 
            font-size: 26px; 
            font-weight: 700; 
            color: var(--active-color); 
            background: transparent; border: none; 
            padding: 0; padding-left: 10px; 
            cursor: pointer;
            display: flex; align-items: center;
            height: 100%;
        }
        .logo-text { position: relative; z-index: 1; display:flex; align-items:center; }
        .app-title { flex: 1; }
        
        .header-actions {
            display: flex; align-items: center; gap: 8px; height: 100%;
        }

        #appView {
            flex: 1; overflow: hidden; display: flex; flex-direction: column; padding-bottom: 0;
        }
        
        .container { 
            max-width: 800px; margin: 0 auto; width: 100%; 
            height: 100%; display: flex; flex-direction: column; 
        }

        .tabs-row {
            display: flex; gap: 0; padding: 4px; 
            margin: 10px 20px;
            background: transparent;
            border-radius: 16px;
            flex-shrink: 0;
        }
        .tab {
            flex: 1;
            padding: 10px 0; border-radius: 12px;
            background: transparent; color: var(--text-sub);
            font-weight: 600; font-size: 14px; white-space: nowrap;
            cursor: pointer; transition: 0.2s; border: none;
            text-align: center;
            letter-spacing: 0.5px;
        }
        .tab.active {
            background: var(--active-bg-tint); 
            color: var(--active-color);
            box-shadow: none;
        }
        
        #content {
            flex: 1; overflow-y: auto; padding-bottom: 120px;
            scroll-behavior: smooth;
        }

        .track-list { display: flex; flex-direction: column; gap: 0; padding: 10px 20px; }
        
        .track-group-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 24px 8px 8px; margin-top: 10px;
            border-bottom: none; 
            margin-bottom: 8px;
        }
        .group-name { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); }
        .group-ctrls { display: flex; gap: 12px; flex-shrink: 0; }
        
        .group-btn { 
            background: transparent; border: none; 
            padding: 6px 14px; border-radius: 8px;
            color: var(--active-color); cursor: pointer; display: flex; align-items: center; 
            font-weight: 600; font-size: 12px;
            transition: 0.2s;
        }
        .group-btn:hover { opacity: 0.8; }
        .group-btn svg { width: 16px; height: 16px; margin-right: 4px; stroke-width: 2.5; }

        .track-row {
            display: flex; align-items: center; gap: 16px;
            padding: 12px 8px; background: transparent;
            transition: opacity 0.2s; cursor: pointer;
            border: none; border-bottom: 1px solid transparent;
        }
        .track-row:hover { opacity: 0.7; }
        .track-row:active { opacity: 0.5; }
        
        .t-art {
            width: 50px; height: 50px; border-radius: 10px; background: var(--surface-2);
            overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        .t-art img { width: 100%; height: 100%; object-fit: cover; }
        
        .t-data { flex: 1; min-width: 0; }
        .t-title { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .t-meta { font-size: 13px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .more-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            color: var(--text-sub); border-radius: 50%;
        }
        .more-btn:active { background: var(--surface-2); color: var(--text-main); }

        .track-icon-filled { width: 28px; height: 28px; fill: var(--text-sub); stroke: none; }

        .grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 16px; padding: 20px;
        }
        .card {
            background: var(--surface); padding: 0; border-radius: 24px;
            text-align: center; cursor: pointer; position: relative;
            transition: transform 0.2s; box-shadow: var(--shadow-card);
            overflow: hidden;
            display: flex; flex-direction: column;
            height: 100%;
        }
        .card:active { transform: scale(0.96); }
        
        .card-img-container {
            width: 100%; 
            aspect-ratio: 1 / 1; 
            position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        .card-img {
            width: 100%; height: 100%; object-fit: cover;
            display: block;
        }
        
        .card-info {
            padding: 12px;
            flex-shrink: 0;
            display: flex; flex-direction: column; justify-content: center;
            position: relative; z-index: 2;
            flex: 1; 
        }
        
        .card-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
        .card-sub { font-size: 12px; opacity: 0.8; }

        .card-more {
            position: absolute; top: 10px; right: 10px; width: 32px; height: 32px;
            background: transparent; color: #fff; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            z-index: 10;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5); 
        }
        .card-more svg { fill: currentColor; stroke: none; }

        .card.shuffle-card {
            background: linear-gradient(135deg, #4C1D95, var(--active-color));
            color: #FFFFFF;
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
            gap: 0;
        }
        .shuffle-card svg { 
            width: 28px; height: 28px; 
            fill: none; stroke: #FFFFFF; stroke-width: 2; 
            margin: 12px; 
        }
        
        .track-row.shuffle-row { color: var(--active-color); }

        #miniPlayer {
            position: fixed; bottom: calc(20px + var(--safe-bottom)); left: 20px; right: 20px;
            height: 90px; 
            background: var(--surface);
            border-radius: 20px; box-shadow: var(--shadow-float);
            display: flex; align-items: center; padding: 0 12px; gap: 14px;
            transform: translateY(150%); transition: transform 0.4s var(--anim);
            z-index: 100; cursor: pointer; border: 1px solid var(--border);
            overflow: hidden;
        }
        #miniPlayer.visible { transform: translateY(0); }
        
        #mpBg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--active-color); opacity: 0; pointer-events: none; z-index: 0;
            transition: opacity 0.1s;
        }

        .mp-img { width: 48px; height: 48px; border-radius: 12px; background: var(--surface-2); overflow: hidden; flex-shrink: 0; position: relative; z-index: 1; }
        .mp-img img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .mp-img canvas { width: 100%; height: 100%; display: none; }
        
        .mp-data { flex: 1; min-width: 0; position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: center; }
        .t-title#mpTitle { margin-bottom: 4px; }
        
        .mp-prog-track { width: 100%; height: 3px; background: rgba(0,0,0,0.05); margin-top: 6px; border-radius: 2px; overflow: hidden; }
        [data-theme="dark"] .mp-prog-track { background: rgba(255,255,255,0.1); }
        .mp-prog-fill { height: 100%; width: 0%; background: var(--active-color); border-radius: 2px; transition: width 0.1s linear; }

        .mp-btn {
            width: 44px; height: 44px; border-radius: 12px;
            background: var(--accent); color: var(--accent-text);
            display: flex; align-items: center; justify-content: center; border: none; flex-shrink: 0;
            position: relative; z-index: 1;
        }
        
        .mp-icon-filled { width: 24px; height: 24px; fill: currentColor; stroke: none; }

        #fullPlayer {
            position: fixed; inset: 0; z-index: 200;
            background: var(--bg-body);
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s var(--anim);
        }
        #fullPlayer.visible { transform: translateY(0); }

        .fp-head {
            height: calc(50px + var(--safe-top)); 
            padding: var(--safe-top) 24px 0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .fp-head .btn-icon { background: transparent; box-shadow: none; }

        .fp-stage {
            flex: 1; display: flex; align-items: center; justify-content: center;
            flex-direction: column; position: relative;
        }
        .fp-art-frame {
            width: 85vw; height: 85vw; max-width: 380px; max-height: 380px;
            border-radius: 24px; 
            box-shadow: none;
            background: var(--surface-2); position: relative; overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 50;
            display: flex; align-items: center; justify-content: center;
        }
        .fp-art-frame:active { transform: scale(0.98); }
        .fp-art-frame img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; transition: opacity 0.3s; position: absolute; inset:0; z-index:1; }
        .fp-placeholder { 
            position: absolute; inset: 0; display: none; 
            align-items: center; justify-content: center;
            z-index: 0;
        }
        .fp-viz {
            position: absolute; inset: 0; width: 100%; height: 100%;
            background: #000; display: none; z-index: 2;
        }

        .fp-controls { padding: 30px 24px calc(50px + var(--safe-bottom)); background: var(--bg-body); position: relative; z-index: 20; }
        .fp-meta { text-align: center; margin-bottom: 30px; }
        
        .fp-title { 
            font-size: 24px; font-weight: 500; margin-bottom: 12px;
            white-space: normal; line-height: 1.3; overflow: visible;
        }
        .fp-artist { font-size: 16px; color: var(--text-main); font-weight: 300; }

        .bar-wrap { height: 24px; display: flex; align-items: center; cursor: pointer; }
        .bar-bg { width: 100%; height: 6px; background: var(--surface-2); border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--active-color); border-radius: 10px; }
        .time-row { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: var(--text-sub); margin-top: 4px; }

        .ctrl-row { display: flex; align-items: center; justify-content: space-between; margin-top: 20px; }
        .btn-ctrl { background: none; border: none; color: var(--text-main); padding: 10px; opacity: 0.7; transition: 0.2s; }
        .btn-ctrl.active { color: var(--active-color); opacity: 1; }
        .btn-play-lg {
            width: 72px; height: 72px; border-radius: 24px;
            background: var(--active-color); color: var(--accent-text);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.4);
        }
        .btn-play-lg svg { width: 32px; height: 32px; fill: currentColor; stroke: none; }

        .queue-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70%;
            background: var(--surface); border-radius: 30px 30px 0 0;
            transform: translateY(100%); transition: transform 0.3s var(--anim);
            z-index: 50; display: flex; flex-direction: column;
            box-shadow: 0 -10px 60px rgba(0,0,0,0.3);
        }
        .queue-sheet.open { transform: translateY(0); }
        .q-head {
            padding: 24px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: none;
        }
        .q-title { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .q-list { flex: 1; overflow-y: auto; padding: 10px 20px; scroll-behavior: smooth; }
        .q-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: none;
        }
        .q-item.active { color: var(--active-color); font-weight: 600; }
        .q-remove { color: var(--text-sub); opacity: 0.5; padding: 8px; cursor: pointer; }
        .q-remove:hover { color: #EF4444; opacity: 1; }
        .q-icon { margin-right: 12px; display: flex; align-items: center; color: var(--text-sub); }
        .q-icon svg { width: 20px; height: 20px; fill: currentColor; stroke: none; }

        .backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 300;
            opacity: 0; pointer-events: none; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; 
            backdrop-filter: blur(2px);
        }
        .backdrop.open { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            width: 85%; max-width: 320px;
            background: linear-gradient(160deg, var(--surface), var(--surface-2));
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 24px; /* Uniform padding top/bottom/sides */
            display: flex; flex-direction: column;
            gap: 12px;
            max-height: 80vh; 
            overflow-y: auto; /* Scroll bar inside container */
            position: relative;
            transform: scale(0.95); transition: 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .backdrop.open .modal-box { transform: scale(1); }

        #contextMenu .modal-box { max-width: 240px; } 
        .ctx-icon { width: 20px; height: 20px; fill: currentColor; stroke: none; margin-right: 12px; }

        .modal-header {
            text-align: center; margin-bottom: 8px;
            display: flex; flex-direction: column; align-items: center;
        }
        .modal-title {
            font-size: 14px; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1.5px; 
            color: var(--text-sub);
        }
        .brand-name {
            font-family: 'Tiro Devanagari Hindi', serif; font-size: 42px; 
            font-weight: 700; 
            color: var(--active-color); line-height: 0.8;
            margin-bottom: 2px; 
        }
        .brand-sub {
            font-family: 'Asap', sans-serif; font-size: 12px; letter-spacing: 1px; 
            font-weight: 600; color: var(--text-main); opacity: 0.8; 
            margin-top: 2px; 
        }

        .list-opt {
            background: transparent; color: var(--text-main);
            padding: 10px 12px; border-radius: 12px;
            font-size: 15px; font-weight: 600;
            cursor: pointer; transition: 0.1s; border: none;
            display: flex; align-items: center; justify-content: flex-start;
            text-align: left;
        }
        .list-opt:active { background: var(--surface-2); transform: scale(0.98); }
        .list-opt.danger { color: #EF4444; }

        .setting-group { margin-bottom: 8px; }
        .setting-label { 
            display: flex; align-items: center; gap: 8px; 
            font-size: 12px; font-weight: 700; color: var(--text-sub); 
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1.5px; 
        }
        .toggle-row { 
            display: flex; background: var(--surface-2); 
            padding: 4px; border-radius: 14px; gap: 4px; 
        }
        .toggle-btn {
            flex: 1; padding: 10px 0; 
            border: none; background: transparent; border-radius: 10px;
            font-size: 13px; font-weight: 600; font-family: inherit;
            cursor: pointer; color: var(--text-sub); transition: 0.2s;
        }
        body[data-theme="light"] #btnLight, body[data-theme="dark"] #btnDark { 
            background: var(--surface); color: var(--active-color); box-shadow: 0 1px 2px rgba(0,0,0,0.05); opacity: 1;
        }
        
        .action-col { display: flex; flex-direction: column; gap: 8px; }
        .action-btn {
            background: var(--surface-2); color: var(--text-main);
            padding: 14px; border-radius: 14px;
            font-size: 14px; font-weight: 600; text-align: left; 
            display: flex; align-items: center; gap: 14px;
            border: none; cursor: pointer; transition: 0.1s;
        }
        .action-btn:active { transform: scale(0.98); background: var(--border); }
        .action-btn svg { fill: var(--active-color); stroke: none; width: 22px; height: 22px; }

        .menu-footer { 
            text-align: center; font-size: 12px; font-weight: 600; 
            color: var(--text-sub); opacity: 0.7; margin-top: 8px;
            padding-bottom: 0px; 
        }
        
        .flag {
            display: inline-block; 
            width: 24px; height: 16px;
            background-image: url('Flag_of_India.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative; vertical-align: middle; margin-left: 8px;
            box-shadow: none;
            border: 1px solid rgba(0,0,0,0.1); 
        }

        .input-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; }
        .input-field {
            width: 100%; padding: 14px; border-radius: 12px;
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-main); font-family: inherit; margin-bottom: 12px;
        }
        .input-field:focus { border-color: var(--active-color); }

        #fileIn, #folderIn { display: none; }
        #colorCanvas { display: none; }
        
        .spinner {
            border: 4px solid var(--surface-2);
            border-top: 4px solid var(--active-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #searchResults { max-height: 250px; overflow-y: auto; display:flex; flex-direction:column; gap:4px; }
        #searchModal .modal-box { width: 90%; max-width: 380px; }

    </style>
</head>
<body data-theme="light">
    
    <canvas id="colorCanvas" width="1" height="1"></canvas>

    <div class="backdrop" id="syncModal">
        <div class="modal-box" style="align-items:center; text-align:center;">
            <div class="spinner"></div>
            <div style="font-weight:700; color:var(--text-main);">Scanning Library</div>
            <div id="syncStatus" style="font-size:12px; color:var(--text-sub);">Finding music files</div>
        </div>
    </div>

    <div class="backdrop" id="permPopup">
        <div class="modal-box" style="text-align:center; align-items:center; gap:16px;">
            <div style="font-size:18px; font-weight:700; color:var(--text-main);">Permission Required</div>
            <div style="font-size:14px; color:var(--text-sub);">Please allow access to media files to play your music.</div>
            <button class="btn btn-solid" onclick="grantPerms()">Give Permission</button>
        </div>
    </div>
    
    <div class="backdrop" id="searchModal" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Search</div>
            </div>
            <input type="text" class="input-field" id="searchInput" placeholder="Search tracks, artists..." oninput="app.performSearch(this.value)">
            <div id="searchResults"></div>
        </div>
    </div>

    <div class="backdrop" id="addMenu" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span class="brand-name">नाद</span>
                <span class="brand-sub">Naad Music Player</span>
                <span style="font-size: 10px; font-weight: 600; color: var(--text-sub); margin-top: 16px; opacity: 0.6;">VERSION: 1.1</span>
            </div>

            <div class="setting-group">
                <div class="setting-label">Appearance</div>
                <div class="toggle-row">
                     <button class="toggle-btn" id="btnLight" onclick="if(document.body.getAttribute('data-theme')!=='light') {app.toggleTheme(); ui.closeModals();}">Light</button>
                     <button class="toggle-btn" id="btnDark" onclick="if(document.body.getAttribute('data-theme')!=='dark') {app.toggleTheme(); ui.closeModals();}">Dark</button>
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-label">Library</div>
                <div class="action-col">
                    <button class="action-btn" onclick="triggerFile()">
                        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                        <div style="flex:1;">Add Files</div>
                        <span id="menuSongCount" style="font-size:11px; opacity:0.6; font-weight:400; white-space:nowrap;">0 songs</span>
                    </button>
                    <button class="action-btn" onclick="triggerFolder()">
                        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                         <div style="flex:1;">Add Folders</div>
                         <span id="menuFolderCount" style="font-size:11px; opacity:0.6; font-weight:400; white-space:nowrap;">0 folders</span>
                    </button>
                    <button class="action-btn" onclick="app.syncLibrary(); ui.closeModals();">
                        <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                        Sync Storage
                    </button>
                    <button class="action-btn" onclick="app.reset(); ui.closeModals();">
                        <svg viewBox="0 0 24 24" style="fill:#EF4444"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        Clear Library
                    </button>
                    
                    <div style="background:transparent; padding:4px 14px; margin-top:0px; font-size:11px; font-weight:600; color:var(--text-sub); opacity:0.7; display:flex; align-items:center; justify-content:center;">
                        <div>Music Storage: <span id="storageCount">0 MB</span></div>
                    </div>
                </div>
            </div>

            <div class="menu-footer">
                Designed and Developed by <a href="mailto:writetobjd@gmail.com" style="color:var(--active-color);text-decoration:underline;">Bhaskarjyoti Das</a>
                <div style="margin-top: 24px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    Made in India <div class="flag"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="backdrop" id="sortModal" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Sort By</div>
            </div>
            <div id="sortOptions">
                </div>
        </div>
    </div>

    <div class="backdrop" id="contextMenu" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="ctxTitle">Options</div>
            </div>
            <div id="ctxContent" style="display:flex; flex-direction:column; gap:4px;"></div>
        </div>
    </div>

    <div class="backdrop" id="editModal" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Edit Metadata</div>
            </div>
            <input type="hidden" id="editId">
            <div class="input-group"><label>Title</label><input type="text" class="input-field" id="editTitle"></div>
            <div class="input-group"><label>Artist</label><input type="text" class="input-field" id="editArtist"></div>
            <div class="input-group"><label>Album</label><input type="text" class="input-field" id="editAlbum"></div>
            <button class="btn btn-solid" style="width:100%" onclick="app.saveEdit()">Save Changes</button>
        </div>
    </div>

    <header>
        <button class="logo-btn" onclick="document.getElementById('addMenu').classList.add('open')">
            <span class="logo-text">नाद</span>
        </button>
        <div class="app-title"></div> 
        <div class="header-actions">
            <button class="btn btn-icon" id="btnViewToggle" onclick="app.toggleView()" style="display:none;">
            </button>
            <button class="btn btn-icon" onclick="app.showSortMenu()">
                 <svg class="icon-std" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M6 12h12"/><path d="M10 18h4"/></svg>
            </button>
            <button class="btn btn-icon" onclick="app.openSearch()">
                <svg class="icon-std" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </button>
            </div>
    </header>

    <div id="appView">
        <div class="container">
            <div class="tabs-row">
                <div class="tab active" id="tab-tracks" onclick="ui.setTab('tracks')">Tracks</div>
                <div class="tab" id="tab-artists" onclick="ui.setTab('artists')">Artists</div>
                <div class="tab" id="tab-albums" onclick="ui.setTab('albums')">Albums</div>
                <div class="tab" id="tab-folders" onclick="ui.setTab('folders')">Folders</div>
            </div>
            <div id="content"></div>
        </div>
    </div>

    <div id="miniPlayer" onclick="ui.openPlayer()">
        <div id="mpBg"></div> 
        <div class="mp-img">
            <img id="mpArt" src="">
            <canvas id="mpVizCanvas"></canvas>
        </div>
        <div class="mp-data">
            <div class="t-title" id="mpTitle">Not Playing</div>
            <div class="t-meta" id="mpArtist">Select a track</div>
            <div class="mp-prog-track"><div class="mp-prog-fill" id="mpFill"></div></div>
        </div>
        <button class="mp-btn" id="mpBtn" onclick="event.stopPropagation(); player.toggle()">
            <svg><path d="M5 3l14 9-14 9V3z"/></svg>
        </button>
    </div>

    <div id="fullPlayer">
        <div class="fp-head">
            <button class="btn btn-icon" onclick="ui.closePlayer()">
                <svg><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
            </button>
            <div style="font-weight:400; font-size:12px; letter-spacing:1px; opacity:0.9; color:var(--text-main);"></div> 
            <button class="btn btn-icon" style="color:var(--active-color); background:transparent; box-shadow:none;" onclick="player.toggleQueue()">
                <svg><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            </button>
        </div>

        <div class="fp-stage" id="fpTouchArea">
            <div class="fp-art-frame" onclick="viz.toggle()">
                <img id="fpArt" src="">
                <div id="fpPlaceholder" class="fp-placeholder">
                     <svg class="track-icon-filled" style="width:120px;height:120px;opacity:0.4" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-12.5c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>
                </div>
                <canvas id="vizCanvas" class="fp-viz"></canvas>
            </div>
        </div>

        <div class="fp-controls">
            <div class="fp-meta">
                <div class="fp-title" id="fpTitle">Title</div>
                <div class="fp-artist" id="fpArtist">Artist</div>
            </div>

            <div class="bar-wrap" id="scrubber">
                <div class="bar-bg"><div class="bar-fill" id="fpFill"></div></div>
            </div>
            <div class="time-row"><span id="tCurr">0:00</span><span id="tDur">0:00</span></div>

            <div class="ctrl-row">
                <button class="btn-ctrl" id="btnShuf" onclick="player.toggleShuffle()">
                    <svg><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>
                </button>
                <button class="btn-ctrl" onclick="player.prev()"><svg><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
                <button class="btn btn-play-lg" id="fpPlayBtn" onclick="player.toggle()">
                    <svg><path d="M5 3l14 9-14 9V3z"/></svg>
                </button>
                <button class="btn-ctrl" onclick="player.next()"><svg><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
                <button class="btn-ctrl" id="btnRep" onclick="player.toggleRepeat()"><svg><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg></button>
            </div>
        </div>

        <div class="queue-sheet" id="queueSheet">
            <div class="q-head">
                <div class="q-title">Up Next</div>
                <button class="btn btn-icon" style="width:32px;height:32px;background:transparent;box-shadow:none;" onclick="player.toggleQueue()">
                    <svg><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
            </div>
            <div class="q-list" id="qList"></div>
        </div>
    </div>

    <input type="file" id="fileIn" multiple accept="audio/*">
    <input type="file" id="folderIn" webkitdirectory directory multiple>

    <script>
        // Keep helper functions and state init as before
        function updateStatusBarColor() {
            const theme = document.body.getAttribute('data-theme');
            const meta = document.getElementById('themeColorMeta');
            const color = theme === 'dark' ? '#09090b' : '#F3F4F6';
            if (meta) meta.setAttribute('content', color);
            const appleMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
            if (appleMeta) {
                appleMeta.setAttribute('content', theme === 'dark' ? 'black' : 'default');
            }
        }

        const DB_NAME = 'NaadQueueDB';
        const STORE_TRACKS = 'tracks';
        const STORE_IMAGES = 'images';
        let db;
        const state = { 
            tracks: [], images: {}, queue: [], qIdx: -1, 
            tab: 'tracks', playing: false, shuffle: false, repeat: 0, 
            visMode: 2, // DEFAULT CHANGED TO SPEAKER
            viewGroup: null, miniVizActive: false, currentFolder: '',
            viewMode: 'grid', 
            sortMode: 'name' 
        };
        
        function getDominantColor(imgEl, callback) {
            if(!imgEl.complete) {
                imgEl.onload = () => extract(imgEl, callback);
            } else {
                extract(imgEl, callback);
            }
        }
        function extract(img, cb) {
            try {
                const c = document.getElementById('colorCanvas');
                const ctx = c.getContext('2d');
                ctx.clearRect(0,0,1,1);
                ctx.drawImage(img, 0, 0, 1, 1);
                const p = ctx.getImageData(0,0,1,1).data;
                const rgb = `rgb(${p[0]},${p[1]},${p[2]})`;
                const lum = (0.299*p[0] + 0.587*p[1] + 0.114*p[2]);
                const textCol = lum > 128 ? '#000000' : '#FFFFFF';
                cb(rgb, textCol);
            } catch(e) { cb('var(--surface)', 'var(--text-main)'); }
        }

        async function init() {
            try {
                const saved = JSON.parse(localStorage.getItem('naadSettings') || '{}');
                if (saved.theme) {
                    document.body.setAttribute('data-theme', saved.theme);
                } else {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.body.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                }

                updateStatusBarColor();

                state.shuffle = saved.shuffle || false;
                state.repeat = saved.repeat || 0;
                state.viewMode = saved.viewMode || 'grid';
                state.sortMode = saved.sortMode || 'name';
                state.currentFolder = saved.currentFolder || '';
                
                document.getElementById('btnShuf').classList.toggle('active', state.shuffle);
                document.getElementById('btnRep').classList.toggle('active', state.repeat > 0);
            } catch(e) {}

            if(window.Capacitor) {
                try {
                    const stat = await Capacitor.Plugins.Filesystem.checkPermissions();
                    if(stat.publicStorage !== 'granted') document.getElementById('permPopup').classList.add('open');
                } catch(e) { document.getElementById('permPopup').classList.add('open'); }
            }

            db = await openDB();
            (await getAll(STORE_IMAGES)).forEach(i => state.images[i.path] = i.blob);
            state.tracks = (await getAll(STORE_TRACKS)).sort((a,b) => b.added - a.added);
            
            player.setupSession(); 
            ui.render();
            viz.setup();
            setupSwipe();
        }

        async function grantPerms() {
            try {
                await Capacitor.Plugins.Filesystem.requestPermissions();
                document.getElementById('permPopup').classList.remove('open');
            } catch(e) {
                alert("Permission required to scan music.");
            }
        }

        // ... Keep nativeScan, scanDir, setupSwipe, triggerFile/Folder, processFiles, helpers intact ...
        async function nativeScan() {
            if (!window.Capacitor) {
                alert("Native scanning is only available in the app.");
                return;
            }
            const fs = Capacitor.Plugins.Filesystem;
            try {
                const permissionStatus = await fs.requestPermissions();
                if (permissionStatus && permissionStatus.publicStorage === 'denied') {
                    throw new Error("Storage permission was denied by user.");
                }
                const modal = document.getElementById('syncModal');
                const status = document.getElementById('syncStatus');
                modal.classList.add('open');
                
                const pathsToScan = ['Music', 'Download', 'Documents'];
                let addedCount = 0;
                const updateStatus = (msg) => { status.textContent = msg; };
                for (let root of pathsToScan) {
                    addedCount += await scanDir(root, fs, updateStatus);
                }
                if (addedCount > 0) {
                    state.tracks.sort((a,b) => b.added - a.added);
                    ui.render();
                    alert(`Sync Complete. Added ${addedCount} new tracks.`);
                } else {
                    alert("No new music files found in standard folders.");
                }
            } catch (err) {
                console.error("Scan Error:", err);
                alert("Unable to scan. Please ensure Storage Permissions are allowed in Settings.");
            } finally {
                document.getElementById('syncModal').classList.remove('open');
                document.getElementById('syncStatus').textContent = "Finding music files";
            }
        }

        async function scanDir(path, fs, statusCb) {
            let count = 0;
            try {
                if(statusCb) statusCb(`Scanning: ${path}`);
                const res = await fs.readdir({ path: path, directory: 'EXTERNAL_STORAGE' });
                for (const file of res.files) {
                    if (file.type === 'file') {
                        if (/\.(mp3|wav|flac|m4a)$/i.test(file.name)) {
                            let size = file.size;
                            if (!size) {
                                try {
                                    const stat = await fs.stat({ path: path + '/' + file.name, directory: 'EXTERNAL_STORAGE' });
                                    size = stat.size;
                                } catch(e){}
                            }
                            if (size && size > 1048576) {
                                const id = `native-${file.name}-${size}`;
                                if(!state.tracks.find(t=>t.id===id)) {
                                    if(statusCb) statusCb(`Found: ${file.name}`);
                                    const fileUri = await fs.getUri({ path: path + '/' + file.name, directory: 'EXTERNAL_STORAGE' });
                                    const srcUrl = Capacitor.convertFileSrc(fileUri.uri);
                                    const t = {
                                        id, name: file.name.replace(/\.[^/.]+$/,""),
                                        artist: 'Unknown', album: 'Unknown',
                                        genre: 'Unknown',
                                        folder: path, 
                                        blob: null, 
                                        url: srcUrl,
                                        added: Date.now()
                                    };
                                    await put(STORE_TRACKS, t); 
                                    state.tracks.push(t); 
                                    count++;
                                }
                            }
                        }
                    } else if (file.type === 'directory') {
                        count += await scanDir(path + '/' + file.name, fs, statusCb);
                    }
                }
            } catch(e) { }
            return count;
        }

        function setupSwipe() {
            let startY = 0;
            let startX = 0;
            const fp = document.getElementById('fullPlayer');
            const qs = document.getElementById('queueSheet');
            const av = document.getElementById('appView');

            let avSx = 0;
            av.addEventListener('touchstart', e => avSx = e.touches[0].clientX, {passive:true});
            av.addEventListener('touchend', e => {
                const diff = avSx - e.changedTouches[0].clientX;
                if(Math.abs(diff) > 60) {
                    const tabs = ['tracks', 'artists', 'albums', 'folders'];
                    const idx = tabs.indexOf(state.tab);
                    if(diff > 0 && idx < tabs.length-1) ui.setTab(tabs[idx+1]); 
                    if(diff < 0 && idx > 0) ui.setTab(tabs[idx-1]); 
                }
            }, {passive:true});
            
            fp.addEventListener('touchstart', e => {
                startY = e.touches[0].clientY;
                startX = e.touches[0].clientX;
            }, {passive:true});
            
            fp.addEventListener('touchend', e => {
                const endY = e.changedTouches[0].clientY;
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                const diffY = startY - endY;
                
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    if (Math.abs(diffX) > 60) {
                        ui.closePlayer();
                    }
                } else {
                    if (diffY > 50 && !qs.classList.contains('open')) {
                        player.toggleQueue();
                    } else if (diffY < -50 && !qs.classList.contains('open')) {
                        ui.closePlayer();
                    }
                }
            }, {passive:true});

            qs.addEventListener('touchstart', e => startY = e.touches[0].clientY, {passive:true});
            qs.addEventListener('touchend', e => {
                const endY = e.changedTouches[0].clientY;
                if(endY - startY > 50 && qs.classList.contains('open')) player.toggleQueue(); 
            }, {passive:true});
        }

        function triggerFile() { document.getElementById('fileIn').click(); ui.closeModals(); }
        function triggerFolder() { document.getElementById('folderIn').click(); ui.closeModals(); }
        document.getElementById('fileIn').onchange = e => processFiles(e.target.files);
        document.getElementById('folderIn').onchange = e => processFiles(e.target.files);

        async function processFiles(files) {
            const modal = document.getElementById('syncModal');
            const status = document.getElementById('syncStatus');
            modal.classList.add('open');
            status.textContent = "Analyzing files...";

            const list = Array.from(files);
            for(const f of list) {
                if(f.type.startsWith('image/')) {
                    const p = getPath(f.webkitRelativePath||f.name);
                    if(p) { state.images[p]=f; put(STORE_IMAGES, {path:p, blob:f}); }
                }
            }
            let count=0;
            for(const f of list) {
                if(f.type.startsWith('audio/') || /\.(mp3|wav|flac|m4a)$/i.test(f.name)) {
                    status.textContent = `Processing: ${f.name}`;
                    await new Promise(r => setTimeout(r, 0));
                    const id = `${f.name}-${f.size}`;
                    if(!state.tracks.find(t=>t.id===id)) {
                        const meta = await parseID3(f);
                        const t = {
                            id, name: f.name.replace(/\.[^/.]+$/,""),
                            artist: meta.artist||'Unknown', album: meta.album||'Unknown',
                            genre: meta.genre||'Unknown',
                            folder: getPath(f.webkitRelativePath), blob: f, added: Date.now()
                        };
                        await put(STORE_TRACKS, t); state.tracks.push(t); count++;
                    }
                }
            }
            state.tracks.sort((a,b)=>b.added-a.added);
            ui.render();
            modal.classList.remove('open');
            status.textContent = "Finding music files";
            alert(`Added ${count} tracks.`);
        }
        function getPath(s) { if(!s) return ""; const p=s.split('/'); p.pop(); return p.join('/'); }
        function getTrackSize(t) {
            if(t.blob) return t.blob.size;
            const match = t.id.match(/-(\d+)$/);
            return match ? parseInt(match[1]) : 0;
        }
        function formatPathHeader(p) {
            if(!p) return 'Unknown';
            const parts = p.split('/');
            if(parts.length < 2) return p;
            return parts[parts.length-2] + ' / ' + parts[parts.length-1];
        }
        function getRecursiveArt(folderPath) {
            const match = state.tracks.find(t => t.folder === folderPath || t.folder.startsWith(folderPath + '/'));
            if(match) {
                if(state.images[match.folder]) return state.images[match.folder];
                const subMatch = state.tracks.find(t => t.folder.startsWith(folderPath) && state.images[t.folder]);
                if(subMatch) return state.images[subMatch.folder];
            }
            return null;
        }
        async function parseID3(file) {
            const meta = {};
            try {
                const b = await file.slice(0,30000).arrayBuffer();
                const v = new DataView(b);
                if(v.getUint8(0)===73 && v.getUint8(1)===68) {
                    let o=10, sz=b.byteLength;
                    while(o<sz) {
                        const id = String.fromCharCode(v.getUint8(o),v.getUint8(o+1),v.getUint8(o+2),v.getUint8(o+3));
                        const s = v.getUint32(o+4);
                        if(s>5000||s===0) break;
                        if(['TIT2','TPE1','TALB','TCON'].includes(id)) {
                            let str=''; for(let i=1;i<s;i++){ const c=v.getUint8(o+10+i); if(c>31&&c<127) str+=String.fromCharCode(c); }
                            if(id==='TIT2') meta.title=str;
                            if(id==='TPE1') meta.artist=str;
                            if(id==='TALB') meta.album=str;
                            if(id==='TCON') meta.genre=str;
                        }
                        o+=10+s;
                    }
                }
            } catch(e){}
            return meta;
        }

        const ui = {
            setTab: (t) => { 
                state.viewGroup=null; 
                state.tab=t; 
                document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active')); 
                document.getElementById('tab-'+t).classList.add('active'); 
                ui.render(); 
            },
            updateViewBtn: () => {
                const btn = document.getElementById('btnViewToggle');
                if(state.viewMode === 'grid') {
                    btn.innerHTML = `<svg class="icon-std" viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="12" x2="16" y2="12"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>`;
                } else {
                    btn.innerHTML = `<svg class="icon-std" viewBox="0 0 24 24"><rect x="3" y="3" width="8" height="8" rx="1"></rect><rect x="13" y="3" width="8" height="8" rx="1"></rect><rect x="13" y="13" width="8" height="8" rx="1"></rect><rect x="3" y="13" width="8" height="8" rx="1"></rect></svg>`;
                }
            },
            openGroup: (k, l) => { state.viewGroup={title:k, list:l}; ui.render(); },
            closeGroup: () => { state.viewGroup=null; ui.render(); },
            setFolder: (path) => { state.currentFolder = path; app.saveSettings(); ui.render(); },
            upFolder: () => {
                if(!state.currentFolder) return;
                const p = state.currentFolder.split('/');
                p.pop();
                state.currentFolder = p.join('/');
                app.saveSettings(); 
                ui.render();
            },
            closeModals: () => document.querySelectorAll('.backdrop').forEach(e=>e.classList.remove('open')),
            openPlayer: () => document.getElementById('fullPlayer').classList.add('visible'),
            closePlayer: () => document.getElementById('fullPlayer').classList.remove('visible'),
            
            render: () => {
                // ... same render function logic as before ...
                const btn = document.getElementById('btnViewToggle');
                document.getElementById('menuSongCount').textContent = state.tracks.length + ' songs';
                const uniqueFolders = new Set(state.tracks.map(t=>t.folder)).size;
                document.getElementById('menuFolderCount').textContent = uniqueFolders + ' folders';
                
                let size = 0;
                state.tracks.forEach(t => { if(t.blob) size += t.blob.size; });
                Object.values(state.images).forEach(b => size += b.size);
                size += JSON.stringify(state.tracks).length; 

                let sizeStr = '0 MB';
                if(size > 1024*1024*1024*1024) sizeStr = (size/(1024*1024*1024*1024)).toFixed(2) + ' TB';
                else if(size > 1024*1024*1024) sizeStr = (size/(1024*1024*1024)).toFixed(2) + ' GB';
                else sizeStr = (size/(1024*1024)).toFixed(1) + ' MB';
                document.getElementById('storageCount').textContent = sizeStr;

                const c = document.getElementById('content'); c.innerHTML='';
                if (state.tab === 'tracks') btn.style.display = 'none';
                else if (state.viewGroup) btn.style.display = 'none';
                else if (state.tab !== 'folders') {
                     btn.style.display = 'flex';
                     ui.updateViewBtn();
                }

                if(!state.tracks.length) {
                     // ... empty state logic (same as before) ...
                     const isNative = typeof Capacitor !== 'undefined';
                     const actionBtn = isNative 
                        ? `<button class="btn" onclick="app.syncLibrary()" style="background:var(--active-color); color:#fff; padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:0 4px 12px rgba(124,58,237,0.3);"><svg style="width:20px;height:20px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>Sync Storage</button>`
                        : `<button class="btn" onclick="triggerFolder()" style="background:var(--active-color); color:#fff; padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:0 4px 12px rgba(124,58,237,0.3);"><svg style="width:20px;height:20px;fill:currentColor;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Add Folder</button>`;
                    c.innerHTML = `<div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px;"><div style="font-size:14px; font-weight:600; color:var(--text-sub); margin-bottom:8px; opacity:0.6; letter-spacing:1px;">LIBRARY EMPTY</div><button class="btn" onclick="triggerFile()" style="background:var(--surface-2); color:var(--text-main); padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:none;"><svg style="width:20px;height:20px;fill:var(--text-sub);" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Add Music Files</button>${actionBtn}</div>`;
                    return;
                }
                
                if(state.viewGroup) {
                    const list = state.viewGroup.list;
                    const h = document.createElement('div');
                    h.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:20px;';
                    h.innerHTML = `<div style="display:flex; align-items:center; gap:10px; flex:1; min-width:0; padding-right:24px;"><button class="btn btn-icon" style="background:transparent; box-shadow:none; flex-shrink:0;" onclick="ui.closeGroup()"><svg><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg></button><div style="font-size:18px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${state.viewGroup.title}</div></div><div style="display:flex; gap:12px; align-items:center; flex-shrink:0;"><button class="group-btn" onclick="player.playQueue(state.viewGroup.list, 0)">Play All</button><button class="group-btn" onclick="player.playShuffle(state.viewGroup.list)"><svg style="fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg></button></div>`;
                    const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 20px';
                    list.forEach(t => l.appendChild(ui.row(t, list)));
                    c.appendChild(h); c.appendChild(l);
                    return;
                }

                if(state.tab === 'folders') {
                    // ... folder rendering logic (same) ...
                    const root = state.currentFolder;
                    const subFolders = {}; const files = [];
                    state.tracks.forEach(t => {
                        if (!root || t.folder === root || t.folder.startsWith(root + '/')) {
                             const relative = root ? t.folder.substring(root.length + 1) : t.folder;
                             if (!relative) files.push(t);
                             else { const parts = relative.split('/'); const sub = parts[0]; if(!subFolders[sub]) subFolders[sub] = []; subFolders[sub].push(t); }
                        }
                    });
                    const folderNames = Object.keys(subFolders);
                    if (folderNames.length > 0) { btn.style.display = 'flex'; ui.updateViewBtn(); } else { btn.style.display = 'none'; }

                    if(root) {
                        const rootEsc = root.replace(/'/g, "\\'");
                        const h = document.createElement('div');
                        h.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:10px 20px;';
                        h.innerHTML = `<div style="display:flex; align-items:center; gap:12px; flex:1; min-width:0;"><button class="btn btn-icon" style="width:36px; height:36px; background:transparent; box-shadow:none; flex-shrink:0;" onclick="ui.upFolder()"><svg><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg></button><div style="font-weight:700; font-size:16px; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${root.split('/').pop()}</div></div><div class="group-ctrls"><button class="group-btn" title="Play All" onclick="player.playQueue(state.tracks.filter(t => t.folder === '${rootEsc}' || t.folder.startsWith('${rootEsc}/')), 0)"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>Play</button><button class="group-btn" title="Shuffle" onclick="player.playShuffle(state.tracks.filter(t => t.folder === '${rootEsc}' || t.folder.startsWith('${rootEsc}/')))"><svg style="fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg></button></div>`;
                        c.appendChild(h);
                    }
                    const getFSize = (arr) => arr.reduce((acc, t) => acc + getTrackSize(t), 0);
                    const getFDate = (arr) => Math.max(...arr.map(t => t.added));
                    const getFArtist = (arr) => (arr[0] ? (arr[0].artist || '') : '');

                    if(state.sortMode === 'count') folderNames.sort((a,b) => subFolders[b].length - subFolders[a].length);
                    else if(state.sortMode === 'date') folderNames.sort((a,b) => getFDate(subFolders[b]) - getFDate(subFolders[a]));
                    else if(state.sortMode === 'size') folderNames.sort((a,b) => getFSize(subFolders[b]) - getFSize(subFolders[a]));
                    else if(state.sortMode === 'artist') folderNames.sort((a,b) => getFArtist(subFolders[a]).localeCompare(getFArtist(subFolders[b])));
                    else folderNames.sort(); 

                    if(folderNames.length > 0) {
                        if (state.viewMode === 'list') {
                            const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 0'; 
                            folderNames.forEach(name => {
                                const fullPath = root ? root + '/' + name : name;
                                const blob = getRecursiveArt(fullPath); const imgSrc = blob ? URL.createObjectURL(blob) : null;
                                let imgHTML = imgSrc ? `<img src="${imgSrc}">` : `<div style="width:100%;height:100%;background:var(--surface-2);display:flex;align-items:center;justify-content:center"><svg class="track-icon-filled" style="width:24px;height:24px" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div>`;
                                const el = document.createElement('div'); el.className='track-row';
                                el.innerHTML = `<div class="t-art">${imgHTML}</div><div class="t-data"><div class="t-title">${name}</div><div class="t-meta">${subFolders[name].length} tracks</div></div><div class="more-btn" onclick="event.stopPropagation(); app.ctxGroup('${name}')"><svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></div>`;
                                el.onclick = () => ui.setFolder(fullPath); l.appendChild(el);
                            });
                            c.appendChild(l);
                        } else {
                            const g = document.createElement('div'); g.className='grid';
                            folderNames.forEach(name => {
                                const fullPath = root ? root + '/' + name : name;
                                const el = document.createElement('div'); el.className='card';
                                const blob = getRecursiveArt(fullPath); const imgSrc = blob ? URL.createObjectURL(blob) : null;
                                let imgHTML = imgSrc ? `<img src="${imgSrc}" class="card-img" crossorigin="anonymous">` : `<div style="width:100%;height:100%;background:var(--surface-2);display:flex;align-items:center;justify-content:center"><svg class="track-icon-filled" style="width:56px;height:56px;opacity:0.4" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div>`;
                                el.innerHTML = `<div class="card-img-container">${imgHTML}</div><div class="card-info"><div class="card-text card-title">${name}</div><div class="card-text card-sub">${subFolders[name].length} tracks</div></div>`;
                                if(imgSrc) { const imgEl = el.querySelector('img'); getDominantColor(imgEl, (bgCol, textCol) => { el.style.background = bgCol; el.querySelector('.card-title').style.color = textCol; el.querySelector('.card-sub').style.color = textCol; }); }
                                el.onclick = () => ui.setFolder(fullPath); g.appendChild(el);
                            });
                            c.appendChild(g);
                        }
                    }
                    if(files.length > 0) { const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 20px'; files.forEach(t => l.appendChild(ui.row(t, files))); c.appendChild(l); }
                    
                } else if(state.tab === 'tracks') {
                    // ... tracks render (same) ...
                    const groups = {}; state.tracks.forEach(t => { const f = t.folder || 'Root'; if (!groups[f]) groups[f] = []; groups[f].push(t); });
                    const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 20px';
                    Object.keys(groups).sort().forEach(folder => {
                        const list = groups[folder]; const headerName = formatPathHeader(folder);
                        const gh = document.createElement('div'); gh.className = 'track-group-header';
                        gh.innerHTML = `<div class="group-name" style="white-space:normal; overflow:visible; line-height:1.2;">${headerName}</div><div class="group-ctrls"><button class="group-btn" title="Play All" onclick="player.playQueue(state.tracks.filter(t=>t.folder==='${folder.replace(/'/g,"\\'")}'), 0)"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>Play</button><button class="group-btn" title="Shuffle" onclick="player.playShuffle(state.tracks.filter(t=>t.folder==='${folder.replace(/'/g,"\\'")}'))"><svg style="fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg></button></div>`;
                        l.appendChild(gh); list.forEach(t => l.appendChild(ui.row(t, state.tracks)));
                    });
                    c.appendChild(l);
                } else {
                    // ... artists/albums render (same) ...
                    const groups={}; const k=state.tab.slice(0,-1); 
                    state.tracks.forEach(t=>{ const key=t[k]||t.folder||'Unknown'; if(!groups[key]) groups[key]=[]; groups[key].push(t); });
                    const keys = Object.keys(groups);
                    if(state.sortMode === 'count') keys.sort((a,b) => groups[b].length - groups[a].length); else keys.sort();

                    if (state.viewMode === 'list') {
                        const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 20px';
                        const shufEl = document.createElement('div'); shufEl.className='track-row shuffle-row';
                        shufEl.innerHTML = `<div class="t-art" style="background:var(--active-bg-tint); color:var(--active-color);"><svg style="width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg></div><div class="t-data"><div class="t-title" style="color:var(--active-color);">Shuffle All</div><div class="t-meta" style="color:var(--active-color); opacity:0.7;">${state.tracks.length} Songs</div></div>`;
                        shufEl.onclick = () => { player.playShuffle(state.tracks); ui.closeModals(); };
                        l.appendChild(shufEl);
                        keys.forEach(key => {
                            const track = groups[key][0]; const imgSrc = state.images[track.folder] ? URL.createObjectURL(state.images[track.folder]) : null;
                            let imgHTML = imgSrc ? `<img src="${imgSrc}">` : `<div style="width:100%;height:100%;background:var(--surface-2);display:flex;align-items:center;justify-content:center"><svg class="track-icon-filled" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-12.5c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg></div>`;
                            const el = document.createElement('div'); el.className='track-row';
                            el.innerHTML = `<div class="t-art">${imgHTML}</div><div class="t-data"><div class="t-title">${key}</div><div class="t-meta">${groups[key].length} Songs</div></div><div class="more-btn" onclick="event.stopPropagation(); app.ctxGroup('${key}')"><svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></div>`;
                            el.onclick = () => ui.openGroup(key, groups[key]); l.appendChild(el);
                        });
                        c.appendChild(l);
                    } else {
                        const g = document.createElement('div'); g.className='grid';
                        keys.forEach(key => {
                            const track = groups[key][0]; const el = document.createElement('div'); el.className='card';
                            const imgSrc = state.images[track.folder] ? URL.createObjectURL(state.images[track.folder]) : null;
                            let imgHTML = imgSrc ? `<img src="${imgSrc}" class="card-img" crossorigin="anonymous">` : `<div style="width:100%;height:100%;background:var(--surface-2);display:flex;align-items:center;justify-content:center"><svg class="track-icon-filled" style="width:56px;height:56px;opacity:0.4" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-12.5c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg></div>`;
                            el.innerHTML = `<div class="card-img-container">${imgHTML}</div><div class="card-info"><div class="card-text card-title">${key}</div><div class="card-text card-sub">${groups[key].length} Songs</div></div><div class="card-more" onclick="event.stopPropagation(); app.ctxGroup('${key}')"><svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></div>`;
                            if(imgSrc) { const imgEl = el.querySelector('img'); getDominantColor(imgEl, (bgCol, textCol) => { el.style.background = bgCol; el.querySelector('.card-title').style.color = textCol; el.querySelector('.card-sub').style.color = textCol; }); }
                            el.onclick = () => ui.openGroup(key, groups[key]); g.appendChild(el);
                        });
                        const shufEl = document.createElement('div'); shufEl.className = 'card shuffle-card';
                        shufEl.innerHTML = `<svg viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg><div style="font-weight:700; font-size:14px; letter-spacing:0.5px">SHUFFLE ALL</div>`;
                        shufEl.onclick = () => { player.playShuffle(state.tracks); ui.closeModals(); };
                        g.appendChild(shufEl); c.appendChild(g);
                    }
                }
            },
            row: (t, ctx) => {
                const el = document.createElement('div'); el.className='track-row';
                el.innerHTML = `<div class="t-art">${ui.getArt(t)}</div><div class="t-data"><div class="t-title">${t.name}</div><div class="t-meta">${t.artist}</div></div><div class="more-btn" onclick="event.stopPropagation(); app.ctxTrack('${t.id}')"><svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></div>`;
                el.onclick = () => player.playQueue(ctx, ctx.indexOf(t));
                return el;
            },
            getArt: (t) => {
                if(state.images[t.folder]) return `<img src="${URL.createObjectURL(state.images[t.folder])}">`;
                return `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--surface-2);"><svg class="track-icon-filled" viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg></div>`;
            },
            update: () => {
                const t = player.curr; if(!t) return;
                ['mpTitle','fpTitle'].forEach(i=>document.getElementById(i).textContent=t.name);
                ['mpArtist','fpArtist'].forEach(i=>document.getElementById(i).textContent=t.artist);
                const src = state.images[t.folder] ? URL.createObjectURL(state.images[t.folder]) : null;
                
                // Do not update fpArt/fpPlaceholder visibility here if visualization is active (default)
                // We leave that to viz.toggle logic, or simply ensure viz is top layer if active
                
                const mpArt = document.getElementById('mpArt');
                if(src) { mpArt.src=src; mpArt.style.display='block'; } else mpArt.style.display='none';
                
                state.miniVizActive = !src;
                document.getElementById('mpVizCanvas').style.display = state.miniVizActive ? 'block' : 'none';
                
                const mpI = state.playing ? '<path d="M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/>' : '<path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/>';
                const fpI = state.playing ? '<path d="M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/>' : '<path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/>';
                document.getElementById('mpBtn').innerHTML=`<svg class="mp-icon-filled" viewBox="0 0 24 24">${mpI}</svg>`;
                document.getElementById('fpPlayBtn').innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor" stroke="none">${fpI}</svg>`;
                if ('mediaSession' in navigator) navigator.mediaSession.playbackState = state.playing ? "playing" : "paused";
            }
        };

        const app = {
             // ... keep app object same as before ...
            syncLibrary: () => { if (window.Capacitor) nativeScan(); else triggerFolder(); },
            saveSettings: () => {
                const s = { theme: document.body.getAttribute('data-theme'), shuffle: state.shuffle, repeat: state.repeat, viewMode: state.viewMode, sortMode: state.sortMode, currentFolder: state.currentFolder };
                localStorage.setItem('naadSettings', JSON.stringify(s));
            },
            toggleTheme: () => { const b = document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')==='light'?'dark':'light'); updateStatusBarColor(); app.saveSettings(); },
            toggleView: () => { state.viewMode = state.viewMode === 'grid' ? 'list' : 'grid'; app.saveSettings(); ui.updateViewBtn(); ui.render(); },
            showSortMenu: () => {
                const div = document.getElementById('sortOptions');
                let html = ''; const activeStyle = 'style="color:var(--active-color); font-weight:700"';
                if (state.tab === 'tracks' || state.viewGroup) {
                    html += `<button class="list-opt" onclick="app.sortTracks('id')" ${state.sortMode==='id'?activeStyle:''}>Track ID</button><button class="list-opt" onclick="app.sortTracks('name')" ${state.sortMode==='name'?activeStyle:''}>Name</button><button class="list-opt" onclick="app.sortTracks('date')" ${state.sortMode==='date'?activeStyle:''}>Release Date</button><button class="list-opt" onclick="app.sortTracks('size')" ${state.sortMode==='size'?activeStyle:''}>Size</button><button class="list-opt" onclick="app.sortTracks('artist')" ${state.sortMode==='artist'?activeStyle:''}>Artist</button>`;
                } else if (state.tab === 'folders') {
                    html += `<button class="list-opt" onclick="app.sortTracks('name')" ${state.sortMode==='name'?activeStyle:''}>Name</button><button class="list-opt" onclick="app.sortTracks('date')" ${state.sortMode==='date'?activeStyle:''}>Release Date</button><button class="list-opt" onclick="app.sortTracks('count')" ${state.sortMode==='count'?activeStyle:''}>Item Count</button><button class="list-opt" onclick="app.sortTracks('artist')" ${state.sortMode==='artist'?activeStyle:''}>Artist</button><button class="list-opt" onclick="app.sortTracks('size')" ${state.sortMode==='size'?activeStyle:''}>Size</button>`;
                } else {
                    html += `<button class="list-opt" onclick="app.sortTracks('name')" ${state.sortMode==='name'?activeStyle:''}>Name (A-Z)</button><button class="list-opt" onclick="app.sortTracks('count')" ${state.sortMode==='count'?activeStyle:''}>Item Count (High-Low)</button>`;
                }
                div.innerHTML = html; document.getElementById('sortModal').classList.add('open');
            },
            sortTracks: (mode) => {
                state.sortMode = mode;
                if(state.tab === 'tracks' || state.viewGroup) {
                    if(mode === 'name') state.tracks.sort((a,b) => a.name.localeCompare(b.name));
                    else if(mode === 'date') state.tracks.sort((a,b) => b.added - a.added);
                    else if(mode === 'artist') state.tracks.sort((a,b) => (a.artist||'').localeCompare(b.artist||''));
                    else if(mode === 'id') state.tracks.sort((a,b) => a.id.localeCompare(b.id));
                    else if(mode === 'size') state.tracks.sort((a,b) => getTrackSize(b) - getTrackSize(a));
                } 
                app.saveSettings(); ui.render(); ui.closeModals();
            },
            ctxTrack: (id) => {
                const t = state.tracks.find(x=>x.id===id);
                document.getElementById('ctxContent').innerHTML = `<div class="list-opt" onclick="player.playQueue([state.tracks.find(x=>x.id='${id}')], 0); ui.closeModals()"><svg class="ctx-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Play Now</div><div class="list-opt" onclick="player.addOne('${id}'); ui.closeModals()"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>Add to Queue</div><div class="list-opt" onclick="app.edit('${id}')"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit Details</div><div class="list-opt danger" onclick="app.del('${id}')"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</div>`;
                document.getElementById('ctxTitle').textContent = t.name; document.getElementById('contextMenu').classList.add('open');
            },
            ctxGroup: (name) => {
                 document.getElementById('ctxTitle').textContent = name;
                 document.getElementById('ctxContent').innerHTML = `<div class="list-opt" onclick="ui.closeModals(); ui.openGroup('${name}', state.tracks.filter(t=>(t.album==='${name}'||t.artist==='${name}'||t.folder==='${name}')))"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>Open</div><div class="list-opt" onclick="ui.closeModals(); player.playQueue(state.tracks.filter(t=>(t.album==='${name}'||t.artist==='${name}'||t.folder==='${name}')), 0)"><svg class="ctx-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Play All</div><div class="list-opt" onclick="ui.closeModals(); player.playShuffle(state.tracks.filter(t=>(t.album==='${name}'||t.artist==='${name}'||t.folder==='${name}')))"><svg class="ctx-icon" style="fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>Shuffle</div><div class="list-opt danger" onclick="app.removeGroup('${name}')"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Remove</div>`;
                 document.getElementById('contextMenu').classList.add('open');
            },
            edit: (id) => { ui.closeModals(); const t = state.tracks.find(x=>x.id===id); document.getElementById('editId').value = id; document.getElementById('editTitle').value = t.name; document.getElementById('editArtist').value = t.artist; document.getElementById('editAlbum').value = t.album; document.getElementById('editModal').classList.add('open'); },
            saveEdit: async () => { const id = document.getElementById('editId').value; const t = state.tracks.find(x=>x.id===id); t.name = document.getElementById('editTitle').value; t.artist = document.getElementById('editArtist').value; t.album = document.getElementById('editAlbum').value; await put(STORE_TRACKS, t); ui.closeModals(); ui.render(); ui.update(); },
            del: async (id) => { if(confirm('Delete?')) { state.tracks = state.tracks.filter(t=>t.id!==id); ui.closeModals(); ui.render(); } },
            removeGroup: async (name) => { if(confirm(`Remove all tracks in "${name}" from library?`)) { const toRemove = state.tracks.filter(t => t.album === name || t.artist === name || t.folder === name); if (toRemove.length > 0) { state.tracks = state.tracks.filter(t => !toRemove.includes(t)); const tx = db.transaction(STORE_TRACKS, 'readwrite'); toRemove.forEach(t => tx.objectStore(STORE_TRACKS).delete(t.id)); } ui.closeModals(); ui.render(); } },
            reset: () => { if(confirm("Clear All?")) { indexedDB.deleteDatabase(DB_NAME); location.reload(); } },
            openSearch: () => { document.getElementById('searchInput').value = ''; document.getElementById('searchResults').innerHTML = ''; document.getElementById('searchModal').classList.add('open'); setTimeout(() => document.getElementById('searchInput').focus(), 100); },
            performSearch: (q) => {
                const c = document.getElementById('searchResults'); c.innerHTML=''; if(!q) return;
                const res = state.tracks.filter(t => t.name.toLowerCase().includes(q.toLowerCase()) || (t.artist&&t.artist.toLowerCase().includes(q.toLowerCase())) || (t.album&&t.album.toLowerCase().includes(q.toLowerCase()))).slice(0, 50);
                res.forEach(t => { const el = document.createElement('div'); el.className='track-row'; el.style.borderBottom='1px solid var(--border)'; el.innerHTML = `<div class="t-art" style="width:40px;height:40px;">${ui.getArt(t)}</div><div class="t-data"><div class="t-title" style="font-size:14px;">${t.name}</div><div class="t-meta">${t.artist}</div></div>`; el.onclick = () => { ui.closeModals(); player.playQueue([t], 0); }; c.appendChild(el); });
                if(res.length===0) c.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sub); font-size:12px;">No results found</div>';
            }
        };

        const audio = new Audio();
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }

        const player = {
            curr: null,
            playQueue: (list, idx) => { state.queue=[...list]; state.qIdx=idx; if(state.shuffle) player.shuffleQ(); player.load(); },
            playShuffle: (list) => { state.shuffle = true; document.getElementById('btnShuf').classList.add('active'); app.saveSettings(); let shuffList = [...list]; shuffleArray(shuffList); player.playQueue(shuffList, 0); },
            addOne: (id) => { const t = state.tracks.find(x=>x.id===id); state.queue.push(t); if(state.queue.length===1) player.playQueue([t], 0); },
            removeOne: (idx) => { state.queue.splice(idx, 1); if(idx < state.qIdx) state.qIdx--; if(idx === state.qIdx) player.load(); player.renderQueue(); },
            load: () => {
                if(state.queue.length === 0) return;
                if(state.qIdx >= state.queue.length) state.qIdx = 0; 
                const t = state.queue[state.qIdx]; player.curr = t; 
                if (t.url) audio.src = t.url; else audio.src=URL.createObjectURL(t.blob); 
                audio.play(); state.playing=true; ui.update(); player.updateSession(); 
                document.getElementById('miniPlayer').classList.add('visible');
                viz.start(); player.renderQueue();
            },
            toggle: () => { if(audio.paused) { audio.play(); state.playing=true; } else { audio.pause(); state.playing=false; } ui.update(); },
            next: () => { let n=state.qIdx+1; if(n>=state.queue.length)n=0; state.qIdx=n; player.load(); },
            prev: () => { let n=state.qIdx-1; if(n<0)n=state.queue.length-1; state.qIdx=n; player.load(); },
            toggleShuffle: () => { state.shuffle=!state.shuffle; document.getElementById('btnShuf').classList.toggle('active',state.shuffle); app.saveSettings(); if(state.shuffle) player.shuffleQ(); },
            shuffleQ: () => { if(state.queue.length <= 1) return; const current = state.queue[state.qIdx]; let others = state.queue.filter((_, i) => i !== state.qIdx); shuffleArray(others); state.queue = [current, ...others]; state.qIdx = 0; player.renderQueue(); },
            toggleRepeat: () => { state.repeat=(state.repeat+1)%3; document.getElementById('btnRep').classList.toggle('active', state.repeat>0); app.saveSettings(); },
            toggleQueue: () => { const q = document.getElementById('queueSheet'); q.classList.toggle('open'); if(q.classList.contains('open')) player.renderQueue(); },
            renderQueue: () => {
                const c = document.getElementById('qList'); c.innerHTML='';
                state.queue.forEach((t, i) => {
                    const d = document.createElement('div'); d.className = `q-item ${i===state.qIdx ? 'active' : ''}`;
                    d.innerHTML = `<div class="q-icon"><svg viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg></div><div style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${t.name} <span style="font-size:12px;opacity:0.6">${t.artist}</span></div><div class="q-remove" onclick="player.removeOne(${i})"><svg style="width:18px;height:18px"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></div>`;
                    d.onclick = (e) => { if(!e.target.closest('.q-remove')) { state.qIdx=i; player.load(); } }; c.appendChild(d);
                });
                const active = c.children[state.qIdx]; if(active) setTimeout(() => active.scrollIntoView({block: 'start', behavior: 'smooth'}), 10);
            },
            setupSession: () => { if ('mediaSession' in navigator) { navigator.mediaSession.setActionHandler('play', () => player.toggle()); navigator.mediaSession.setActionHandler('pause', () => player.toggle()); navigator.mediaSession.setActionHandler('previoustrack', () => player.prev()); navigator.mediaSession.setActionHandler('nexttrack', () => player.next()); navigator.mediaSession.setActionHandler('seekto', (details) => { if (details.fastSeek && 'fastSeek' in audio) audio.fastSeek(details.seekTime); else audio.currentTime = details.seekTime; }); } },
            updateSession: () => { if ('mediaSession' in navigator && player.curr) { const t = player.curr; let artwork = []; if (state.images[t.folder]) { const blobUrl = URL.createObjectURL(state.images[t.folder]); artwork = [ { src: blobUrl, sizes: '96x96', type: 'image/png' }, { src: blobUrl, sizes: '128x128', type: 'image/png' }, { src: blobUrl, sizes: '192x192', type: 'image/png' }, { src: blobUrl, sizes: '256x256', type: 'image/png' }, { src: blobUrl, sizes: '384x384', type: 'image/png' }, { src: blobUrl, sizes: '512x512', type: 'image/png' }, ]; } navigator.mediaSession.metadata = new MediaMetadata({ title: t.name, artist: t.artist || 'Unknown Artist', album: t.album || 'Unknown Album', artwork: artwork }); } }
        };
        
        audio.ontimeupdate = () => { const pct = (audio.currentTime/audio.duration)*100||0; document.getElementById('fpFill').style.width=pct+'%'; document.getElementById('mpFill').style.width=pct+'%'; document.getElementById('tCurr').innerText = fmt(audio.currentTime); document.getElementById('tDur').innerText = fmt(audio.duration||0); };
        audio.onended = () => { if (state.repeat === 2) { audio.currentTime = 0; audio.play(); } else if (state.qIdx < state.queue.length - 1) { player.next(); } else { if (state.repeat === 1) { player.next(); } else { state.playing = false; ui.update(); } } };
        document.getElementById('scrubber').onclick = e => { const r=e.currentTarget.getBoundingClientRect(); audio.currentTime=((e.clientX-r.left)/r.width)*audio.duration; };
        function fmt(s){const m=Math.floor(s/60),sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`;}

        const viz = {
            ctx: null, an: null, src: null, cvs: null, cCtx: null, id: null,
            mpCvs: null, mpCtx: null,
            particles: [],
            lastBass: 0,
            
            setup: () => { 
                state.visMode = 2; // Default to Speaker
                viz.cvs = document.getElementById('vizCanvas'); 
                viz.cCtx = viz.cvs.getContext('2d');
                
                viz.cvs.style.display = 'block';
                document.getElementById('fpArt').style.opacity = '0';
                document.getElementById('fpPlaceholder').style.opacity = '0';
                
                viz.mpCvs = document.getElementById('mpVizCanvas');
                viz.mpCtx = viz.mpCvs.getContext('2d');
                
                for(let i=0; i<30; i++) {
                    viz.particles.push({
                        x: Math.random(), y: Math.random(),
                        dx: (Math.random()-0.5)*0.005, dy: (Math.random()-0.5)*0.005,
                        r: Math.random()*2 + 1
                    });
                }
            },

            toggle: () => {
                // Check if the current track has album art in the database
                const hasArt = player.curr && state.images[player.curr.folder];

                if (hasArt) {
                    // Art exists: Cycle 0(Off/Art) -> 1(Orb) -> 2(Speaker) -> 0
                    state.visMode = (state.visMode + 1) % 3;
                } else {
                    // No Art: Cycle 1(Orb) <-> 2(Speaker) only. Ensure we skip 0 (Off/Placeholder).
                    state.visMode = state.visMode === 1 ? 2 : 1;
                }

                const c = document.getElementById('vizCanvas'); 
                const i = document.getElementById('fpArt');
                const p = document.getElementById('fpPlaceholder');

                if(state.visMode > 0) { 
                    c.style.display='block'; 
                    i.style.opacity='0'; 
                    p.style.opacity='0'; 
                    viz.start(); 
                } else { 
                    c.style.display='none'; 
                    i.style.opacity='1'; 
                    p.style.opacity='1'; 
                    viz.stop(); 
                }
            },
            
            start: () => {
                if(!viz.ctx) {
                    const AC = window.AudioContext||window.webkitAudioContext;
                    viz.ctx = new AC(); viz.an=viz.ctx.createAnalyser(); viz.an.fftSize=256;
                    try { viz.src=viz.ctx.createMediaElementSource(audio); viz.src.connect(viz.an); viz.an.connect(viz.ctx.destination); } catch(e) {}
                }
                if(state.visMode > 0 || document.getElementById('miniPlayer').classList.contains('visible')) viz.loop();
            },
            stop: () => cancelAnimationFrame(viz.id),
            loop: () => {
                // ... (rest of loop logic remains exactly the same as your original file)
                viz.id = requestAnimationFrame(viz.loop);
                if(!viz.an) return;
                const buf = new Uint8Array(viz.an.frequencyBinCount); viz.an.getByteFrequencyData(buf);
                let bass = 0; for(let i=0; i<10; i++) bass += buf[i]; bass /= 10;
                let treble = 0; for(let i=100; i<150; i++) treble += buf[i]; treble /= 50;
                
                viz.lastBass += (bass - viz.lastBass) * 0.1;
                const smoothBass = viz.lastBass;

                const hue = (performance.now() * 0.01) % 360;
                const mpBg = document.getElementById('mpBg');
                mpBg.style.opacity = 0.1 + (bass/255)*0.4;
                mpBg.style.background = `linear-gradient(135deg, hsla(${hue},60%,50%,0.5), transparent)`;

                if(state.visMode > 0) {
                    const w = viz.cvs.width = viz.cvs.offsetWidth; const h = viz.cvs.height = viz.cvs.offsetHeight;
                    const cx = w / 2, cy = h / 2;
                    const ctx = viz.cCtx;
                    
                    if (state.visMode === 1) {
                        const g = ctx.createRadialGradient(cx, cy, 10, cx, cy, w);
                        const bgL = 5 + (bass/255)*10;
                        g.addColorStop(0, `hsla(${hue}, 50%, ${20+bgL}%, 1)`);
                        g.addColorStop(1, `hsla(${hue+40}, 60%, 5%, 1)`);
                        ctx.fillStyle = g; ctx.fillRect(0, 0, w, h);

                        if(treble > 40) {
                            ctx.fillStyle = '#FFF';
                            for(let i=0; i<4; i++) {
                                const ang = Math.random() * Math.PI * 2;
                                const dist = (100 + (bass*0.6)) + Math.random() * 60;
                                const pSize = Math.random() * 3;
                                ctx.fillRect(cx+Math.cos(ang)*dist, cy+Math.sin(ang)*dist, pSize, pSize);
                            }
                        }

                        const scale = 1 + (bass / 255) * 0.7;
                        ctx.save(); ctx.translate(cx, cy); ctx.scale(scale, scale);
                        ctx.font = 'bold 90px "Tiro Devanagari Hindi"';
                        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        if (bass > 190) {
                            ctx.globalCompositeOperation = 'screen';
                            ctx.fillStyle = '#FF0055'; ctx.fillText('नाद', -6, 0);
                            ctx.fillStyle = '#00CCFF'; ctx.fillText('नाद', 6, 0);
                            ctx.globalCompositeOperation = 'source-over';
                        }
                        ctx.shadowBlur = 30 + (bass/255)*50;
                        ctx.shadowColor = `hsla(${hue}, 90%, 60%, 0.9)`;
                        ctx.fillStyle = '#FFFFFF'; ctx.fillText('नाद', 0, 0);
                        ctx.restore();
                    }
                    
                    if (state.visMode === 2) {
                        const bgGrad = ctx.createRadialGradient(cx, cy, w*0.2, cx, cy, w);
                        bgGrad.addColorStop(0, '#1a1a1a');
                        bgGrad.addColorStop(1, '#050505');
                        ctx.fillStyle = bgGrad;
                        ctx.fillRect(0, 0, w, h);

                        const pump = (bass / 255) * 30; 
                        const baseR = Math.min(w, h) * 0.42;

                        ctx.beginPath();
                        ctx.arc(cx, cy, baseR + 10, 0, Math.PI * 2);
                        const rimGrad = ctx.createLinearGradient(cx - baseR, cy - baseR, cx + baseR, cy + baseR);
                        rimGrad.addColorStop(0, '#444');
                        rimGrad.addColorStop(0.5, '#222');
                        rimGrad.addColorStop(1, '#444');
                        ctx.fillStyle = rimGrad;
                        ctx.fill();

                        ctx.beginPath();
                        ctx.arc(cx, cy, baseR, 0, Math.PI * 2);
                        const surroundGrad = ctx.createRadialGradient(cx, cy, baseR * 0.85, cx, cy, baseR);
                        surroundGrad.addColorStop(0.5, '#111');
                        surroundGrad.addColorStop(0.75, '#333'); 
                        surroundGrad.addColorStop(1, '#000');
                        ctx.fillStyle = surroundGrad;
                        ctx.fill();

                        const coneR = baseR * 0.85 + (pump * 0.1); 
                        ctx.beginPath();
                        ctx.arc(cx, cy, coneR, 0, Math.PI * 2);
                        const coneGrad = ctx.createRadialGradient(cx, cy, coneR * 0.2, cx, cy, coneR);
                        coneGrad.addColorStop(0, '#222'); 
                        coneGrad.addColorStop(1, '#111'); 
                        ctx.fillStyle = coneGrad;
                        ctx.fill();

                        const capR = baseR * 0.35 + (pump * 0.8); 
                        ctx.beginPath();
                        ctx.arc(cx, cy, capR, 0, Math.PI * 2);
                        const capGrad = ctx.createRadialGradient(cx - capR*0.3, cy - capR*0.3, capR*0.1, cx, cy, capR);
                        capGrad.addColorStop(0, '#444'); 
                        capGrad.addColorStop(0.4, '#1a1a1a');
                        capGrad.addColorStop(1, '#000');
                        ctx.fillStyle = capGrad;
                        ctx.fill();

                        ctx.save();
                        ctx.translate(cx, cy);
                        const txtScale = 1 + (bass/255) * 0.15;
                        ctx.scale(txtScale, txtScale);
                        ctx.font = 'bold 16px "Tiro Devanagari Hindi"';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';

                        ctx.shadowBlur = 2;
                        ctx.shadowColor = 'rgba(0,0,0,0.8)';
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        ctx.fillStyle = '#B8860B'; 
                        ctx.fillText('नाद', 0, 2);

                        ctx.shadowColor = 'transparent';
                        ctx.shadowOffsetX = 0;
                        ctx.shadowOffsetY = 0;
                        ctx.fillStyle = '#FFD700'; 
                        ctx.fillText('नाद', 0, 2);

                        ctx.shadowBlur = 1;
                        ctx.shadowColor = 'rgba(255,255,255,0.4)';
                        ctx.shadowOffsetX = -1;
                        ctx.shadowOffsetY = -1;
                        ctx.fillStyle = 'rgba(255,255,224,0.1)'; 
                        ctx.fillText('नाद', 0, 2);

                        ctx.restore();

                        if (bass > 200) {
                            ctx.beginPath();
                            ctx.arc(cx, cy, baseR + 20 + (Math.random()*10), 0, Math.PI*2);
                            ctx.strokeStyle = `rgba(255, 255, 255, ${Math.random() * 0.1})`;
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        }
                    }
                }
                
                if (state.miniVizActive) {
                    const mw = viz.mpCvs.width = viz.mpCvs.offsetWidth;
                    const mh = viz.mpCvs.height = viz.mpCvs.offsetHeight;
                    const mCtx = viz.mpCtx;
                    const surfaceColor = getComputedStyle(document.body).getPropertyValue('--surface');
                    mCtx.fillStyle = surfaceColor; mCtx.fillRect(0,0,mw,mh);
                    mCtx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`; 
                    viz.particles.forEach(p => {
                        p.x += p.dx * (1 + smoothBass/50); p.y += p.dy * (1 + smoothBass/50);
                        if(p.x < 0) p.x = 1; if(p.x > 1) p.x = 0; if(p.y < 0) p.y = 1; if(p.y > 1) p.y = 0;
                        mCtx.beginPath(); mCtx.arc(p.x * mw, p.y * mh, p.r, 0, Math.PI*2); mCtx.fill();
                    });
                    const mcx = mw / 2, mcy = mh / 2;
                    mCtx.save(); mCtx.translate(mcx, mcy);
                    const textScale = 1 + (smoothBass / 255) * 0.2; 
                    mCtx.scale(textScale, textScale);
                    mCtx.font = 'bold 10px "Asap", sans-serif'; 
                    mCtx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-main');
                    mCtx.textAlign = 'center'; mCtx.textBaseline = 'middle';
                    const glowIntensity = (smoothBass / 255);
                    mCtx.shadowBlur = 5 + glowIntensity * 15;
                    mCtx.shadowColor = `hsla(${hue}, 80%, 60%, ${0.5 + glowIntensity * 0.5})`;
                    mCtx.fillText('नाद', 0, 2); mCtx.restore();
                }
            }
        };

        function openDB() { return new Promise(r => { const q=indexedDB.open(DB_NAME,1); q.onupgradeneeded=e=>{const d=e.target.result; if(!d.objectStoreNames.contains(STORE_TRACKS))d.createObjectStore(STORE_TRACKS,{keyPath:'id'}); if(!d.objectStoreNames.contains(STORE_IMAGES))d.createObjectStore(STORE_IMAGES,{keyPath:'path'});}; q.onsuccess=()=>r(q.result); }); }
        function put(st,v) { return new Promise(r=>{const tx=db.transaction(st,'readwrite');tx.objectStore(st).put(v);tx.oncomplete=r;}); }
        function getAll(st) { return new Promise(r=>{const tx=db.transaction(st,'readonly');tx.objectStore(st).getAll().onsuccess=e=>r(e.target.result);}); }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.Capacitor) {
                init();
            } else {
                let checks = 0;
                const i = setInterval(() => {
                    if (window.Capacitor) { clearInterval(i); init(); } else if (checks > 10) { clearInterval(i); init(); }
                    checks++;
                }, 100);
            }
        });
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg => console.log('Service Worker registered!', reg)).catch(err => console.log('Service Worker registration failed: ', err)); }); }
    </script>
</body>
</html>