<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="screen-orientation" content="portrait">
    <meta name="orientation" content="portrait">
    <meta name="theme-color" content="#F3F4F6" id="themeColorMeta">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="google" content="notranslate">
    
    <title>Naad Music Player</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <style>
        /* --- LOCAL FONTS SETUP --- */
        @font-face { font-family: 'Asap'; src: url('Asap-Light.otf') format('opentype'); font-weight: 300; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Asap'; src: url('Asap-Regular.otf') format('opentype'); font-weight: 400; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Asap'; src: url('Asap-Medium.otf') format('opentype'); font-weight: 500; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Asap'; src: url('Asap-SemiBold.otf') format('opentype'); font-weight: 600; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Asap'; src: url('Asap-Bold.otf') format('opentype'); font-weight: 700; font-style: normal; font-display: swap; }
        @font-face { font-family: 'Tiro Devanagari Hindi'; src: url('TiroDevanagariHindi-Regular.ttf') format('truetype'); font-weight: 400; font-display: swap; }

        :root {
            /* --- THEME: VIOLET STORM --- */
            --bg-body: #F3F4F6;
            --surface: #FFFFFF;
            --surface-2: #E5E7EB;
            
            --text-main: #111827;
            --text-sub: #6B7280;
            --accent: #111827;
            --accent-text: #FFFFFF;
            
            --active-color: #7C3AED; 
            --active-bg-tint: rgba(124, 58, 237, 0.35);
            --search-bg-tint: rgba(255,255,255,0.25);
            --search-bg-tint: rgba(255, 255, 255, 0.65);
            
            --border: #E5E7EB;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            --shadow-float: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --safe-top: max(env(safe-area-inset-top), 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            
            --anim: cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-body: #09090b;
            --surface: #18181b;
            --surface-2: #27272a;
            --text-main: #fafafa;
            --text-sub: #a1a1aa;
            --accent: #fafafa;
            --accent-text: #09090b;
            --border: #27272a;
            
            --active-color: #8B5CF6; 
            --active-bg-tint: rgba(139, 92, 246, 0.2);
            --search-bg-tint: rgba(31, 31, 31, 0.2);
            --search-bg-tint: rgba(255, 255, 255, 0.12);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; touch-action: pan-y; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Asap', sans-serif;
            background-color: var(--bg-body); 
            background-image: radial-gradient(circle at 50% -10%, var(--active-bg-tint), transparent 90%);
            background-attachment: fixed;
            color: var(--text-main);
            height: 100dvh; overflow: hidden;
            display: flex; flex-direction: column;
            transition: background-color 0.3s, color 0.3s;
            overscroll-behavior-y: none;
        }

        svg { width: 24px; height: 24px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        svg.solid { fill: currentColor; stroke: none; }
        .icon-dots { fill: currentColor; stroke: none; }

        .icon-std {
            width: 20px; height: 20px;
            fill: none; stroke: currentColor; 
            stroke-width: 2; stroke-linecap: round; stroke-linejoin: round;
            display: block; 
        }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--surface-2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-sub); }

        .btn {
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-weight: 600; transition: transform 0.1s; border-radius: 12px;
        }
        .btn:active { transform: scale(0.94); }
        
        .btn-icon {
            width: 44px; height: 44px; background: var(--surface); color: var(--text-main);
            box-shadow: var(--shadow-card); flex-shrink: 0;
        }
        
        .btn-solid {
            background: var(--active-color); color: #fff;
            padding: 12px 24px; border-radius: 30px;
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }

        header {
            height: calc(54px + var(--safe-top) + 8px); 
            padding-top: calc(var(--safe-top) + 8px);
            display: flex; align-items: center; justify-content: space-between;
            padding-inline: 20px; z-index: 50; 
            padding-bottom: 12px;
            background: transparent; 
            flex-shrink: 0;
        }
        header .btn-icon { background: transparent; box-shadow: none; }
        header #btnHeadSearch {
            width: auto !important;           /* Allow button to expand */
            padding-right: 16px !important;   /* Add space on the right */
            padding-left: 16px !important;
            gap: 8px;                         /* Space between icon and text */
            height: 34px;
            /* Different subtle look: Surface color + Border */
            background: var(--search-bg-tint) !important; 
            border: none;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            color: var(--text-main) !important; /* Subtle text color */
            box-shadow: none;
        }
        
        .header-actions .btn-icon {
            width: 38px; height: 38px;
            margin: 0;
            display: flex; align-items: center; justify-content: center;
        }

        .logo-btn {
            font-family: 'Tiro Devanagari Hindi', serif; 
            font-size: 31px; 
            font-weight: 700; 
            color: var(--active-color); 
            background: transparent; border: none; 
            padding: 0; padding-left: 10px; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex; align-items: center;
            height: 100%;
        }
        .logo-text { position: relative; z-index: 1; display:flex; align-items:center; }
        .app-title { flex: 1; }
        
        .header-actions {
            display: flex; align-items: center; gap: 10px; height: 100%;
        }

        #appView {
            flex: 1; overflow: hidden; display: flex; flex-direction: column; padding-bottom: 0;
        }
        
        .container { 
            max-width: 800px; margin: 0 auto; width: 100%; 
            height: 100%; display: flex; flex-direction: column; 
        }
        /* Add these styles */
        .tab-view { display: none; width: 100%; height: auto; }
        .tab-view.active { display: block; }

        /* Ensure content container doesn't scroll, but the sub-views do if needed */
        #content { position: relative; display: flex; flex-direction: column; }

        .tabs-row {
            display: flex; gap: 0; padding: 4px; 
            margin: 10px 20px;
            background: transparent;
            border-radius: 16px;
            flex-shrink: 0;
            padding-bottom: 12px;
        }
        .tab {
            flex: 1;
            padding: 10px 0; border-radius: 12px;
            background: transparent; color: var(--text-sub);
            font-weight: 600; font-size: 13px; white-space: nowrap;
            cursor: pointer; transition: 0.2s; border: none;
            text-align: center;
            letter-spacing: 0.5px;
        }
        .tab.active {
            /* 1. Semi-transparent background using your theme variable */
            background: var(--active-bg-tint);
            
            /* 2. The Frost Effect (Blur content behind the tab) */
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            
            /* 3. Change text color to purple (Active Color) for contrast */
            color: white;
            
            /* 4. Glassy styling details
            border: 1px solid rgba(124, 58, 237, 0.15);*/
            box-shadow: 0 8px 24px -6px rgba(124, 58, 237, 0.25);
            text-shadow: none;
            
            /*background: linear-gradient(135deg, var(--active-color), #4C1D95);
            color: #FFFFFF;
            box-shadow: 0 4px 15px -3px rgba(124, 58, 237, 0.4);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            border: none;*/
        }
        
        #content {
            flex: 1; overflow-y: auto; padding-bottom: 120px;
            scroll-behavior: smooth;
        }

        .track-list { display: flex; flex-direction: column; gap: 0; padding: 10px 20px; }
        
        .track-group-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 24px 8px 8px; margin-top: 10px;
            border-bottom: none; 
            margin-bottom: 8px;
        }
        .group-name { font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-sub); }
        .group-ctrls { display: flex; gap: 12px; flex-shrink: 0; }
        
        .group-btn { 
            background: transparent; border: none; 
            padding: 6px 14px; border-radius: 8px;
            color: var(--active-color); cursor: pointer; display: flex; align-items: center; 
            font-weight: 600; font-size: 12px;
            transition: 0.2s;
        }
        .group-btn:hover { opacity: 0.8; }
        .group-btn svg { width: 16px; height: 16px; margin-right: 4px; stroke-width: 2.5; }

        .track-row {
            display: flex; align-items: center; gap: 16px;
            padding: 12px 8px; background: transparent;
            transition: opacity 0.2s; cursor: pointer;
            border: none; border-bottom: 1px solid transparent;
        }
        .track-row:hover { opacity: 0.7; }
        .track-row:active { opacity: 0.5; }
        
        .t-art {
            width: 50px; height: 50px; border-radius: 10px; 
            /* Changed from var(--surface-2) to a specific dark gray */
            background: #27272a; 
            overflow: hidden; flex-shrink: 0; display: flex; align-items: center; justify-content: center;
        }
        .t-art img { width: 100%; height: 100%; object-fit: cover; }
        
        .t-data { flex: 1; min-width: 0; }
        .t-title { font-size: 16px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 4px; }
        .t-meta { font-size: 13px; color: var(--text-sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .more-btn {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            color: var(--text-sub); border-radius: 50%;
        }
        .more-btn:active { background: var(--surface-2); color: var(--text-main); }

        .track-icon-filled { width: 28px; height: 28px; fill: var(--text-sub); stroke: none; }

        /* --- UPDATED GRID & CARD STYLES --- */
    .grid {
        display: grid; 
        /* Match carousel width (approx 130px) */
        grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
        gap: 16px 12px; 
        padding: 20px;
    }
    .card {
        background: transparent; /* Removed card background */
        padding: 0; 
        border-radius: 0;
        text-align: left; /* Align text left like carousel */
        cursor: pointer; 
        position: relative;
        transition: transform 0.2s; 
        box-shadow: none; /* Removed card shadow */
        overflow: visible;
        display: flex; flex-direction: column;
        height: auto;
    }
    .card:active { transform: scale(0.96); }

    .card-img-container {
        width: 100%; 
        aspect-ratio: 1 / 1; 
        position: relative; overflow: hidden;
        display: flex; align-items: center; justify-content: center;
        border-radius: 18px; 
        box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
        /* Changed from var(--surface-2) to a specific dark gray */
        background: #27272a;
    }        
    .card-img {
        width: 100%; height: 100%; object-fit: cover;
        display: block;
        border-radius: 18px;
    }

    .card-info {
        padding: 8px 0 0 0; /* Remove internal padding, add top gap */
        flex-shrink: 0;
        display: flex; flex-direction: column; justify-content: flex-start;
        position: relative; z-index: 2;
    }

    .card-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-title { 
        font-weight: 600; font-size: 13px; /* Match Carousel font size */
        margin-bottom: 2px; color: var(--text-main);
        padding-left: 4px;
        padding-right: 4px;
        padding-top: 4px;
    }
    .card-sub { 
        font-size: 11px; /* Match Carousel sub size */
        font-weight: 500; color: var(--text-sub); opacity: 0.8; 
        padding-left: 4px;
        padding-right: 4px;
        padding-top: 4px;
    }

    .card-more {
        position: absolute; top: 6px; right: 6px; width: 28px; height: 28px;
        /* Updated from 0.3 to 0.1 for a very subtle dark tint */
        background: rgba(0, 0, 0, 0.1); 
        color: #fff; border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        z-index: 10;
        backdrop-filter: blur(4px);
    }
    .card-more svg { fill: currentColor; stroke: none; width: 18px; height: 18px; }

    /* Shuffle Card Specifics to match dimensions */
    .card.shuffle-card {
        background: transparent;
        display: flex; flex-direction: column; 
        align-items: flex-start; justify-content: flex-start;
    }
    .shuffle-card-inner {
        width: 100%; aspect-ratio: 1/1;
        border-radius: 18px;
        background: linear-gradient(135deg, #4C1D95, var(--active-color));
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
    }
        
        .track-row.shuffle-row { color: var(--active-color); }

        #miniPlayer {
            position: fixed; bottom: calc(20px + var(--safe-bottom)); left: 20px; right: 20px;
            height: 95px; 
            
            /* --- UPDATED: High Contrast & No Border --- */
            /* 1. Use a gradient to make it stand out from the flat page background */
            background: linear-gradient(145deg, var(--surface), var(--surface-2));
            
            /* 2. Remove the border */
            border: none; 
            
            /* 3. Increase shadow intensity to define edges without a border */
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25);
            /* ------------------------------------------ */

            border-radius: 20px; 
            /* removed var(--shadow-float) and border lines here */
            
            display: flex; align-items: center; padding: 0 20px; gap: 14px;
            transform: translateY(150%); transition: transform 0.4s var(--anim);
            z-index: 100; cursor: pointer; 
            overflow: hidden;
        }
        #miniPlayer.visible { transform: translateY(0); }
        
        #mpBg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--active-color); opacity: 0; pointer-events: none; z-index: 0;
            transition: opacity 0.1s;
        }

        .mp-img { width: 48px; height: 48px; border-radius: 12px; background: var(--surface-2); overflow: hidden; flex-shrink: 0; position: relative; z-index: 1; }
        .mp-img img { width: 100%; height: 100%; object-fit: cover; display: none; }
        .mp-img canvas { width: 100%; height: 100%; display: none; }
        
        .mp-data { flex: 1; min-width: 0; position: relative; z-index: 1; display: flex; flex-direction: column; justify-content: center; }
        .t-title#mpTitle { margin-bottom: 4px; }
        
        .mp-prog-track { width: 100%; height: 3px; background: rgba(0,0,0,0.05); margin-top: 6px; border-radius: 2px; overflow: hidden; }
        [data-theme="dark"] .mp-prog-track { background: rgba(255,255,255,0.1); }
        .mp-prog-fill { height: 100%; width: 0%; background: var(--active-color); border-radius: 2px; transition: width 0.1s linear; }

        .mp-btn {
            width: 44px; height: 44px; border-radius: 12px;
            background: var(--accent); color: var(--accent-text);
            display: flex; align-items: center; justify-content: center; border: none; flex-shrink: 0;
            position: relative; z-index: 1;
        }
        
        .mp-icon-filled { width: 24px; height: 24px; fill: currentColor; stroke: none; }

        #fullPlayer {
            position: fixed; inset: 0; z-index: 200;
            /*background: var(--bg-body);*/

            /* CHANGE THIS LINE */
            /* Creates a subtle glow from the top using your theme's active tint */
            background: radial-gradient(circle at 50% -20%, var(--active-bg-tint), transparent 90%), var(--bg-body) !important;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.4s var(--anim);
        }
        #fullPlayer.visible { transform: translateY(0); }

        .fp-head {
            height: calc(50px + var(--safe-top)); 
            padding: var(--safe-top) 24px 0;
            display: flex; align-items: center; justify-content: space-between;
        }
        .fp-head .btn-icon { background: transparent; box-shadow: none; }

        .fp-stage {
            flex: 1; display: flex; align-items: center; justify-content: center;
            flex-direction: column; position: relative;
        }
        .fp-art-frame {
            width: 82vw; height: 82vw; max-width: 330px; max-height: 330px;
            border-radius: 24px; 
            box-shadow: none;
            background: var(--surface-2); position: relative; overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            z-index: 50;
            display: flex; align-items: center; justify-content: center;

            /* Add this for Desktop/Tablet adjustments */
            @media (min-width: 768px) {
                .fp-art-frame {
                    /* Force smaller fixed size on larger screens */
                    width: 300px !important;
                    height: 300px !important;
                    max-width: 300px !important;
                    max-height: 300px !important;
                }
            }

        }
        .fp-art-frame:active { transform: scale(0.98); }
        .fp-art-frame img { width: 100%; height: 100%; object-fit: cover; pointer-events: none; transition: opacity 0.3s; position: absolute; inset:0; z-index:1; }
        .fp-placeholder { 
            position: absolute; inset: 0; display: none; 
            align-items: center; justify-content: center;
            z-index: 0;
        }
        .fp-viz {
            position: absolute; inset: 0; width: 100%; height: 100%;
            background: #000; display: none; z-index: 2;
        }

        .fp-controls { 
            padding: 30px 24px calc(50px + var(--safe-bottom)); 
            /*background: var(--bg-body);*/ 
            position: relative; 
            z-index: 20; 
        }
        .fp-meta { text-align: center; margin-bottom: 30px; }
        
        .fp-title { 
            font-size: 24px; font-weight: 500; margin-bottom: 12px;
            white-space: normal; line-height: 1.3; overflow: visible;
            cursor: pointer; /* Added */
        }
        .fp-title:active { opacity: 0.6; } /* Added click feedback */

        .fp-artist { 
            font-size: 16px; color: var(--text-main); font-weight: 300; 
            cursor: pointer; /* Added */
        }
        .fp-artist:active { opacity: 0.6; } /* Added click feedback */

        .bar-wrap { height: 44px; display: flex; align-items: center; cursor: pointer; touch-action: none; }
        .bar-bg { width: 100%; height: 6px; background: var(--surface-2); border-radius: 10px; overflow: hidden; }
        .bar-fill { height: 100%; width: 0%; background: var(--active-color); border-radius: 10px; }
        .time-row { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: var(--text-sub); margin-top: 4px; }

        .ctrl-row { 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            margin-top: 20px;
            max-width: 768px;
            margin-left: auto;
            margin-right: auto; 
        }
        .btn-ctrl { background: none; border: none; color: var(--text-main); padding: 10px; opacity: 0.7; transition: 0.2s; }
        .btn-ctrl.active { color: var(--active-color); opacity: 1; }
        .btn-play-lg {
            width: 72px; height: 72px; border-radius: 24px;
            background: var(--active-color); color: var(--accent-text);
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.4);
        }
        .btn-play-lg svg { width: 32px; height: 32px; fill: currentColor; stroke: none; }

        /* NEW: Backdrop styles */
        #queueBackdrop {
            position: absolute; inset: 0;
            background: rgba(0,0,0,0.4); /* Dims the player behind the queue */
            z-index: 55; /* Higher than Album Art (50) */
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
            backdrop-filter: blur(4px); /* Optional: adds a nice blur effect */
        }
        #queueBackdrop.open { opacity: 1; pointer-events: auto; }

        /* Now Playing Label & Animation */
        .np-tag {
            display: inline-block; 
            /* 1. INCREASED FONT SIZE (was 9px) */
            font-size: 11px; 
            font-weight: 700;
            background: var(--active-color); 
            color: #ffffff; 
            padding: 3px 8px; /* Slightly more padding for larger text */
            border-radius: 6px;
            
            /* 2. SPACING ADJUSTMENTS for the new layout */
            margin-left: 8px; 
            margin-right: 4px;
            
            vertical-align: middle;
            text-transform: uppercase; letter-spacing: 0.5px;
            animation: npPulse 1.5s infinite ease-in-out;
            
            /* Ensures the tag doesn't shrink if space is tight */
            flex-shrink: 0; 
        }
        
        @keyframes npPulse { 
            0% { opacity: 1; transform: scale(1); } 
            50% { opacity: 0.6; transform: scale(0.95); } 
            100% { opacity: 1; transform: scale(1); } 
        }

        .queue-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70%;
            background: var(--surface); border-radius: 30px 30px 0 0;
            transform: translateY(100%); transition: transform 0.3s var(--anim);
            z-index: 60; display: flex; flex-direction: column;
            box-shadow: 0 -10px 60px rgba(0,0,0,0.3);
        }
        .queue-sheet.open { transform: translateY(0); }
        .q-head {
            padding: 24px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: none;
        }
        .q-title { font-size: 18px; font-weight: 700; color: var(--text-main); }
        .q-list { flex: 1; overflow-y: auto; padding: 10px 20px; scroll-behavior: smooth; }
        .q-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 0; border-bottom: none;
        }
        .q-item.active { color: var(--active-color); font-weight: 600; }
        .q-remove { color: var(--text-sub); opacity: 0.5; padding: 8px; cursor: pointer; }
        .q-remove:hover { color: #EF4444; opacity: 1; }
        .q-icon { margin-right: 12px; display: flex; align-items: center; color: var(--text-sub); }
        .q-icon svg { width: 20px; height: 20px; fill: currentColor; stroke: none; }

        .backdrop {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 300;
            opacity: 0; pointer-events: none; transition: 0.2s;
            display: flex; align-items: center; justify-content: center; 
            backdrop-filter: blur(2px);
        }
        .backdrop.open { opacity: 1; pointer-events: auto; }
        
        .modal-box {
            width: 85%; max-width: 320px;
            height: auto;
            background: linear-gradient(160deg, var(--surface), var(--surface-2));
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 30px; /* Uniform padding top/bottom/sides */
            display: flex; flex-direction: column;
            gap: 12px;
            max-height: 80vh; 
            overflow-y: auto; /* Scroll bar inside container */
            position: relative;
            transform: scale(0.95); transition: 0.25s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .backdrop.open .modal-box { transform: scale(1); }

        #contextMenu .modal-box { max-width: 240px; } 
        .ctx-icon { width: 20px; height: 20px; fill: currentColor; stroke: none; margin-right: 12px; }

        .modal-header {
            text-align: center; margin-bottom: 8px;
            display: flex; flex-direction: column; align-items: center;
        }
        .modal-title {
            font-size: 14px; font-weight: 700; 
            text-transform: uppercase; letter-spacing: 1.5px; 
            color: var(--text-sub);
        }
        .brand-name {
            font-family: 'Tiro Devanagari Hindi', serif; font-size: 42px; 
            font-weight: 700; 
            color: var(--active-color); line-height: 0.8;
            margin-bottom: 2px; 
        }
        .brand-sub {
            font-family: 'Asap', sans-serif; font-size: 14px; letter-spacing: 0.5px; 
            font-weight: 600; color: var(--text-main); opacity: 0.8; 
            margin-top: 2px; 
        }

        .list-opt {
            background: transparent; color: var(--text-main);
            padding: 10px 12px; border-radius: 12px;
            font-size: 15px; font-weight: 600;
            cursor: pointer; transition: 0.1s; border: none;
            display: flex; align-items: center; justify-content: flex-start;

            /* CHANGED: This pushes the text to left and tick to right */
            justify-content: space-between;

            text-align: left;
            width: 100%;
        }
        .list-opt:active { background: var(--surface-2); transform: scale(0.98); }
        .list-opt.danger { color: #EF4444; }

        /* --- ADD THIS NEW RULE --- */
        /* This forces the Context Menu items to group to the left */
        #contextMenu .list-opt {
            justify-content: flex-start;
        }

        .setting-group { margin-bottom: 8px; }
        .setting-label { 
            display: flex; align-items: center; gap: 8px; 
            font-size: 11px; font-weight: 500; color: var(--text-sub); 
            margin-bottom: 10px; letter-spacing: 0.5px; 
        }
        .toggle-row { 
            display: flex; background: var(--surface-2); 
            padding: 4px; border-radius: 14px; gap: 4px; 
        }
        .toggle-btn {
            flex: 1; padding: 10px 0; 
            border: none; background: transparent; border-radius: 10px;
            font-size: 13px; font-weight: 600; font-family: inherit;
            cursor: pointer; color: var(--text-sub); transition: 0.2s;
        }
        body[data-theme="light"] #btnLight, body[data-theme="dark"] #btnDark { 
            background: var(--active-color); 
            color: #ffffff; 
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: none; 
            font-weight: 700;
        }
        
        .action-col { display: flex; flex-direction: column; gap: 8px; }
        .action-btn {
            background: var(--surface-2); color: var(--text-main);
            padding: 14px; border-radius: 14px;
            font-size: 14px; font-weight: 600; text-align: left; 
            display: flex; align-items: center; gap: 14px;
            border: none; cursor: pointer; transition: 0.1s;
        }
        .action-btn:active { transform: scale(0.98); background: var(--border); }
        .action-btn svg { fill: var(--active-color); stroke: none; width: 22px; height: 22px; }

        /* --- COMPACT SETTINGS STYLES --- */
        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 8px;
        }

        .action-btn.compact {
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 12px 8px;
            height: auto;
            gap: 6px;
            font-size: 13px;
        }

        .action-btn.compact svg {
            width: 24px; 
            height: 24px; 
            margin: 0; 
            margin-bottom: 2px;
        }

        .btn-sub {
            font-size: 10px; 
            opacity: 0.6; 
            font-weight: 500;
        }

        .menu-footer { 
            text-align: center; font-size: 12px; font-weight: 600; 
            color: var(--text-sub); opacity: 0.7; margin-top: 8px;
            padding-bottom: 0px; 
        }
        
        .flag {
            display: inline-block; 
            width: 24px; height: 16px;
            background-image: url('Flag_of_India.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            position: relative; vertical-align: middle; margin-left: 8px;
            box-shadow: none;
            border: 1px solid rgba(0,0,0,0.1); 
        }

        .input-group label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; }
        .input-field {
            width: 100%; padding: 14px; border-radius: 12px;
            background: var(--bg-body); border: 1px solid var(--border);
            color: var(--text-main); font-family: inherit; margin-bottom: 12px;
        }

        /* ADD THIS NEW RULE HERE */
        #searchInput {
            background: #ffffff !important;
            color: #000000 !important;
            border: 1px solid #e5e7eb;
        }

        .input-field:focus { border-color: var(--active-color); }

        #fileIn, #folderIn { display: none; }
        #colorCanvas { display: none; }
        
        .spinner {
            border: 4px solid var(--surface-2);
            border-top: 4px solid var(--active-color);
            border-radius: 50%; width: 40px; height: 40px;
            animation: spin 1s linear infinite; margin: 0 auto 10px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #searchResults { max-height: 250px; overflow-y: auto; display:flex; flex-direction:column; gap:4px; }
        #searchModal .modal-box { width: 90%; max-width: 380px; }

        /* --- UPDATE THESE STYLES --- */
        .home-header { 
            padding: 24px 20px 20px; 
            position: sticky;       /* 1. Makes it stick */
            top: 0;                 /* 2. Sticks to the very top of the scroll area */
            z-index: 40;            /* 3. Ensures it sits above the scrolling cards */
            background: transparent; 
            backdrop-filter: blur(2px); /* 4. Blurs content passing underneath (Glass effect) */
            -webkit-backdrop-filter: blur(2px); /* Safari support */
        }
        /* --- UPDATED: Search Bar with Gradient --- */
        .home-search-bar {
            /* Changed from solid color to a gradient for depth */
            background: linear-gradient(135deg, var(--surface), var(--surface-2)); 
            
            color: var(--text-sub);
            padding: 16px 20px;
            border-radius: 16px;
            display: flex; align-items: center; gap: 12px;
            font-size: 14px; font-weight: 600;
            
            /* Added border for better definition against the gradient background */
            border: 1px solid var(--border); 
            
            box-shadow: var(--shadow-card);
            cursor: text; transition: transform 0.2s, box-shadow 0.2s;
        }

        /* Optional: Slight lift effect on touch/click */
        .home-search-bar:active { 
            transform: scale(0.98); 
            opacity: 0.9;
        }
        
        .carousel-section { 
            display: flex; flex-direction: column; gap: 16px; 
            margin-bottom: 30px; 
            width: 100%; overflow: hidden; /* Prevent page-wide scroll */
        }
        .carousel-section:first-child {
            padding-top: 16px;
        }
        .carousel-head { 
            padding: 0 24px; display: flex; align-items: center; justify-content: space-between;
            font-size: 20px; font-weight: 700; color: var(--text-main); letter-spacing: 0.2px;
        }
        .carousel-scroll {
            display: flex; gap: 16px; 
            overflow-x: auto; 
            padding: 4px 20px 12px; 
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            
            /* Enable generic panning (both X and Y) so horizontal works 
               while vertical bubbling scrolls the page */
            touch-action: pan-x pan-y; 

            scrollbar-width: thin; 
            scrollbar-color: var(--surface-2) transparent;
        }

        /* CRITICAL FIX: Force all items INSIDE the carousel to allow horizontal touch */
        .carousel-scroll * {
            touch-action: pan-x pan-y;
        }

        /* UPDATED: Custom styled scrollbar for Webkit (Chrome/Safari) */
        .carousel-scroll::-webkit-scrollbar { 
            height: 6px; /* Visible height for mouse usage */
            display: block; 
        }
        .carousel-scroll::-webkit-scrollbar-track { 
            background: transparent; 
            margin: 0 20px; /* Align with container padding */
        }
        .carousel-scroll::-webkit-scrollbar-thumb { 
            background: var(--surface-2); 
            border-radius: 10px; 
        }
        .carousel-scroll::-webkit-scrollbar-thumb:hover { 
            background: var(--text-sub); 
        }

        /* MOBILE/ANDROID OVERRIDE: Hide scrollbars completely on touch devices */
        @media (max-width: 768px), (pointer: coarse) {
            * {
                scrollbar-width: none !important; /* Hide in Firefox Mobile */
                -ms-overflow-style: none !important; /* Hide in IE/Edge */
            }
            *::-webkit-scrollbar {
                display: none !important; /* Hide in Chrome/Safari/Android Webview */
                width: 0 !important;
                height: 0 !important;
                background: transparent !important;
            }
        }
        
        .c-card { 
            width: 130px; 
            flex-shrink: 0; /* CRITICAL: Prevents cards from squishing */
            display: flex; flex-direction: column; gap: 8px; 
            cursor: pointer;
        }
        .c-card:active { opacity: 0.7; }
        .c-art { 
            width: 130px; height: 130px; border-radius: 18px; 
            /* Changed from var(--surface-2) to a specific dark gray */
            background: #27272a; 
            overflow: hidden; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .c-art img { width: 100%; height: 100%; object-fit: cover; }
        .c-info { display: flex; flex-direction: column; gap: 2px; }
        .c-title { 
            font-size: 13px; font-weight: 600; color: var(--text-main); letter-spacing: 0.2px;
            padding-left: 4px;
            padding-right: 4px;
            padding-top: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        .c-sub { 
            font-size: 11px; font-weight: 500; color: var(--text-sub); letter-spacing: 0.2px;
            padding-left: 4px;
            padding-right: 4px;
            padding-top: 4px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; 
        }
        
        /* Modify existing container to allow scrolling for home elements */
        .container { max-width: 800px; margin: 0 auto; width: 100%; height: 100%; display: flex; flex-direction: column; }
    
    </style>
</head>
<body data-theme="light">
    
    <canvas id="colorCanvas" width="1" height="1"></canvas>

    <div class="backdrop" id="syncModal">
        <div class="modal-box" style="align-items:center; text-align:center;">
            <div class="spinner"></div>
            <div style="font-weight:700; color:var(--text-main);">Scanning Library</div>
            <div id="syncStatus" style="font-size:12px; color:var(--text-sub);">Finding music files</div>
        </div>
    </div>

    <div class="backdrop" id="permPopup">
        <div class="modal-box" style="text-align:center; align-items:center; gap:16px;">
            <div style="font-size:18px; font-weight:700; color:var(--text-main);">Permission Required</div>
            <div style="font-size:14px; color:var(--text-sub);">Please allow access to media files to play your music.</div>
            <button class="btn btn-solid" onclick="grantPerms()">Give Permission</button>
        </div>
    </div>
    
    <div class="backdrop" id="searchModal" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Search</div>
            </div>
            <input type="text" class="input-field" id="searchInput" placeholder="Search songs, albums, artists..." oninput="app.performSearch(this.value)">
            <div id="searchResults"></div>
        </div>
    </div>

    <div class="backdrop" id="addMenu" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()" style="padding: 24px 20px;">
    
            <div class="modal-header" style="margin-bottom: 16px;">
                <span class="brand-name" style="font-size: 32px;">नाद</span>
                <span class="brand-sub" style="font-size: 13px;">Naad Music Player</span>
                <span style="font-size: 10px; font-weight: 600; color: var(--text-sub); opacity: 0.6; margin-top: 4px;">v2.0</span>
            </div>

            <div class="setting-group">
                <div class="setting-label">Interface Appearance</div>
                <div class="toggle-row">
                    <button class="toggle-btn" id="btnLight" onclick="if(document.body.getAttribute('data-theme')!=='light') app.toggleTheme()">Light</button>
                    <button class="toggle-btn" id="btnDark" onclick="if(document.body.getAttribute('data-theme')!=='dark') app.toggleTheme()">Dark</button>
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-label">Loudness Normalization</div>
                <div class="toggle-row">
                    <button class="toggle-btn" id="btnNormOff" onclick="if(state.loudness) app.toggleNorm()">Off</button>
                    <button class="toggle-btn" id="btnNormOn" onclick="if(!state.loudness) app.toggleNorm()">On</button>
                </div>
            </div>

            <div class="setting-group">
                <div class="setting-label">Library Management</div>
                
                <div class="action-grid">
                    <button class="action-btn compact" onclick="triggerFile()">
                        <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                        <div>Add Files</div>
                    </button>
                    
                    <button class="action-btn compact" onclick="triggerFolder()">
                        <svg viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
                        <div>Add Folder</div>
                    </button>

                    <button class="action-btn compact" onclick="app.syncLibrary(); ui.closeModals();">
                        <svg viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>
                        <div>Sync Library</div>
                    </button>

                    <button class="action-btn compact" onclick="app.reset(); ui.closeModals();">
                        <svg viewBox="0 0 24 24" style="fill:#EF4444"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                        <div style="color:#EF4444">Reset Library</div>
                    </button>
                </div>
            </div>

            <div class="menu-footer" style="margin-top: 4px; font-size: 11px;">
                <div style="opacity:0.8">Designed by <span style="color:var(--active-color);">Bhaskarjyoti Das</span></div>
                <div style="margin-top: 6px; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    Made in India <div class="flag" style="width:18px; height:12px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="backdrop" id="sortModal" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Sort By</div>
            </div>
            <div id="sortOptions">
                </div>
        </div>
    </div>

    <div class="backdrop" id="contextMenu" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title" id="ctxTitle">Options</div>
            </div>
            <div id="ctxContent" style="display:flex; flex-direction:column; gap:4px;"></div>
        </div>
    </div>

    <div class="backdrop" id="editModal" onclick="ui.closeModals()">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Edit Metadata</div>
            </div>
            <input type="hidden" id="editId">
            <div class="input-group"><label>Title</label><input type="text" class="input-field" id="editTitle"></div>
            <div class="input-group"><label>Artist</label><input type="text" class="input-field" id="editArtist"></div>
            <div class="input-group"><label>Album</label><input type="text" class="input-field" id="editAlbum"></div>
            <button class="btn btn-solid" style="width:100%" onclick="app.saveEdit()">Save Changes</button>
        </div>
    </div>

    <header>
        <button class="logo-btn" onclick="document.getElementById('addMenu').classList.add('open')">
            <span class="logo-text">नाद</span>
        </button>
        <div class="app-title"></div> 
        <div class="header-actions">
            <button class="btn btn-icon" id="btnViewToggle" onclick="app.toggleView()" style="display:none;">
            </button>
            <button class="btn btn-icon" id="btnSort" onclick="app.showSortMenu()">
                <svg class="icon-std" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M6 12h12"/><path d="M10 18h4"/></svg>
            </button>
            <button class="btn btn-icon" id="btnHeadSearch" onclick="app.openSearch()">
                <svg class="icon-std" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                <span style="font-size: 13px; letter-spacing: 0.5px; font-weight: 400;">Search</span>
            </button>
            </div>
    </header>

    <div id="appView">
        <div class="container">
            <div class="tabs-row">
                <div class="tab active" id="tab-home" onclick="ui.setTab('home')">Home</div>
                <div class="tab" id="tab-artists" onclick="ui.setTab('artists')">Artists</div>
                <div class="tab" id="tab-albums" onclick="ui.setTab('albums')">Albums</div>
                <div class="tab" id="tab-folders" onclick="ui.setTab('folders')">Library</div>
            </div>
            <div id="content">
                <div id="view-home" class="tab-view active"></div>
                <div id="view-artists" class="tab-view"></div>
                <div id="view-albums" class="tab-view"></div>
                <div id="view-folders" class="tab-view"></div>
                <div id="view-tracks" class="tab-view"></div>
                <div id="view-group" class="tab-view"></div>
            </div>
        </div>
    </div>

    <div id="miniPlayer" onclick="ui.openPlayer()">
        <div id="mpBg"></div> 
        <div class="mp-img">
            <img id="mpArt" src="">
            <canvas id="mpVizCanvas"></canvas>
        </div>
        <div class="mp-data">
            <div class="t-title" id="mpTitle">Not Playing</div>
            <div class="t-meta" id="mpArtist">Select a track</div>
            <div class="mp-prog-track"><div class="mp-prog-fill" id="mpFill"></div></div>
        </div>
        <button class="mp-btn" id="mpBtn" onclick="event.stopPropagation(); player.toggle()">
            <svg><path d="M5 3l14 9-14 9V3z"/></svg>
        </button>
    </div>

    <div id="fullPlayer">
        <div class="fp-head">
            <button class="btn btn-icon" onclick="ui.closePlayer()">
                <svg><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
            </button>
            <div style="font-weight:400; font-size:12px; letter-spacing:1px; opacity:0.9; color:var(--text-main);"></div> 
            <button class="btn btn-icon" style="color:var(--active-color); background:transparent; box-shadow:none;" onclick="player.toggleQueue()">
                <svg><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
            </button>
        </div>

        <div class="fp-stage" id="fpTouchArea">
            <div class="fp-art-frame" onclick="viz.toggle()">
                <img id="fpArt" src="">
                <div id="fpPlaceholder" class="fp-placeholder">
                     <svg class="track-icon-filled" style="width:120px;height:120px;opacity:0.4" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-12.5c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg>
                </div>
                <canvas id="vizCanvas" class="fp-viz"></canvas>
            </div>
        </div>

        <div class="fp-controls">
            <div class="fp-meta">
                <div class="fp-title" id="fpTitle" onclick="app.goToCurrentAlbum()">Title</div>
                <div class="fp-artist" id="fpArtist" onclick="app.goToCurrentArtist()">Artist</div>
            </div>

            <div class="bar-wrap" id="scrubber">
                <div class="bar-bg"><div class="bar-fill" id="fpFill"></div></div>
            </div>
            <div class="time-row"><span id="tCurr">0:00</span><span id="tDur">0:00</span></div>

            <div class="ctrl-row">
                <button class="btn-ctrl" id="btnShuf" onclick="player.toggleShuffle()">
                    <svg><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>
                </button>
                <button class="btn-ctrl" onclick="player.prev()"><svg><path d="M11 18V6l-8.5 6 8.5 6zm.5-6l8.5 6V6l-8.5 6z"/></svg></button>
                <button class="btn btn-play-lg" id="fpPlayBtn" onclick="player.toggle()">
                    <svg><path d="M5 3l14 9-14 9V3z"/></svg>
                </button>
                <button class="btn-ctrl" onclick="player.next()"><svg><path d="M4 18l8.5-6L4 6v12zm9-12v12l8.5-6L13 6z"/></svg></button>
                <button class="btn-ctrl" id="btnRep" onclick="player.toggleRepeat()"><svg><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg></button>
            </div>
        </div>
        <div id="queueBackdrop" onclick="player.toggleQueue()"></div>
        <div class="queue-sheet" id="queueSheet">
            <div class="q-head">
                <div class="q-title">Up Next</div>
                <button class="btn btn-icon" style="width:32px;height:32px;background:transparent;box-shadow:none;" onclick="player.toggleQueue()">
                    <svg><polyline points="6 9 12 15 18 9"></polyline></svg>
                </button>
            </div>
            <div class="q-list" id="qList"></div>
        </div>
    </div>

    <input type="file" id="fileIn" multiple accept="audio/*">
    <input type="file" id="folderIn" webkitdirectory directory multiple>

    <script>
        function updateStatusBarColor() {
            const theme = document.body.getAttribute('data-theme');
            const meta = document.getElementById('themeColorMeta');
            const color = theme === 'dark' ? '#09090b' : '#F3F4F6';
            if (meta) meta.setAttribute('content', color);
            const appleMeta = document.querySelector('meta[name="apple-mobile-web-app-status-bar-style"]');
            if (appleMeta) {
                appleMeta.setAttribute('content', theme === 'dark' ? 'black' : 'default');
            }
        }

        const DB_NAME = 'NaadQueueDB';
        const STORE_TRACKS = 'tracks';
        const STORE_IMAGES = 'images';
        let db;

        const state = { 
            tracks: [], images: {}, queue: [], qIdx: -1, 
            tab: 'home', // CHANGE 'tracks' TO 'home'
            playing: false, shuffle: false, repeat: 0, 
            visMode: 2, viewGroup: null, miniVizActive: false, currentFolder: '',
            viewMode: 'grid', sortMode: 'id', sortDesc: false, scrubbing: false,
            loudness: false // <--- ADD THIS
        };
        
        function getDominantColor(imgEl, callback) {
            if(!imgEl.complete) {
                imgEl.onload = () => extract(imgEl, callback);
            } else {
                extract(imgEl, callback);
            }
        }
        function extract(img, cb) {
            try {
                const c = document.getElementById('colorCanvas');
                const ctx = c.getContext('2d');
                ctx.clearRect(0,0,1,1);
                ctx.drawImage(img, 0, 0, 1, 1);
                const p = ctx.getImageData(0,0,1,1).data;
                const rgb = `rgb(${p[0]},${p[1]},${p[2]})`;
                const lum = (0.299*p[0] + 0.587*p[1] + 0.114*p[2]);
                const textCol = lum > 128 ? '#000000' : '#FFFFFF';
                cb(rgb, textCol);
            } catch(e) { cb('var(--surface)', 'var(--text-main)'); }
        }

        async function init() {
            try {
                const saved = JSON.parse(localStorage.getItem('naadSettings') || '{}');
                if (saved.theme) {
                    document.body.setAttribute('data-theme', saved.theme);
                } else {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.body.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                }

                updateStatusBarColor();

                state.shuffle = saved.shuffle || false;
                state.repeat = saved.repeat || 0;
                state.loudness = saved.loudness || false; // <--- ADD THIS
                state.viewMode = saved.viewMode || 'grid';
                state.sortMode = saved.sortMode || 'name';
                state.sortDesc = saved.sortDesc || false; // Load sort direction
                state.currentFolder = saved.currentFolder || '';
                
                document.getElementById('btnShuf').classList.toggle('active', state.shuffle);
                document.getElementById('btnRep').classList.toggle('active', state.repeat > 0);
                // UPDATE UI FOR TOGGLE
                updateNormUI(); // <--- ADD THIS CALL
            } catch(e) {}

            if(window.Capacitor) {
                try {
                    const stat = await Capacitor.Plugins.Filesystem.checkPermissions();
                    if(stat.publicStorage !== 'granted') document.getElementById('permPopup').classList.add('open');
                } catch(e) { document.getElementById('permPopup').classList.add('open'); }
                
                // Initialize Native Notification Listeners
                await setupNotificationListeners();
            }

            db = await openDB();
            (await getAll(STORE_IMAGES)).forEach(i => state.images[i.path] = i.blob);
            state.tracks = (await getAll(STORE_TRACKS)).sort((a,b) => a.id.localeCompare(b.id));
            ui.render();
            viz.setup();
            setupSwipe();
            
            // Set default media handler
            if('mediaSession' in navigator) {
                navigator.mediaSession.setActionHandler('play', () => player.toggle());
                navigator.mediaSession.setActionHandler('pause', () => player.toggle());
                navigator.mediaSession.setActionHandler('previoustrack', () => player.prev());
                navigator.mediaSession.setActionHandler('nexttrack', () => player.next());
                navigator.mediaSession.setActionHandler('seekto', (details) => {
                     if(details.seekTime && !isNaN(details.seekTime)) {
                         audio.currentTime = details.seekTime;
                     }
                });
            }
        }
        
        async function setupNotificationListeners() {
            if (!window.Capacitor) return;
            const { PersistentNotification } = Capacitor.Plugins;
            if (!PersistentNotification) return;
            try {
                await PersistentNotification.addListener('notificationclick', (data) => {
                    if (data.action === 'prev') player.prev();
                    if (data.action === 'next') player.next();
                    if (data.action === 'play') player.toggle();
                    if (data.action === 'pause') player.toggle();
                    if (data.action === 'close') {
                        if(state.playing) player.toggle();
                        PersistentNotification.close(); 
                    }
                });
            } catch(e) { console.error("Notification listener setup failed", e); }
        }

        async function updateNativeNotification() {
            if (!window.Capacitor) return;
            const { PersistentNotification } = Capacitor.Plugins;
            if (!PersistentNotification) return;
            const t = player.curr;
            if (!t) { PersistentNotification.close(); return; }
            const isPlaying = state.playing;
            const actions = [{ action: isPlaying ? 'pause' : 'play', title: isPlaying ? 'Pause' : 'Play', icon: isPlaying ? 'ic_media_pause' : 'ic_media_play' }];
            try {
                await PersistentNotification.open({
                    title: t.name, body: t.artist || "Unknown Artist", id: 1337, icon: 'ic_media_play', actions: actions 
                });
            } catch(e) { console.error("Notification update failed", e); }
        }

        async function grantPerms() {
            try {
                await Capacitor.Plugins.Filesystem.requestPermissions();
                document.getElementById('permPopup').classList.remove('open');
            } catch(e) {
                alert("Permission required to scan music.");
            }
        }

        async function nativeScan() {
            if (!window.Capacitor) { alert("Native scanning is only available in the app."); return; }
            const fs = Capacitor.Plugins.Filesystem;
            try {
                const permissionStatus = await fs.requestPermissions();
                if (permissionStatus && permissionStatus.publicStorage === 'denied') { throw new Error("Storage permission was denied by user."); }
                const modal = document.getElementById('syncModal');
                const status = document.getElementById('syncStatus');
                modal.classList.add('open');
                
                const pathsToScan = ['Music', 'Download', 'Documents'];
                let addedCount = 0;
                const updateStatus = (msg) => { status.textContent = msg; };
                for (let root of pathsToScan) { addedCount += await scanDir(root, fs, updateStatus); }
                if (addedCount > 0) {
                    /* EDITED: Sort by ID ascending */
                    state.tracks.sort((a,b) => a.id.localeCompare(b.id));
                    ui.render();
                    alert(`Sync Complete. Added ${addedCount} new tracks.`);
                } else { alert("No new music files found in standard folders."); }
            } catch (err) {
                console.error("Scan Error:", err);
                alert("Unable to scan. Please ensure Storage Permissions are allowed in Settings.");
            } finally {
                document.getElementById('syncModal').classList.remove('open');
                document.getElementById('syncStatus').textContent = "Finding music files";
            }
        }

        async function scanDir(path, fs, statusCb) {
            let count = 0;
            try {
                if(statusCb) statusCb(`Scanning: ${path}`);
                const res = await fs.readdir({ path: path, directory: 'EXTERNAL_STORAGE' });
                for (const file of res.files) {
                    if (file.type === 'file') {
                        if (/\.(mp3|wav|flac|m4a)$/i.test(file.name)) {
                            let size = file.size;
                            if (!size) {
                                try {
                                    const stat = await fs.stat({ path: path + '/' + file.name, directory: 'EXTERNAL_STORAGE' });
                                    size = stat.size;
                                } catch(e){}
                            }
                            if (size && size > 1048576) {
                                const id = `native-${file.name}-${size}`;
                                if(!state.tracks.find(t=>t.id===id)) {
                                    if(statusCb) statusCb(`Processing: ${file.name}`);
                                    const fileUri = await fs.getUri({ path: path + '/' + file.name, directory: 'EXTERNAL_STORAGE' });
                                    const srcUrl = Capacitor.convertFileSrc(fileUri.uri);
                                    let meta = { artist: 'Unknown', album: 'Unknown', genre: 'Unknown' };
                                    try {
                                        const response = await fetch(srcUrl);
                                        const blob = await response.blob();
                                        meta = await parseID3(blob);
                                        if (meta.picture) {
                                            if (!state.images[path]) {
                                                state.images[path] = meta.picture;
                                                put(STORE_IMAGES, { path: path, blob: meta.picture });
                                            }
                                        }
                                    } catch(ex) { console.log('Meta parse fail', ex); }
                                    const t = { id, name: file.name.replace(/\.[^/.]+$/,""), artist: meta.artist || 'Unknown', album: meta.album || 'Unknown', genre: meta.genre || 'Unknown', folder: path, blob: null, url: srcUrl, filePath: fileUri.uri, added: Date.now() };
                                    await put(STORE_TRACKS, t); state.tracks.push(t); count++;
                                }
                            }
                        }
                    } else if (file.type === 'directory') { count += await scanDir(path + '/' + file.name, fs, statusCb); }
                }
            } catch(e) { }
            return count;
        }

        function updateNormUI() {
            const btnOn = document.getElementById('btnNormOn');
            const btnOff = document.getElementById('btnNormOff');
            
            // 1. Helper to reset button styles to default
            const reset = (b) => {
                b.style.background = 'transparent';
                b.style.color = 'var(--text-sub)';
                b.style.boxShadow = 'none';
            };
            
            if (state.loudness) {
                // --- CASE: ON (Active) ---
                reset(btnOff); // Reset Red button
                
                // Style Green button
                btnOn.style.background = '#10B981'; // Emerald Green
                btnOn.style.color = '#ffffff';
                btnOn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)'; // Green Shadow
            } else {
                // --- CASE: OFF (Active) ---
                reset(btnOn); // Reset Green button
                
                // Style Red button
                btnOff.style.background = '#EF4444'; // Bright Red
                btnOff.style.color = '#ffffff';
                btnOff.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.4)'; // Red Shadow
            }
        }

        function setupSwipe() {
            let startY = 0;
            let startX = 0;
            const fp = document.getElementById('fullPlayer');
            const qs = document.getElementById('queueSheet');
            const av = document.getElementById('appView');

            let avSx = 0;
            av.addEventListener('touchstart', e => avSx = e.touches[0].clientX, {passive:true});
            av.addEventListener('touchend', e => {
                const diff = avSx - e.changedTouches[0].clientX;
                if(Math.abs(diff) > 60) {
                    const tabs = ['home', 'artists', 'albums', 'folders'];
                    const idx = tabs.indexOf(state.tab);
                    if(diff > 0 && idx < tabs.length-1) ui.setTab(tabs[idx+1]); 
                    if(diff < 0 && idx > 0) ui.setTab(tabs[idx-1]); 
                }
            }, {passive:true});
            
            fp.addEventListener('touchstart', e => {
                startY = e.touches[0].clientY;
                startX = e.touches[0].clientX;
            }, {passive:true});
            
            fp.addEventListener('touchend', e => {
                const endY = e.changedTouches[0].clientY;
                const endX = e.changedTouches[0].clientX;
                const diffX = startX - endX;
                const diffY = startY - endY;
                
                if (Math.abs(diffX) > Math.abs(diffY)) {
                    if (Math.abs(diffX) > 60) {
                        ui.closePlayer();
                    }
                } else {
                    if (diffY > 50 && !qs.classList.contains('open')) {
                        player.toggleQueue();
                    } else if (diffY < -50 && !qs.classList.contains('open')) {
                        ui.closePlayer();
                    }
                }
            }, {passive:true});

            // UPDATED: Prevent propagation so swipe down on queue only closes queue
            qs.addEventListener('touchstart', e => {
                e.stopPropagation();
                startY = e.touches[0].clientY;
            }, {passive:true});

            qs.addEventListener('touchend', e => {
                e.stopPropagation();
                const endY = e.changedTouches[0].clientY;
                if(endY - startY > 50 && qs.classList.contains('open')) player.toggleQueue(); 
            }, {passive:true});
        }

        function triggerFile() { document.getElementById('fileIn').click(); ui.closeModals(); }
        function triggerFolder() { document.getElementById('folderIn').click(); ui.closeModals(); }
        document.getElementById('fileIn').onchange = e => processFiles(e.target.files);
        document.getElementById('folderIn').onchange = e => processFiles(e.target.files);

        async function processFiles(files) {
            const modal = document.getElementById('syncModal');
            const status = document.getElementById('syncStatus');
            modal.classList.add('open');
            status.textContent = "Analyzing files...";
            const list = Array.from(files);
            for(const f of list) {
                if(f.type.startsWith('image/')) {
                    const p = getPath(f.webkitRelativePath||f.name);
                    if(p) { state.images[p]=f; put(STORE_IMAGES, {path:p, blob:f}); }
                }
            }
            let count=0;
            for(const f of list) {
                if(f.type.startsWith('audio/') || /\.(mp3|wav|flac|m4a)$/i.test(f.name)) {
                    status.textContent = `Processing: ${f.name}`;
                    await new Promise(r => setTimeout(r, 0));
                    const id = `${f.name}-${f.size}`;
                    if(!state.tracks.find(t=>t.id===id)) {
                        const meta = await parseID3(f);
                        const folderPath = getPath(f.webkitRelativePath);
                        if (meta.picture && folderPath) {
                            if (!state.images[folderPath]) {
                                state.images[folderPath] = meta.picture;
                                put(STORE_IMAGES, { path: folderPath, blob: meta.picture });
                            }
                        }
                        const t = { id, name: f.name.replace(/\.[^/.]+$/,""), artist: meta.artist||'Unknown', album: meta.album||'Unknown', genre: meta.genre||'Unknown', folder: getPath(f.webkitRelativePath), blob: f, added: Date.now() };
                        await put(STORE_TRACKS, t); state.tracks.push(t); count++;
                    }
                }
            }
            /* EDITED: Sort by ID ascending */
            state.tracks.sort((a,b) => a.id.localeCompare(b.id));
            ui.render(null, true);
            modal.classList.remove('open');
            status.textContent = "Finding music files";
            alert(`Added ${count} tracks.`);
        }
        function getPath(s) { if(!s) return ""; const p=s.split('/'); p.pop(); return p.join('/'); }
        function getTrackSize(t) {
            if(t.blob) return t.blob.size;
            const match = t.id.match(/-(\d+)$/);
            return match ? parseInt(match[1]) : 0;
        }
        function formatPathHeader(p) {
            if(!p) return 'Unknown';
            const parts = p.split('/');
            if(parts.length < 2) return p;
            return parts[parts.length-2] + ' / ' + parts[parts.length-1];
        }
        function getRecursiveArt(folderPath) {
            const match = state.tracks.find(t => t.folder === folderPath || t.folder.startsWith(folderPath + '/'));
            if(match) {
                if(state.images[match.folder]) return state.images[match.folder];
                const subMatch = state.tracks.find(t => t.folder.startsWith(folderPath) && state.images[t.folder]);
                if(subMatch) return state.images[subMatch.folder];
            }
            return null;
        }
        async function parseID3(file) {
            const meta = {};
            try {
                const b = await file.slice(0, 2 * 1024 * 1024).arrayBuffer();
                const v = new DataView(b);
                if (v.getUint8(0) === 73 && v.getUint8(1) === 68 && v.getUint8(2) === 51) {
                    const size = ((v.getUint8(6) & 0x7f) << 21) | ((v.getUint8(7) & 0x7f) << 14) | ((v.getUint8(8) & 0x7f) << 7) | (v.getUint8(9) & 0x7f);
                    let o = 10;
                    const limit = Math.min(size + 10, b.byteLength);
                    while (o < limit) {
                        const id = String.fromCharCode(v.getUint8(o), v.getUint8(o+1), v.getUint8(o+2), v.getUint8(o+3));
                        let s = v.getUint32(o + 4); 
                        if (s > 2000000 || s <= 0) break; 
                        if (['TIT2', 'TPE1', 'TALB', 'TCON'].includes(id)) {
                            let str = '';
                            for (let i = 1; i < s; i++) { const c = v.getUint8(o + 10 + i); if (c > 31 && c < 127) str += String.fromCharCode(c); }
                            if (id === 'TIT2') meta.title = str;
                            if (id === 'TPE1') meta.artist = str;
                            if (id === 'TALB') meta.album = str;
                            if (id === 'TCON') meta.genre = str;
                        }
                        if (id === 'APIC') {
                            let ptr = o + 11; let mime = "";
                            while (v.getUint8(ptr) !== 0 && ptr < limit) { mime += String.fromCharCode(v.getUint8(ptr)); ptr++; }
                            ptr += 2; while (v.getUint8(ptr) !== 0 && ptr < limit) ptr++; ptr++; 
                            const imgSize = (o + 10 + s) - ptr;
                            if (imgSize > 0) { const imgBuf = b.slice(ptr, ptr + imgSize); meta.picture = new Blob([imgBuf], { type: mime || 'image/jpeg' }); }
                        }
                        o += 10 + s;
                    }
                }
            } catch (e) { console.error("ID3 Parse Error", e); }
            return meta;
        }

        const ui = {
            setTab: (t) => {
                // 1. Close any open group (Album/Artist view)
                state.viewGroup = null;
                
                // 2. Update State
                state.tab = t;

                // 3. Update Tab Button Styles
                document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
                const tabId = t === 'home' ? 'tab-home' : 'tab-' + t;
                const el = document.getElementById(tabId);
                if(el) el.classList.add('active');

                // 4. Hide all views, Show target view
                document.querySelectorAll('.tab-view').forEach(e => e.classList.remove('active'));
                const targetId = 'view-' + t;
                const targetDiv = document.getElementById(targetId);
                if(targetDiv) targetDiv.classList.add('active');

                // 5. Update Header Buttons (Sort/View Toggle)
                const btnView = document.getElementById('btnViewToggle');
                const btnSort = document.getElementById('btnSort');
                
                // Logic for buttons visibility
                if (t === 'home') {
                    btnSort.style.display = 'none';
                    btnView.style.display = 'none';
                } else {
                    btnSort.style.display = 'flex';
                    // Only show View toggle (Grid/List) for relevant tabs
                    if(t !== 'folders') {
                        btnView.style.display = 'flex';
                        ui.updateViewBtn();
                    } else {
                        // Folders has specific logic inside render, but we can default show it
                        btnView.style.display = 'flex'; 
                    }
                }

                // 6. LAZY LOAD: Only render if the div is empty!
                // This is the key performance booster.
                if (!targetDiv.hasChildNodes()) {
                    ui.render(targetDiv);
                }
            },
            updateViewBtn: () => {
                const btn = document.getElementById('btnViewToggle');
                if(state.viewMode === 'grid') {
                    btn.innerHTML = `<svg class="icon-std" viewBox="0 0 24 24"><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="12" x2="16" y2="12"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>`;
                } else {
                    btn.innerHTML = `<svg class="icon-std" viewBox="0 0 24 24"><rect x="3" y="3" width="8" height="8" rx="1"></rect><rect x="13" y="3" width="8" height="8" rx="1"></rect><rect x="13" y="13" width="8" height="8" rx="1"></rect><rect x="3" y="13" width="8" height="8" rx="1"></rect></svg>`;
                }
            },
            openGroup: (k, l) => { 
                state.viewGroup = {title: k, list: l}; 
                
                // Switch to Group View container
                document.querySelectorAll('.tab-view').forEach(e => e.classList.remove('active'));
                const gDiv = document.getElementById('view-group');
                gDiv.classList.add('active');
                
                // Always re-render group view as content changes dynamically
                ui.render(gDiv, true); 
            },

            closeGroup: () => { 
                state.viewGroup = null; 
                
                // Hide Group view
                document.getElementById('view-group').classList.remove('active');
                
                // Restore the current tab's view
                const targetId = 'view-' + state.tab;
                document.getElementById(targetId).classList.add('active');
                
                // No render call needed! The previous tab state is preserved.
            },
            /* UPDATED: Added 'true' to force re-render */
            setFolder: (path) => { 
                state.currentFolder = path; 
                app.saveSettings(); 
                ui.render(null, true); // Force render
            },

            upFolder: () => {
                if(!state.currentFolder) return;
                const p = state.currentFolder.split('/');
                p.pop();
                state.currentFolder = p.join('/');
                app.saveSettings(); 
                ui.render(null, true); // Force render
            },
            closeModals: () => document.querySelectorAll('.backdrop').forEach(e=>e.classList.remove('open')),
            openPlayer: () => document.getElementById('fullPlayer').classList.add('visible'),
            closePlayer: () => document.getElementById('fullPlayer').classList.remove('visible'),
            
            render: (targetContainer = null, force = false) => {
                
                // 1. Determine which container to use if not passed
                let c = targetContainer;
                if (!c) {
                    if (state.viewGroup) c = document.getElementById('view-group');
                    else c = document.getElementById('view-' + state.tab);
                }

                // 2. Optimization: If container has content and we aren't forced to update, STOP.
                if (!force && c.hasChildNodes()) return;

                // 3. Clear ONLY the specific container
                c.innerHTML = '';
                
                // ... rest of your existing render code ...
                // ... logic for Storage count, buttons etc ...

                const btn = document.getElementById('btnViewToggle');

                // --- NEW CODE STARTS HERE ---
                const btnSort = document.getElementById('btnSort');
                if (state.tab === 'home' && !state.viewGroup) {
                    btnSort.style.display = 'none';
                } else {
                    btnSort.style.display = 'flex';
                }
                // --- NEW CODE ENDS HERE ---   

                /*document.getElementById('menuSongCount').textContent = state.tracks.length + ' songs';
                const uniqueFolders = new Set(state.tracks.map(t=>t.folder)).size;
                document.getElementById('menuFolderCount').textContent = uniqueFolders + ' folders';
                */
                // --- FIX: Handle Header Search Button ---
                const btnSearch = document.getElementById('btnHeadSearch');
                btnSearch.style.display = 'flex';
                /*if (state.tab === 'home' && !state.viewGroup) {
                    btnSearch.style.display = 'none'; // Hide on Home (redundant with main search bar)
                } else {
                    btnSearch.style.display = 'flex'; // Show elsewhere
                }
                */

                let size = 0;
                state.tracks.forEach(t => { if(t.blob) size += t.blob.size; });
                Object.values(state.images).forEach(b => size += b.size);
                size += JSON.stringify(state.tracks).length; 

                /*let sizeStr = '0 MB';
                if(size > 1024*1024*1024*1024) sizeStr = (size/(1024*1024*1024*1024)).toFixed(2) + ' TB';
                else if(size > 1024*1024*1024) sizeStr = (size/(1024*1024*1024)).toFixed(2) + ' GB';
                else sizeStr = (size/(1024*1024)).toFixed(1) + ' MB';
                document.getElementById('storageCount').textContent = sizeStr;*/

                /*const c = document.getElementById('content'); c.innerHTML='';*/

                if (state.tab === 'home') btn.style.display = 'none';
                else if (state.viewGroup) btn.style.display = 'none';
                else if (state.tab !== 'folders') {
                     btn.style.display = 'flex';
                     ui.updateViewBtn();
                }

                // --- HOME TAB LOGIC ---
                if(state.tab === 'home' && !state.viewGroup) {
                    // 1. SEARCH BAR
                    const searchDiv = document.createElement('div');
                    searchDiv.className = 'home-header';
                    /*searchDiv.innerHTML = `
                        <div class="home-search-bar" onclick="app.openSearch()">
                            <svg width="20" height="20" viewBox="0 0 24 24" style="fill:none;stroke:currentColor;stroke-width:2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                            Search your library...
                        </div>
                    `;
                    c.appendChild(searchDiv);*/

                    if(!state.tracks.length) {
                        // UPDATED: Show full "Empty Library" panel with buttons instead of just text
                        const isNative = typeof Capacitor !== 'undefined';
                        const actionBtn = isNative 
                            ? `<button class="btn" onclick="app.syncLibrary()" style="background:var(--active-color); color:#fff; padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:0 4px 12px rgba(124,58,237,0.3);"><svg style="width:20px;height:20px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>Sync Storage</button>`
                            : `<button class="btn" onclick="triggerFolder()" style="background:var(--active-color); color:#fff; padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:0 4px 12px rgba(124,58,237,0.3);"><svg style="width:20px;height:20px;fill:currentColor;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Add Folder</button>`;

                        c.innerHTML += `<div style="min-height:60vh; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px;">
                            <div style="font-size:14px; font-weight:600; color:var(--text-sub); margin-bottom:8px; opacity:0.6; letter-spacing:1px;">LIBRARY EMPTY</div>
                            <button class="btn" onclick="triggerFile()" style="background:var(--surface-2); color:var(--text-main); padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:none;">
                                <svg style="width:20px;height:20px;fill:var(--text-sub);" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Add Music Files
                            </button>
                            ${actionBtn}
                        </div>`;
                        return;
                    }

                    // Helper to build Carousel
                    const buildCarousel = (title, items, isAlbum = false) => {
                        if(!items.length) return;
                        const sec = document.createElement('div'); sec.className = 'carousel-section';
                        
                        const head = document.createElement('div'); head.className = 'carousel-head';
                        head.innerHTML = `<span>${title}</span>`;
                        sec.appendChild(head);

                        const scroll = document.createElement('div'); scroll.className = 'carousel-scroll';
                        
                        // UPDATED: Stop event propagation to prevent tab switching while scrolling carousel
                        const stopSwipe = (e) => e.stopPropagation();
                        scroll.addEventListener('touchstart', stopSwipe, {passive: true});
                        scroll.addEventListener('touchend', stopSwipe, {passive: true});


                        items.forEach(item => {
                            const card = document.createElement('div'); card.className = 'c-card';
                            
                            let mainText = isAlbum ? item.name : item.name;
                            let subText = isAlbum ? item.artist : item.artist;
                            
                            // Get Art
                            let tRef = isAlbum ? state.tracks.find(t => t.album === item.name) : item;
                            // Use existing ui.getArt but strip the wrapper div if needed or just dump innerHTML
                            // Simplest way: just call ui.getArt, it returns an HTML string.
                            const artHtml = tRef ? ui.getArt(tRef) : '';

                            // We need to inject the artHtml into .c-art. 
                            // Since ui.getArt returns a full string, we can use it directly inside .c-art
                            // However, ui.getArt returns a string like <img...> or <div...>. 
                            // We can just set innerHTML.
                            
                            card.innerHTML = `
                                <div class="c-art">${artHtml}</div>
                                <div class="c-info">
                                    <div class="c-title">${mainText}</div>
                                    <div class="c-sub">${subText}</div>
                                </div>
                            `;
                            
                            // Fix art style for carousel (ui.getArt might return unstyled img)
                            const artEl = card.querySelector('.c-art img');
                            if(artEl) { artEl.style.width='100%'; artEl.style.height='100%'; artEl.style.objectFit='cover'; }

                            card.onclick = () => {
                                if(isAlbum) {
                                    const albumTracks = state.tracks.filter(t => t.album === item.name);
                                    ui.setTab('albums'); 
                                    ui.openGroup(item.name, albumTracks);
                                } else {
                                    // NEW LOGIC: Plays the entire carousel list, starting at this track
                                    player.playQueue(items, items.indexOf(item));
                                }
                            };
                            scroll.appendChild(card);
                        });
                        sec.appendChild(scroll);
                        c.appendChild(sec);
                    };

                    // 2. MOST PLAYED TRACKS
                    const topTracks = [...state.tracks].sort((a,b) => (b.plays||0) - (a.plays||0)).slice(0, 15);
                    buildCarousel('Songs You Love', topTracks, false);

                    // 2.5. HAVEN'T LISTENED TO FOR A LONG TIME
                    // Filter: Has been played at least once.
                    // Sort: Oldest 'lastPlayed' timestamp first. (Undefined timestamps count as very old)
                    const forgotten = state.tracks
                        .filter(t => t.plays > 0)
                        .sort((a,b) => (a.lastPlayed || 0) - (b.lastPlayed || 0))
                        .slice(0, 15);
                    
                    if(forgotten.length > 0) {
                        buildCarousel("Listen of the Day", forgotten, false);
                    }

                    // 3. MOST PLAYED ALBUMS
                    const albMap = {};
                    state.tracks.forEach(t => {
                        const k = t.album || 'Unknown Album';
                        if(!albMap[k]) albMap[k] = { name: k, artist: t.artist, plays: 0 };
                        albMap[k].plays += (t.plays || 0);
                    });
                    const topAlbums = Object.values(albMap).sort((a,b) => b.plays - a.plays).slice(0, 15);
                    buildCarousel('Albums You Love', topAlbums, true);

                    // 4. RECENTLY ADDED (Conditional)
                    // Define "Just Added" threshold (e.g., 14 Days)
                    const recentLimit = 10*60*1000; /* 10 minutes now; 14 * 24 * 60 * 60 * 1000;*/ 
                    const now = Date.now();

                    // Filter: Keep only tracks added within the last 14 days
                    const recentTracks = state.tracks
                        .filter(t => (now - t.added) < recentLimit)
                        .sort((a,b) => b.added - a.added)
                        .slice(0, 15);

                    // Render: Only build carousel if tracks exist in this window
                    if (recentTracks.length > 0) {
                        buildCarousel('Recently Added', recentTracks, false);
                    }

                    // --- NEW SECTION: HIDDEN GEMS (Unheard + Forgotten Randomized) ---
                    const oneMonth = 30 * 24 * 60 * 60 * 1000; // 30 Days in milliseconds
                    const nowTime = Date.now();

                    // 1. Filter: Find songs with 0 plays OR songs not played in 30 days
                    let discoveryPool = state.tracks.filter(t => {
                        const isUnheard = !t.plays || t.plays === 0;
                        // Check if played more than 30 days ago
                        const isForgotten = t.lastPlayed && (nowTime - t.lastPlayed > oneMonth);
                        return isUnheard || isForgotten;
                    });

                    // 2. Fallback: If the pool is too small (user listens to everything often), 
                    // use the whole library to ensure we always suggest something.
                    if (discoveryPool.length < 10) {
                        discoveryPool = [...state.tracks];
                    }

                    // 3. Randomize: Shuffle the pool
                    // (We create a copy [...] so we don't shuffle the original track list order)
                    const randomSelection = [...discoveryPool];
                    shuffleArray(randomSelection);

                    // 4. Render: Show top 15 results
                    if(randomSelection.length > 0) {
                        buildCarousel('Hidden Gems', randomSelection.slice(0, 15), false);
                    }
                    // ------------------------------------------------------------------

                    return; // End of Home Tab Logic
                }


                if(!state.tracks.length) {
                     const isNative = typeof Capacitor !== 'undefined';
                     const actionBtn = isNative 
                        ? `<button class="btn" onclick="app.syncLibrary()" style="background:var(--active-color); color:#fff; padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:0 4px 12px rgba(124,58,237,0.3);"><svg style="width:20px;height:20px;fill:currentColor;" viewBox="0 0 24 24"><path d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6 0 1.01-.25 1.97-.7 2.8l1.46 1.46C19.54 15.03 20 13.57 20 12c0-4.42-3.58-8-8-8zm0 14c-3.31 0-6-2.69-6-6 0-1.01.25-1.97.7-2.8L5.24 7.74C4.46 8.97 4 10.43 4 12c0 4.42 3.58 8 8 8v3l4-4-4-4v3z"/></svg>Sync Storage</button>`
                        : `<button class="btn" onclick="triggerFolder()" style="background:var(--active-color); color:#fff; padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:0 4px 12px rgba(124,58,237,0.3);"><svg style="width:20px;height:20px;fill:currentColor;" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Add Folder</button>`;
                    c.innerHTML = `<div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px;"><div style="font-size:14px; font-weight:600; color:var(--text-sub); margin-bottom:8px; opacity:0.6; letter-spacing:1px;">LIBRARY EMPTY</div><button class="btn" onclick="triggerFile()" style="background:var(--surface-2); color:var(--text-main); padding:12px 20px; width:220px; justify-content:flex-start; gap:12px; font-size:13px; box-shadow:none;"><svg style="width:20px;height:20px;fill:var(--text-sub);" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>Add Music Files</button>${actionBtn}</div>`;
                    return;
                }
                
                if(state.viewGroup) {
                    const list = state.viewGroup.list;
                    const h = document.createElement('div');
                    h.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:20px;';
                    h.innerHTML = `<div style="display:flex; align-items:center; gap:10px; flex:1; min-width:0; padding-right:24px;"><button class="btn btn-icon" style="background:transparent; box-shadow:none; flex-shrink:0;" onclick="ui.closeGroup()"><svg><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg></button><div style="font-size:18px; font-weight:700; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${state.viewGroup.title}</div></div><div style="display:flex; gap:12px; align-items:center; flex-shrink:0;"><button class="group-btn" onclick="player.playQueue(state.viewGroup.list, 0)">Play All</button><button class="group-btn" onclick="player.playShuffle(state.viewGroup.list)"><svg style="fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg></button></div>`;
                    const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 20px';
                    list.forEach(t => l.appendChild(ui.row(t, list)));
                    c.appendChild(h); c.appendChild(l);
                    return;
                }

                if(state.tab === 'folders') {
                    const root = state.currentFolder;
                    const subFolders = {}; const files = [];
                    state.tracks.forEach(t => {
                        if (!root || t.folder === root || t.folder.startsWith(root + '/')) {
                             const relative = root ? t.folder.substring(root.length + 1) : t.folder;
                             if (!relative) files.push(t);
                             else { const parts = relative.split('/'); const sub = parts[0]; if(!subFolders[sub]) subFolders[sub] = []; subFolders[sub].push(t); }
                        }
                    });
                    const folderNames = Object.keys(subFolders);
                    if (folderNames.length > 0) { btn.style.display = 'flex'; ui.updateViewBtn(); } else { btn.style.display = 'none'; }

                    if(root) {
                        const rootEsc = root.replace(/'/g, "\\'");
                        const h = document.createElement('div');
                        h.style.cssText = 'display:flex; align-items:center; justify-content:space-between; padding:10px 20px;';
                        h.innerHTML = `<div style="display:flex; align-items:center; gap:12px; flex:1; min-width:0;"><button class="btn btn-icon" style="width:36px; height:36px; background:transparent; box-shadow:none; flex-shrink:0;" onclick="ui.upFolder()"><svg><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg></button><div style="font-weight:700; font-size:16px; color:var(--text-main); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${root.split('/').pop()}</div></div><div class="group-ctrls"><button class="group-btn" title="Play All" onclick="player.playQueue(state.tracks.filter(t => t.folder === '${rootEsc}' || t.folder.startsWith('${rootEsc}/')), 0)"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>Play</button><button class="group-btn" title="Shuffle" onclick="player.playShuffle(state.tracks.filter(t => t.folder === '${rootEsc}' || t.folder.startsWith('${rootEsc}/')))"><svg style="fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg></button></div>`;
                        c.appendChild(h);
                    }
                    const getFSize = (arr) => arr.reduce((acc, t) => acc + getTrackSize(t), 0);
                    const getFDate = (arr) => Math.max(...arr.map(t => t.added));
                    const getFArtist = (arr) => (arr[0] ? (arr[0].artist || '') : '');
                    
                    const mod = state.sortDesc ? -1 : 1;

                    if(state.sortMode === 'count') folderNames.sort((a,b) => (subFolders[b].length - subFolders[a].length) * mod);
                    else if(state.sortMode === 'date') folderNames.sort((a,b) => (getFDate(subFolders[b]) - getFDate(subFolders[a])) * mod);
                    else if(state.sortMode === 'size') folderNames.sort((a,b) => (getFSize(subFolders[b]) - getFSize(subFolders[a])) * mod);
                    else if(state.sortMode === 'artist') folderNames.sort((a,b) => getFArtist(subFolders[a]).localeCompare(getFArtist(subFolders[b])) * mod);
                    else folderNames.sort((a,b) => a.localeCompare(b) * mod);

                    if(folderNames.length > 0) {
                        if (state.viewMode === 'list') {
                            const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 0'; 
                            folderNames.forEach(name => {
                                const fullPath = root ? root + '/' + name : name;
                                const blob = getRecursiveArt(fullPath); const imgSrc = blob ? URL.createObjectURL(blob) : null;
                                let imgHTML = imgSrc ? `<img src="${imgSrc}">` : `<div style="width:100%;height:100%;background:var(--surface-2);display:flex;align-items:center;justify-content:center"><svg class="track-icon-filled" style="width:24px;height:24px" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div>`;
                                const el = document.createElement('div'); el.className='track-row';
                                el.innerHTML = `<div class="t-art">${imgHTML}</div><div class="t-data"><div class="t-title">${name}</div><div class="t-meta">${subFolders[name].length} tracks</div></div><div class="more-btn" onclick="event.stopPropagation(); app.ctxGroup('${name}')"><svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></div>`;
                                el.onclick = () => ui.setFolder(fullPath); l.appendChild(el);
                            });
                            c.appendChild(l);
                        } else {
                            const g = document.createElement('div'); g.className='grid';
                            folderNames.forEach(name => {
                                const fullPath = root ? root + '/' + name : name;
                                const el = document.createElement('div'); el.className='card';
                                const blob = getRecursiveArt(fullPath); const imgSrc = blob ? URL.createObjectURL(blob) : null;
                                
                                let imgHTML = imgSrc 
                                    ? `<img src="${imgSrc}" class="card-img" loading="lazy">` 
                                    : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center"><svg class="track-icon-filled" style="width:40px;height:40px;opacity:0.3" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg></div>`;
                                
                                // --- ADDED .card-more DIV BELOW ---
                                el.innerHTML = `
                                    <div class="card-img-container">${imgHTML}</div>
                                    <div class="card-info">
                                        <div class="card-text card-title">${name}</div>
                                        <div class="card-text card-sub">${subFolders[name].length} tracks</div>
                                    </div>
                                    <div class="card-more" onclick="event.stopPropagation(); app.ctxGroup('${name}')">
                                        <svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                                    </div>
                                `;
                                // ----------------------------------
                                
                                el.onclick = () => ui.setFolder(fullPath); g.appendChild(el);
                            });
                            c.appendChild(g);
                        }
                    }
                    if(files.length > 0) { const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 20px'; files.forEach(t => l.appendChild(ui.row(t, files))); c.appendChild(l); }
                    
                } else if(state.tab === 'tracks') {
                    const groups = {}; state.tracks.forEach(t => { const f = t.folder || 'Root'; if (!groups[f]) groups[f] = []; groups[f].push(t); });
                    const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 20px';
                    Object.keys(groups).sort().forEach(folder => {
                        const list = groups[folder]; const headerName = formatPathHeader(folder);
                        const gh = document.createElement('div'); gh.className = 'track-group-header';
                        gh.innerHTML = `<div class="group-name" style="white-space:normal; overflow:visible; line-height:1.2;">${headerName}</div><div class="group-ctrls"><button class="group-btn" title="Play All" onclick="player.playQueue(state.tracks.filter(t=>t.folder==='${folder.replace(/'/g,"\\'")}'), 0)"><svg viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="currentColor"></polygon></svg>Play</button><button class="group-btn" title="Shuffle" onclick="player.playShuffle(state.tracks.filter(t=>t.folder==='${folder.replace(/'/g,"\\'")}'))"><svg style="fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg></button></div>`;
                        l.appendChild(gh); list.forEach(t => l.appendChild(ui.row(t, state.tracks)));
                    });
                    c.appendChild(l);
                } else {
                    const groups={}; const k=state.tab.slice(0,-1); 
                    state.tracks.forEach(t=>{ const key=t[k]||t.folder||'Unknown'; if(!groups[key]) groups[key]=[]; groups[key].push(t); });
                    const keys = Object.keys(groups);
                    const mod = state.sortDesc ? -1 : 1;
                    if(state.sortMode === 'count') keys.sort((a,b) => (groups[b].length - groups[a].length) * mod); else keys.sort((a,b) => a.localeCompare(b) * mod);

                    if (state.viewMode === 'list') {
                        const l = document.createElement('div'); l.className='track-list'; l.style.padding='0 20px 20px';
                        const shufEl = document.createElement('div'); shufEl.className='track-row shuffle-row';
                        shufEl.innerHTML = `<div class="t-art" style="background:var(--active-bg-tint); color:var(--active-color);"><svg style="width:24px;height:24px;fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg></div><div class="t-data"><div class="t-title" style="color:var(--active-color);">Shuffle All</div><div class="t-meta" style="color:var(--active-color); opacity:0.7;">${state.tracks.length} Songs</div></div>`;
                        shufEl.onclick = () => { player.playShuffle(state.tracks); ui.closeModals(); };
                        l.appendChild(shufEl);
                        keys.forEach(key => {
                            const track = groups[key][0]; const imgSrc = state.images[track.folder] ? URL.createObjectURL(state.images[track.folder]) : null;
                            let imgHTML = imgSrc ? `<img src="${imgSrc}">` : `<div style="width:100%;height:100%;background:var(--surface-2);display:flex;align-items:center;justify-content:center"><svg class="track-icon-filled" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-12.5c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg></div>`;
                            const el = document.createElement('div'); el.className='track-row';
                            el.innerHTML = `<div class="t-art">${imgHTML}</div><div class="t-data"><div class="t-title">${key}</div><div class="t-meta">${groups[key].length} Songs</div></div><div class="more-btn" onclick="event.stopPropagation(); app.ctxGroup('${key}')"><svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></div>`;
                            el.onclick = () => ui.openGroup(key, groups[key]); l.appendChild(el);
                        });
                        c.appendChild(l);
                    } else {
                        const g = document.createElement('div'); g.className='grid';
                        // 1. Generate Standard Cards
                        keys.forEach(key => {
                            const track = groups[key][0]; 
                            const el = document.createElement('div'); el.className='card';
                            const imgSrc = state.images[track.folder] ? URL.createObjectURL(state.images[track.folder]) : null;
                            
                            let imgHTML = imgSrc 
                                ? `<img src="${imgSrc}" class="card-img" loading="lazy">` 
                                : `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center"><svg class="track-icon-filled" style="width:40px;height:40px;opacity:0.3" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-12.5c-2.48 0-4.5 2.02-4.5 4.5s2.02 4.5 4.5 4.5 4.5-2.02 4.5-4.5-2.02-4.5-4.5-4.5zm0 5.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z"/></svg></div>`;
                            
                            // Updated HTML Structure: Image container top, text below
                            el.innerHTML = `
                                <div class="card-img-container">${imgHTML}</div>
                                <div class="card-info">
                                    <div class="card-text card-title">${key}</div>
                                    <div class="card-text card-sub">${groups[key].length} Songs</div>
                                </div>
                                <div class="card-more" onclick="event.stopPropagation(); app.ctxGroup('${key}')">
                                    <svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
                                </div>
                            `;
                            
                            // Removed the getDominantColor logic here to keep cards transparent/clean like carousel
                            
                            el.onclick = () => ui.openGroup(key, groups[key]); 
                            g.appendChild(el);
                        });

                        // 2. Generate Shuffle Card (Same Dimensions)
                        const shufEl = document.createElement('div'); shufEl.className = 'card shuffle-card';
                        shufEl.innerHTML = `
                            <div class="shuffle-card-inner">
                                <svg style="width:32px;height:32px;fill:none;stroke:#fff;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>
                            </div>
                            <div class="card-info">
                                <div class="card-text card-title" style="color:var(--active-color)">Shuffle All</div>

                            </div>
                        `;
                        shufEl.onclick = () => { player.playShuffle(state.tracks); ui.closeModals(); };
                        g.appendChild(shufEl); 
                        
                        c.appendChild(g);
                    }
                }
            },
            row: (t, ctx) => {
                const el = document.createElement('div'); el.className='track-row';
                el.innerHTML = `<div class="t-art">${ui.getArt(t)}</div><div class="t-data"><div class="t-title">${t.name}</div><div class="t-meta">${t.artist}</div></div><div class="more-btn" onclick="event.stopPropagation(); app.ctxTrack('${t.id}')"><svg class="icon-dots" viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg></div>`;
                el.onclick = () => player.playQueue(ctx, ctx.indexOf(t));
                return el;
            },
            getArt: (t) => {
                if(state.images[t.folder]) return `<img src="${URL.createObjectURL(state.images[t.folder])}">`;
                return `<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;background:var(--surface-2);"><svg class="track-icon-filled" viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg></div>`;
            },
            update: () => {
                const t = player.curr; if(!t) return;
                
                // Update Text
                ['mpTitle','fpTitle'].forEach(i=>document.getElementById(i).textContent=t.name);
                ['mpArtist','fpArtist'].forEach(i=>document.getElementById(i).textContent=t.artist);
                
                // Get Image Source
                const src = state.images[t.folder] ? URL.createObjectURL(state.images[t.folder]) : null;
                
                // --- UPDATE MINI PLAYER ---
                const mpArt = document.getElementById('mpArt');
                if(src) { 
                    mpArt.src = src; 
                    mpArt.style.display = 'block'; 
                } else { 
                    mpArt.style.display = 'none'; 
                }
                
                // --- FIX: UPDATE FULL PLAYER ---
                const fpArt = document.getElementById('fpArt');
                const fpPlaceholder = document.getElementById('fpPlaceholder');

                if(src) {
                    fpArt.src = src;
                    // If Visualizer is OFF (mode 0), ensure Art is visible
                    if(state.visMode === 0) {
                        fpArt.style.opacity = '1';
                        fpPlaceholder.style.opacity = '0';
                    }
                } else {
                    fpArt.src = '';
                    // If no art, ensure placeholder is visible (unless Visualizer is covering it)
                    if(state.visMode === 0) {
                        fpArt.style.opacity = '0';
                        fpPlaceholder.style.opacity = '1';
                    }
                }
                
                // Toggle Mini-Viz (Waves on mini player when no art)
                state.miniVizActive = !src;
                document.getElementById('mpVizCanvas').style.display = state.miniVizActive ? 'block' : 'none';
                
                // Update Play/Pause Buttons
                const mpI = state.playing ? '<path d="M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/>' : '<path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/>';
                const fpI = state.playing ? '<path d="M8 19c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2v10c0 1.1.9 2 2 2zm6-12v10c0 1.1.9 2 2 2s2-.9 2-2V7c0-1.1-.9-2-2-2s-2 .9-2 2z"/>' : '<path d="M8 6.82v10.36c0 .79.87 1.27 1.54.84l8.14-5.18c.62-.39.62-1.29 0-1.69L9.54 5.98C8.87 5.55 8 6.03 8 6.82z"/>';
                document.getElementById('mpBtn').innerHTML=`<svg class="mp-icon-filled" viewBox="0 0 24 24">${mpI}</svg>`;
                document.getElementById('fpPlayBtn').innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor" stroke="none">${fpI}</svg>`;
            }
        };

        const app = {
            syncLibrary: () => { if (window.Capacitor) nativeScan(); else triggerFolder(); },
            saveSettings: () => {
                const s = { 
                    theme: document.body.getAttribute('data-theme'), 
                    shuffle: state.shuffle, 
                    repeat: state.repeat, 
                    viewMode: state.viewMode, 
                    sortMode: state.sortMode, 
                    sortDesc: state.sortDesc, 
                    currentFolder: state.currentFolder,
                    loudness: state.loudness // <--- ADD THIS
                };
                localStorage.setItem('naadSettings', JSON.stringify(s));
            },
            toggleNorm: () => {
                state.loudness = !state.loudness;
                updateNormUI();
                app.saveSettings();
                
                // Apply immediately if playing
                if(viz.ctx) viz.applyLoudness();
            },
            toggleTheme: () => { const b = document.body; b.setAttribute('data-theme', b.getAttribute('data-theme')==='light'?'dark':'light'); updateStatusBarColor(); app.saveSettings(); },
            toggleView: () => { 
                state.viewMode = state.viewMode === 'grid' ? 'list' : 'grid'; 
                app.saveSettings(); 
                ui.updateViewBtn(); 
                ui.render(null, true); 
            },
            showSortMenu: () => {
                const div = document.getElementById('sortOptions');
                let html = ''; 
                
                // 1. Define the Tick Icon (Filled Circle with Check)
                const tickIcon = `<svg style="width:20px;height:20px;fill:var(--active-color);flex-shrink:0;display:block;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 12l3 3 5-5" style="fill:none;stroke:#fff;stroke-width:2;stroke-linecap:round;stroke-linejoin:round"/></svg>`;
                
                const activeStyle = 'style="color:var(--active-color); font-weight:700"';
                const arrow = state.sortDesc ? ' ↓' : ' ↑';
                
                // 2. Helper to build the button content
                const renderBtn = (mode, label) => {
                    const isActive = state.sortMode === mode;
                    const style = isActive ? activeStyle : '';
                    // Text includes arrow if active
                    const text = isActive ? label + arrow : label; 
                    // Icon is added if active
                    const icon = isActive ? tickIcon : ''; 
                    
                    return `<button class="list-opt" onclick="app.sortTracks('${mode}')" ${style}>
                                <span>${text}</span>
                                ${icon}
                            </button>`;
                };

                // 3. Logic to show relevant sort options based on current View
                if (state.tab === 'tracks' || state.viewGroup || (state.tab === 'folders' && state.currentFolder)) {
                    html += renderBtn('id', 'Track ID');
                    html += renderBtn('name', 'Name');
                    html += renderBtn('date', 'Release Date');
                    html += renderBtn('size', 'Size');
                    html += renderBtn('artist', 'Artist');
                } 
                else if (state.tab === 'folders' && !state.currentFolder) {
                    html += renderBtn('name', 'Name');
                    html += renderBtn('date', 'Release Date');
                    html += renderBtn('count', 'Item Count');
                    html += renderBtn('artist', 'Artist');
                    html += renderBtn('size', 'Size');
                } 
                else {
                    html += renderBtn('name', 'Name');
                    html += renderBtn('count', 'Item Count');
                }
                
                div.innerHTML = html; 
                document.getElementById('sortModal').classList.add('open');
            },
            // UPDATED: Toggle Sort Direction
            sortTracks: (mode) => {
                if (state.sortMode === mode) {
                    state.sortDesc = !state.sortDesc;
                } else {
                    state.sortMode = mode;
                    state.sortDesc = false; 
                }
                const mod = state.sortDesc ? -1 : 1;

                // Define sort logic function to reuse
                const performSort = (arr) => {
                    if(mode === 'name') arr.sort((a,b) => a.name.localeCompare(b.name) * mod);
                    else if(mode === 'date') arr.sort((a,b) => (a.added - b.added) * mod); 
                    else if(mode === 'artist') arr.sort((a,b) => (a.artist||'').localeCompare(b.artist||'') * mod);
                    else if(mode === 'id') arr.sort((a,b) => a.id.localeCompare(b.id) * mod);
                    else if(mode === 'size') arr.sort((a,b) => (getTrackSize(a) - getTrackSize(b)) * mod);
                };

                // Always sort the main library
                performSort(state.tracks);
                
                // If currently viewing a specific group (Album/Artist list), sort that specific list too
                if(state.viewGroup && state.viewGroup.list) {
                    performSort(state.viewGroup.list);
                }

                app.saveSettings(); ui.render(null, true); ui.closeModals();
            },
            ctxTrack: (id) => {
                const t = state.tracks.find(x=>x.id===id);
                document.getElementById('ctxContent').innerHTML = `<div class="list-opt" onclick="player.playQueue([state.tracks.find(x=>x.id='${id}')], 0); ui.closeModals()"><svg class="ctx-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Play Now</div><div class="list-opt" onclick="player.addOne('${id}'); ui.closeModals()"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/></svg>Add to Queue</div><div class="list-opt" onclick="app.edit('${id}')"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit Details</div><div class="list-opt danger" onclick="app.del('${id}')"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Delete</div>`;
                document.getElementById('ctxTitle').textContent = t.name; document.getElementById('contextMenu').classList.add('open');
            },
            ctxGroup: (name) => {
                 document.getElementById('ctxTitle').textContent = name;
                 
                 // Generate standard buttons
                 let html = `<div class="list-opt" onclick="ui.closeModals(); ui.openGroup('${name}', state.tracks.filter(t=>(t.album==='${name}'||t.artist==='${name}'||t.folder==='${name}'||t.folder.endsWith('/'+name))))"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M20 6h-8l-2-2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2z"/></svg>Open</div><div class="list-opt" onclick="ui.closeModals(); player.playQueue(state.tracks.filter(t=>(t.album==='${name}'||t.artist==='${name}'||t.folder==='${name}'||t.folder.endsWith('/'+name))), 0)"><svg class="ctx-icon" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>Play All</div><div class="list-opt" onclick="ui.closeModals(); player.playShuffle(state.tracks.filter(t=>(t.album==='${name}'||t.artist==='${name}'||t.folder==='${name}'||t.folder.endsWith('/'+name))), 0)"><svg class="ctx-icon" style="fill:none;stroke:currentColor;stroke-width:2" viewBox="0 0 24 24"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/><path d="M4 4l5 5"/></svg>Shuffle</div>`;
                 
                 // NEW: If in Folder View, add Edit Option
                 if(state.tab === 'folders') {
                     // We escape the name to handle folders with quotes
                     const escName = name.replace(/'/g, "\\'");
                     html += `<div class="list-opt" onclick="app.editFolder('${escName}')"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>Edit Metadata</div>`;
                 }
                 
                 html += `<div class="list-opt danger" onclick="app.removeGroup('${name}')"><svg class="ctx-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Remove</div>`;
                 
                 document.getElementById('ctxContent').innerHTML = html;
                 document.getElementById('contextMenu').classList.add('open');
            },

            edit: (id) => { 
                ui.closeModals(); 
                const t = state.tracks.find(x=>x.id===id); 
                document.getElementById('editId').value = id; 
                
                // Ensure Title input is visible (in case Folder Edit hid it)
                document.getElementById('editTitle').parentElement.style.display = 'block';
                
                document.getElementById('editTitle').value = t.name; 
                document.getElementById('editArtist').value = t.artist; 
                document.getElementById('editAlbum').value = t.album; 
                document.getElementById('editModal').classList.add('open'); 
            },

            saveEdit: async () => { 
                const idVal = document.getElementById('editId').value;
                const newArtist = document.getElementById('editArtist').value;
                const newAlbum = document.getElementById('editAlbum').value;
                
                // CHECK IF THIS IS A FOLDER EDIT
                if (idVal.startsWith('FOLDER:')) {
                    const folderName = idVal.substring(7); // Remove "FOLDER:" prefix
                    
                    // Filter all tracks belonging to this folder
                    const tracksToUpdate = state.tracks.filter(t => t.folder === folderName || t.folder.endsWith('/' + folderName));
                    
                    const tx = db.transaction(STORE_TRACKS, 'readwrite');
                    const store = tx.objectStore(STORE_TRACKS);
                    
                    tracksToUpdate.forEach(t => {
                        t.artist = newArtist;
                        t.album = newAlbum;
                        store.put(t); // Update DB
                    });
                } 
                // STANDARD SINGLE TRACK EDIT
                else {
                    const t = state.tracks.find(x => x.id === idVal);
                    t.name = document.getElementById('editTitle').value; 
                    t.artist = newArtist; 
                    t.album = newAlbum; 
                    await put(STORE_TRACKS, t); 
                }
                
                ui.closeModals(); 
                ui.render(null, true); // Force Refresh UI
                ui.update(); 
            },


            editFolder: (name) => { 
                ui.closeModals(); 
                
                // Use a special prefix "FOLDER:" to tell the save function this is a batch edit
                document.getElementById('editId').value = "FOLDER:" + name; 
                
                // Hide Title Input (Batch edit shouldn't change titles)
                document.getElementById('editTitle').parentElement.style.display = 'none';
                
                // Find a track in this folder to pre-fill the current Artist/Album
                const t = state.tracks.find(x => x.folder === name || x.folder.endsWith('/' + name));
                
                document.getElementById('editArtist').value = t ? t.artist : ''; 
                document.getElementById('editAlbum').value = t ? t.album : ''; 
                
                document.getElementById('editModal').classList.add('open'); 
            },

            del: async (id) => { 
                if(confirm('Delete?')) { 
                    // 1. Remove from Main Library State
                    state.tracks = state.tracks.filter(t => t.id !== id); 
                    
                    // 2. Remove from Current Group/Folder View if active
                    // (This ensures it disappears immediately if you are inside an Album or Folder)
                    if (state.viewGroup && state.viewGroup.list) {
                        state.viewGroup.list = state.viewGroup.list.filter(t => t.id !== id);
                    }
                    
                    // 3. Remove from IndexedDB
                    const tx = db.transaction(STORE_TRACKS, 'readwrite');
                    tx.objectStore(STORE_TRACKS).delete(id);
                    
                    ui.closeModals(); 
                    
                    // 4. Force Render (The 'true' flag is critical)
                    ui.render(null, true); 
                } 
            },

            removeGroup: async (name) => { 
                if(confirm(`Remove all tracks in "${name}" from library?`)) { 
                    // Filter tracks to remove
                    const toRemove = state.tracks.filter(t => t.album === name || t.artist === name || t.folder === name || t.folder === state.currentFolder + '/' + name); 
                    
                    if (toRemove.length > 0) { 
                        // Update State
                        state.tracks = state.tracks.filter(t => !toRemove.includes(t)); 
                        
                        // Update Database
                        const tx = db.transaction(STORE_TRACKS, 'readwrite'); 
                        toRemove.forEach(t => tx.objectStore(STORE_TRACKS).delete(t.id)); 
                    } 
                    
                    ui.closeModals(); 
                    
                    // CRITICAL FIX: Added 'null, true' to force the UI to refresh
                    ui.render(null, true); 
                } 
            },

            reset: () => { if(confirm("Clear All?")) { indexedDB.deleteDatabase(DB_NAME); location.reload(); } },
            openSearch: () => { document.getElementById('searchInput').value = ''; document.getElementById('searchResults').innerHTML = ''; document.getElementById('searchModal').classList.add('open'); setTimeout(() => document.getElementById('searchInput').focus(), 100); },
            
            // --- NEW NAVIGATION FUNCTIONS ---
            goToCurrentArtist: () => {
                const t = player.curr;
                if(!t || !t.artist) return;
                
                ui.closePlayer(); // 1. Close the player overlay
                
                // 2. Wait 300ms for animation to clear, then switch tab
                setTimeout(() => {
                    ui.setTab('artists');
                    const list = state.tracks.filter(x => x.artist === t.artist);
                    ui.openGroup(t.artist, list);
                }, 300);
            },

            goToCurrentAlbum: () => {
                const t = player.curr;
                if(!t || !t.album) return;
                
                ui.closePlayer(); // 1. Close the player overlay
                
                // 2. Wait 300ms for animation to clear, then switch tab
                setTimeout(() => {
                    ui.setTab('albums');
                    const list = state.tracks.filter(x => x.album === t.album);
                    ui.openGroup(t.album, list);
                }, 300);
            },
            // --------------------------------
            
            
            
            
            // UPDATED: Search sorts by Category then Tracks
            // UPDATED: Search now switches tabs before opening content
            performSearch: (q) => {
                const c = document.getElementById('searchResults'); c.innerHTML=''; if(!q) return;
                const low = q.toLowerCase();
                
                const matchedFolders = new Set();
                const matchedArtists = new Set();
                const matchedAlbums = new Set();
                const matchedTracks = [];

                state.tracks.forEach(t => {
                    if (t.folder && t.folder.toLowerCase().includes(low)) matchedFolders.add(t.folder);
                    if (t.artist && t.artist.toLowerCase().includes(low)) matchedArtists.add(t.artist);
                    if (t.album && t.album.toLowerCase().includes(low)) matchedAlbums.add(t.album);
                    if (t.name.toLowerCase().includes(low)) matchedTracks.push(t);
                });

                const createGroupRow = (name, type, icon) => {
                    const el = document.createElement('div'); el.className='track-row'; el.style.borderBottom='1px solid var(--border)';
                    el.innerHTML = `<div class="t-art" style="width:40px;height:40px;background:var(--surface-2);color:var(--text-sub);display:flex;align-items:center;justify-content:center;">${icon}</div><div class="t-data"><div class="t-title" style="font-size:14px;">${name}</div><div class="t-meta">${type}</div></div>`;
                    return el;
                };

                matchedFolders.forEach(f => {
                    const el = createGroupRow(f.split('/').pop(), 'Folder', '<svg style="width:20px;height:20px;fill:currentColor" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>');
                    // CHANGE: Switch to folders tab first
                    el.onclick = () => { 
                        ui.closeModals(); 
                        ui.setTab('folders'); 
                        ui.setFolder(f); 
                    };
                    c.appendChild(el);
                });

                matchedArtists.forEach(a => {
                    const el = createGroupRow(a, 'Artist', '<svg style="width:20px;height:20px;fill:currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>');
                    // CHANGE: Switch to artists tab first
                    el.onclick = () => { 
                        ui.closeModals(); 
                        ui.setTab('artists'); 
                        ui.openGroup(a, state.tracks.filter(t=>t.artist===a)); 
                    };
                    c.appendChild(el);
                });

                matchedAlbums.forEach(a => {
                    const el = createGroupRow(a, 'Album', '<svg style="width:20px;height:20px;fill:currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 14.5c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-5.5c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1z"/></svg>');
                    // CHANGE: Switch to albums tab first
                    el.onclick = () => { 
                        ui.closeModals(); 
                        ui.setTab('albums'); 
                        ui.openGroup(a, state.tracks.filter(t=>t.album===a)); 
                    };
                    c.appendChild(el);
                });

                matchedTracks.slice(0, 50).forEach(t => { 
                    const el = document.createElement('div'); el.className='track-row'; el.style.borderBottom='1px solid var(--border)'; 
                    el.innerHTML = `<div class="t-art" style="width:40px;height:40px;">${ui.getArt(t)}</div><div class="t-data"><div class="t-title" style="font-size:14px;">${t.name}</div><div class="t-meta">${t.artist}</div></div>`; 
                    el.onclick = () => { 
                        ui.closeModals(); 
                        // 1. Find similar tracks (Same Artist OR Same Album), excluding the clicked one
                        const similar = state.tracks.filter(x => 
                            x.id !== t.id && ( 
                                (t.artist !== 'Unknown' && x.artist === t.artist) || 
                                (t.album !== 'Unknown' && x.album === t.album)
                            )
                        );

                        // 2. Create queue: Selected track FIRST, followed by similar tracks
                        const newQueue = [t, ...similar];

                        // 3. Play the queue starting at index 0 (the selected track)
                        player.playQueue(newQueue, 0); 
                    }; 
                    // -----------------------------
                    c.appendChild(el); 
                });
                if(c.children.length===0) c.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-sub); font-size:12px;">No results found</div>';
            }
        };

        const audio = new Audio();
        
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        
        // --- MEDIA SESSION UPDATER ---
        function updateMediaSession() {
            if (!('mediaSession' in navigator)) return;
            const t = player.curr;
            if (!t) return;
            
            // Artwork logic
            let artwork = [];
            const src = state.images[t.folder] ? URL.createObjectURL(state.images[t.folder]) : null;
            if (src) {
                artwork = [
                    { src: src, sizes: '96x96', type: 'image/png' },
                    { src: src, sizes: '128x128', type: 'image/png' },
                    { src: src, sizes: '192x192', type: 'image/png' },
                    { src: src, sizes: '512x512', type: 'image/png' }
                ];
            }

            navigator.mediaSession.metadata = new MediaMetadata({
                title: t.name,
                artist: t.artist || 'Unknown Artist',
                album: t.album || 'Unknown Album',
                artwork: artwork
            });

            navigator.mediaSession.playbackState = state.playing ? 'playing' : 'paused';
        }

        const player = {
            curr: null,
            
            playQueue: (list, idx) => {
                state.queue = [...list];
                state.qIdx = idx;
                if (state.shuffle) player.shuffleQ();
                player.load();

                // ADD THIS LINE
                ui.openPlayer();
            },

            playShuffle: (list) => {
                state.shuffle = true;
                document.getElementById('btnShuf').classList.add('active');
                app.saveSettings();
                let shuffList = [...list];
                shuffleArray(shuffList);
                player.playQueue(shuffList, 0);
            },

            addOne: (id) => {
                const t = state.tracks.find(x => x.id === id);
                state.queue.push(t);
                if (state.queue.length === 1) player.playQueue([t], 0);
            },

            removeOne: (idx) => {
                state.queue.splice(idx, 1);
                if (idx < state.qIdx) state.qIdx--;
                if (idx === state.qIdx) player.load();
                player.renderQueue();
            },

            load: async () => {
                if (state.queue.length === 0) return;
                if (state.qIdx >= state.queue.length) state.qIdx = 0;
                const t = state.queue[state.qIdx];

                // --- ADD PLAY COUNT LOGIC HERE ---
                t.plays = (t.plays || 0) + 1;
                t.lastPlayed = Date.now(); // Store timestamp
                put(STORE_TRACKS, t); // Update DB
                // ---------------------------------

                player.curr = t;

                // --- UNIFIED PLAYBACK (Web & Android) ---
                // We use standard Audio object everywhere. 
                // Capacitor converts file:// URI to a local server URL automatically via convertFileSrc used in scanDir
                if (t.url) audio.src = t.url; 
                else if (t.blob) audio.src = URL.createObjectURL(t.blob);
                else audio.src = '';
                
                try {
                    await audio.play();
                    state.playing = true;
                } catch(e) {
                    console.error("Playback failed", e);
                    state.playing = false;
                }
                
                player.positionLoop();
                ui.update();
                updateMediaSession(); 
                updateNativeNotification(); // Update persistent notification
                
                document.getElementById('miniPlayer').classList.add('visible');
                viz.start();
                player.renderQueue();
            },

            toggle: async () => {
                if (audio.paused) { 
                    audio.play(); 
                    state.playing = true; 
                } else { 
                    audio.pause(); 
                    state.playing = false; 
                }
                ui.update();
                updateMediaSession();
                updateNativeNotification(); // Update persistent notification
            },

            next: () => {
                let n = state.qIdx + 1;
                if (n >= state.queue.length) n = 0;
                state.qIdx = n;
                player.load();
            },

            prev: () => {
                let n = state.qIdx - 1;
                if (n < 0) n = state.queue.length - 1;
                state.qIdx = n;
                player.load();
            },

            toggleShuffle: () => {
                state.shuffle = !state.shuffle;
                document.getElementById('btnShuf').classList.toggle('active', state.shuffle);
                app.saveSettings();
                if (state.shuffle) player.shuffleQ();
            },

            shuffleQ: () => {
                if (state.queue.length <= 1) return;
                const current = state.queue[state.qIdx];
                let others = state.queue.filter((_, i) => i !== state.qIdx);
                shuffleArray(others);
                state.queue = [current, ...others];
                state.qIdx = 0;
                player.renderQueue();
            },

            toggleRepeat: () => {
                state.repeat = (state.repeat + 1) % 3;
                document.getElementById('btnRep').classList.toggle('active', state.repeat > 0);
                app.saveSettings();
            },

            toggleQueue: () => {
                const q = document.getElementById('queueSheet');
                const bd = document.getElementById('queueBackdrop'); // Select the backdrop
                
                q.classList.toggle('open');
                bd.classList.toggle('open'); // Toggle backdrop visibility
                
                if (q.classList.contains('open')) player.renderQueue();
            },

            renderQueue: () => {
                const c = document.getElementById('qList');
                c.innerHTML = '';
                
                state.queue.forEach((t, i) => {
                    const d = document.createElement('div');
                    const isActive = i === state.qIdx;
                    
                    // Generate label (Structure is simpler now)
                    const label = isActive ? `<span class="np-tag">Now Playing</span>` : '';
                    
                    d.className = `q-item ${isActive ? 'active' : ''}`;
                    
                    d.innerHTML = `
                        <div class="q-icon">
                            <svg viewBox="0 0 24 24"><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>
                        </div>
                        
                        <div style="flex:1; min-width:0; display:flex; flex-direction:column; margin-right:4px;">
                            <div style="font-weight:500; font-size:14px; line-height:1.3; word-break:break-word;">
                                ${t.name}
                            </div>
                            <div style="font-size:12px; opacity:0.6; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                ${t.artist}
                            </div>
                        </div>
                        
                        ${label}
                        
                        <div class="q-remove" onclick="player.removeOne(${i})">
                            <svg style="width:18px;height:18px"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                        </div>`;
                        
                    d.onclick = (e) => {
                        if (!e.target.closest('.q-remove')) {
                            state.qIdx = i;
                            player.load();
                        }
                    };
                    c.appendChild(d);
                });
                
                const active = c.children[state.qIdx];
                if (active) setTimeout(() => active.scrollIntoView({ block: 'start', behavior: 'smooth' }), 10);
            },
    
            positionLoop: () => {
                if (state.playing) {
                    requestAnimationFrame(player.positionLoop);
                }
            }
        };
        
        // Standard Web Audio Events
        audio.ontimeupdate = () => { 
            if(state.scrubbing) return; // Stop updates while dragging
            const pct = (audio.currentTime/audio.duration)*100||0; 
            document.getElementById('fpFill').style.width=pct+'%'; 
            document.getElementById('mpFill').style.width=pct+'%'; 
            document.getElementById('tCurr').innerText = fmt(audio.currentTime); 
            document.getElementById('tDur').innerText = fmt(audio.duration||0); 
        };
        
        audio.onended = () => { 
            if (state.repeat === 2) { 
                audio.currentTime = 0; audio.play(); 
            } else if (state.qIdx < state.queue.length - 1) { 
                player.next(); 
            } else { 
                if (state.repeat === 1) { player.next(); } 
                else { state.playing = false; ui.update(); updateMediaSession(); updateNativeNotification(); } 
            } 
        };
        
        audio.onplay = () => { state.playing = true; ui.update(); updateMediaSession(); updateNativeNotification(); };
        audio.onpause = () => { state.playing = false; ui.update(); updateMediaSession(); updateNativeNotification(); };

        const scrubber = document.getElementById('scrubber');

        // Prevent the swipe-to-close logic (on parent #fullPlayer) from firing
        const stopTouch = (e) => e.stopPropagation();
        scrubber.addEventListener('touchstart', stopTouch, {passive: true});
        scrubber.addEventListener('touchend', stopTouch, {passive: true});

        const handleScrub = (e) => {
            const r = scrubber.getBoundingClientRect();
            let x = e.clientX;
            // Keep logic within bounds even if finger slides off
            if (x < r.left) x = r.left;
            if (x > r.right) x = r.right;
            
            const pct = (x - r.left) / r.width;
            
            // Visually update bar and time immediately
            document.getElementById('fpFill').style.width = (pct * 100) + '%';
            const targetTime = pct * (audio.duration || 0);
            document.getElementById('tCurr').innerText = fmt(targetTime);
            return targetTime;
        };

        scrubber.onpointerdown = (e) => {
            state.scrubbing = true;
            scrubber.setPointerCapture(e.pointerId); // Capture drag even if finger leaves element
            handleScrub(e);
        };

        scrubber.onpointermove = (e) => {
            if (state.scrubbing) handleScrub(e);
        };

        scrubber.onpointerup = (e) => {
            if (state.scrubbing) {
                const t = handleScrub(e);
                if (isFinite(t)) audio.currentTime = t;
                state.scrubbing = false;
                scrubber.releasePointerCapture(e.pointerId);
            }
        };

        scrubber.onpointercancel = () => { state.scrubbing = false; };
        
        function fmt(s){const m=Math.floor(s/60),sec=Math.floor(s%60); return `${m}:${sec<10?'0':''}${sec}`;}

        const viz = {
            ctx: null, an: null, src: null, cvs: null, cCtx: null, id: null,
            mpCvs: null, mpCtx: null,
            particles: [],
            lastBass: 0,
            pulseOffset: 0, 
            gainNode: null,
            compressor: null,
            
            setup: () => { 
                if (!state.visMode) state.visMode = 2;

                viz.cvs = document.getElementById('vizCanvas'); 
                viz.cCtx = viz.cvs.getContext('2d');
                viz.cvs.style.background = 'transparent'; 

                for(let i=0; i<40; i++) {
                    viz.particles.push({
                        x: Math.random(), y: Math.random(),
                        dx: (Math.random()-0.5)*0.001, 
                        dy: (Math.random()-0.5)*0.001,
                        r: Math.random()*2 + 1.5
                    });
                }

                viz.mpCvs = document.getElementById('mpVizCanvas');
                viz.mpCtx = viz.mpCvs.getContext('2d');
            },

            toggle: () => {
                const hasArt = player.curr && state.images[player.curr.folder];
                if (hasArt) {
                    state.visMode = (state.visMode + 1) % 5;
                } else {
                    state.visMode = state.visMode === 1 ? 2 : (state.visMode === 2 ? 3 : (state.visMode === 3 ? 4 : 1));
                }
                
                app.saveSettings();

                const c = document.getElementById('vizCanvas'); 
                const i = document.getElementById('fpArt');
                const p = document.getElementById('fpPlaceholder');
                const frame = document.querySelector('.fp-art-frame');

                if (frame) {
                    if (state.visMode === 4) {
                        frame.style.background = 'transparent';
                        frame.style.boxShadow = 'none';
                        frame.style.border = 'none';
                    } else {
                        frame.style.background = ''; 
                        frame.style.boxShadow = '';
                        frame.style.border = '';
                    }
                }
                c.style.background = 'transparent';

                if(state.visMode > 0) { 
                    c.style.display='block'; 
                    i.style.opacity='0'; 
                    p.style.opacity='0'; 
                    viz.start(); 
                } else { 
                    c.style.display='none'; 
                    i.style.opacity='1'; 
                    p.style.opacity='1'; 
                    viz.stop(); 
                }
            },
            
            start: () => {
                if(viz.ctx && viz.ctx.state === 'suspended') viz.ctx.resume();

                if(!viz.ctx) {
                    const AC = window.AudioContext||window.webkitAudioContext;
                    viz.ctx = new AC(); 
                    viz.an=viz.ctx.createAnalyser(); 
                    viz.an.fftSize=256;

                    viz.gainNode = viz.ctx.createGain();
                    viz.compressor = viz.ctx.createDynamicsCompressor();
                    
                    viz.compressor.threshold.value = -24;
                    viz.compressor.knee.value = 30;
                    viz.compressor.ratio.value = 12;
                    viz.compressor.attack.value = 0.003;
                    viz.compressor.release.value = 0.25;

                    try { 
                        viz.src=viz.ctx.createMediaElementSource(audio); 
                        viz.src.connect(viz.an);
                        viz.an.connect(viz.gainNode);
                        viz.gainNode.connect(viz.compressor);
                        viz.compressor.connect(viz.ctx.destination);
                        viz.applyLoudness();
                    } catch(e) { console.error(e);}
                }
                
                if(state.visMode === 4) {
                    const frame = document.querySelector('.fp-art-frame');
                    if(frame) {
                        frame.style.background = 'transparent';
                        frame.style.boxShadow = 'none';
                        frame.style.border = 'none';
                    }
                }

                if(state.visMode > 0 || document.getElementById('miniPlayer').classList.contains('visible')) viz.loop();
            },
            
            applyLoudness: () => {
                if(!viz.gainNode || !viz.compressor) return;
                const t = viz.ctx.currentTime;
                if (state.loudness) {
                    viz.gainNode.gain.cancelScheduledValues(t);
                    viz.gainNode.gain.setValueAtTime(2.0, t);
                    viz.compressor.threshold.setValueAtTime(-24, t);
                    viz.compressor.ratio.setValueAtTime(12, t);
                } else {
                    viz.gainNode.gain.cancelScheduledValues(t);
                    viz.gainNode.gain.setValueAtTime(1.0, t);
                    viz.compressor.threshold.setValueAtTime(0, t);
                    viz.compressor.ratio.setValueAtTime(1, t);
                }
            },
                    
            stop: () => cancelAnimationFrame(viz.id),
            
            loop: () => {
                viz.id = requestAnimationFrame(viz.loop);
                if(!viz.an) return;
                
                const buf = new Uint8Array(viz.an.frequencyBinCount); 
                viz.an.getByteFrequencyData(buf);
                let bass = 0; for(let i=0; i<10; i++) bass += buf[i]; bass /= 10;
                let treble = 0; for(let i=100; i<150; i++) treble += buf[i]; treble /= 50;
                
                viz.lastBass += (bass - viz.lastBass) * 0.1;
                const smoothBass = viz.lastBass;

                viz.particles.forEach(p => {
                    const speedMult = 1 + (smoothBass / 80);
                    p.x += p.dx * speedMult; 
                    p.y += p.dy * speedMult;
                    if(p.x < 0) p.x = 1; if(p.x > 1) p.x = 0; 
                    if(p.y < 0) p.y = 1; if(p.y > 1) p.y = 0;
                });

                viz.pulseOffset += 0.02;
                const idlePulse = Math.sin(viz.pulseOffset) * 0.1; 
                const hue = (performance.now() * 0.01) % 360;
                
                const mpBg = document.getElementById('mpBg');
                if(mpBg) {
                    mpBg.style.opacity = 0.1 + (bass/255)*0.4;
                    mpBg.style.background = `linear-gradient(135deg, hsla(${hue},60%,50%,0.5), transparent)`;
                }

                if(state.visMode > 0) {
                    const w = viz.cvs.width = viz.cvs.offsetWidth; 
                    const h = viz.cvs.height = viz.cvs.offsetHeight;
                    const cx = w / 2, cy = h / 2;
                    const ctx = viz.cCtx;
                    
                    // MODE 1: Radial Naad
                    if (state.visMode === 1) {
                        const g = ctx.createRadialGradient(cx, cy, 10, cx, cy, w);
                        const bgL = 5 + (bass/255)*10;
                        g.addColorStop(0, `hsla(${hue}, 50%, ${20+bgL}%, 1)`);
                        g.addColorStop(1, `hsla(${hue+40}, 60%, 5%, 1)`);
                        ctx.fillStyle = g; ctx.fillRect(0, 0, w, h);

                        if(treble > 40) {
                            ctx.fillStyle = '#FFF';
                            for(let i=0; i<4; i++) {
                                const ang = Math.random() * Math.PI * 2;
                                const dist = (100 + (bass*0.6)) + Math.random() * 60;
                                const pSize = Math.random() * 3;
                                ctx.fillRect(cx+Math.cos(ang)*dist, cy+Math.sin(ang)*dist, pSize, pSize);
                            }
                        }

                        const scale = 1 + (bass / 255) * 0.7;
                        ctx.save(); ctx.translate(cx, cy); ctx.scale(scale, scale);
                        ctx.font = 'bold 90px "Tiro Devanagari Hindi"';
                        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        if (bass > 190) {
                            ctx.globalCompositeOperation = 'screen';
                            ctx.fillStyle = '#FF0055'; ctx.fillText('नाद', -6, 0);
                            ctx.fillStyle = '#00CCFF'; ctx.fillText('नाद', 6, 0);
                            ctx.globalCompositeOperation = 'source-over';
                        }
                        ctx.shadowBlur = 30 + (bass/255)*50;
                        ctx.shadowColor = `hsla(${hue}, 90%, 60%, 0.9)`;
                        ctx.fillStyle = '#FFFFFF'; ctx.fillText('नाद', 0, 0);
                        ctx.restore();
                    }
                    
                    // MODE 2: Speaker Cone
                    if (state.visMode === 2) {
                        const bgGrad = ctx.createRadialGradient(cx, cy, w*0.2, cx, cy, w);
                        bgGrad.addColorStop(0, '#1a1a1a');
                        bgGrad.addColorStop(1, '#050505');
                        ctx.fillStyle = bgGrad;
                        ctx.fillRect(0, 0, w, h);

                        const pump = (bass / 255) * 30; 
                        const baseR = Math.min(w, h) * 0.42;

                        ctx.beginPath(); ctx.arc(cx, cy, baseR + 10, 0, Math.PI * 2);
                        const rimGrad = ctx.createLinearGradient(cx - baseR, cy - baseR, cx + baseR, cy + baseR);
                        rimGrad.addColorStop(0, '#444'); rimGrad.addColorStop(0.5, '#222'); rimGrad.addColorStop(1, '#444');
                        ctx.fillStyle = rimGrad; ctx.fill();

                        ctx.beginPath(); ctx.arc(cx, cy, baseR, 0, Math.PI * 2);
                        const surroundGrad = ctx.createRadialGradient(cx, cy, baseR * 0.85, cx, cy, baseR);
                        surroundGrad.addColorStop(0.5, '#111'); surroundGrad.addColorStop(0.75, '#333'); surroundGrad.addColorStop(1, '#000');
                        ctx.fillStyle = surroundGrad; ctx.fill();

                        const coneR = baseR * 0.85 + (pump * 0.1); 
                        ctx.beginPath(); ctx.arc(cx, cy, coneR, 0, Math.PI * 2);
                        const coneGrad = ctx.createRadialGradient(cx, cy, coneR * 0.2, cx, cy, coneR);
                        coneGrad.addColorStop(0, '#222'); coneGrad.addColorStop(1, '#111'); 
                        ctx.fillStyle = coneGrad; ctx.fill();

                        const capR = baseR * 0.35 + (pump * 0.8); 
                        ctx.beginPath(); ctx.arc(cx, cy, capR, 0, Math.PI * 2);
                        const capGrad = ctx.createRadialGradient(cx - capR*0.3, cy - capR*0.3, capR*0.1, cx, cy, capR);
                        capGrad.addColorStop(0, '#444'); capGrad.addColorStop(0.4, '#1a1a1a'); capGrad.addColorStop(1, '#000');
                        ctx.fillStyle = capGrad; ctx.fill();

                        ctx.save(); ctx.translate(cx, cy);
                        const txtScale = 1 + (bass/255) * 0.15;
                        ctx.scale(txtScale, txtScale);
                        ctx.font = 'bold 16px "Tiro Devanagari Hindi"';
                        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        ctx.shadowBlur = 2; ctx.shadowColor = 'rgba(0,0,0,0.8)'; ctx.shadowOffsetX = 2; ctx.shadowOffsetY = 2;
                        ctx.fillStyle = '#B8860B'; ctx.fillText('नाद', 0, 2);
                        ctx.shadowColor = 'transparent'; ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
                        ctx.fillStyle = '#FFD700'; ctx.fillText('नाद', 0, 2);
                        ctx.restore();
                    }

                    // MODE 3: Particles
                    if (state.visMode === 3) {
                        ctx.fillStyle = '#121212'; 
                        ctx.fillRect(0, 0, w, h);
                        ctx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`; 
                        
                        viz.particles.forEach(p => {
                            const r = p.r * 3; 
                            ctx.beginPath(); 
                            ctx.arc(p.x * w, p.y * h, r, 0, Math.PI*2); 
                            ctx.fill();
                        });

                        ctx.save(); ctx.translate(cx, cy);
                        const baseScale = 3 + idlePulse; 
                        const musicScale = (smoothBass / 255) * 1.5;
                        const finalScale = baseScale + musicScale;
                        ctx.scale(finalScale, finalScale);
                        
                        ctx.font = 'bold 30px "Asap", sans-serif'; 
                        ctx.fillStyle = '#FFFFFF';
                        ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                        const glowIntensity = 0.2 + (smoothBass / 255);
                        ctx.shadowBlur = 20 + glowIntensity * 40;
                        ctx.shadowColor = `hsla(${hue}, 80%, 60%, ${0.6 + glowIntensity * 0.4})`;
                        ctx.fillText('नाद', 0, 2); 
                        ctx.restore();
                    }

                    // --- MODE 4: LP (DOT + LIGHT REFLECTION) ---
                    if (state.visMode === 4) {
                        const frame = document.querySelector('.fp-art-frame');
                        if (frame && frame.style.background !== 'transparent') {
                            frame.style.background = 'transparent';
                            frame.style.boxShadow = 'none';
                            frame.style.border = 'none';
                        }
                        
                        ctx.clearRect(0, 0, w, h);
                        const recordR = Math.min(w, h) * 0.38;
                        const labelR = recordR * 0.35;
                        const spin = (performance.now() * 0.001) + (state.playing ? (performance.now()/1000 * 2.0) : 0);
                        
                        ctx.save();
                        ctx.translate(cx, cy);
                        
                        // Shadow
                        ctx.shadowColor = 'rgba(0,0,0,0.4)';
                        ctx.shadowBlur = 20; 
                        ctx.shadowOffsetY = 10;
                        
                        ctx.rotate(spin);
                        ctx.beginPath();
                        ctx.arc(0, 0, recordR, 0, Math.PI*2);
                        
                        // Check Theme for Contrast
                        const isDark = document.body.getAttribute('data-theme') === 'dark';
                        
                        // Dark Mode: Use Dark Gray (#222) to stand out against black background
                        // Light Mode: Use Pitch Black (#050505)
                        ctx.fillStyle = isDark ? '#222222' : '#050505'; 
                        ctx.fill();

                        // Optional: Add a subtle border in dark mode for better definition
                        if(isDark) {
                            ctx.strokeStyle = '#333333';
                            ctx.lineWidth = 1.5;
                            ctx.stroke();
                        }
                        
                        ctx.shadowColor = 'transparent';
                        ctx.shadowBlur = 0;
                        ctx.shadowOffsetY = 0;

                        ctx.strokeStyle = 'rgba(255,255,255,0.04)';
                        ctx.lineWidth = 1.5;
                        ctx.beginPath();
                        for(let r = labelR + 5; r < recordR - 2; r += 3.5) {
                            ctx.moveTo(r, 0); ctx.arc(0, 0, r, 0, Math.PI*2);
                        }
                        ctx.stroke();

                        // Label
                        ctx.beginPath();
                        ctx.arc(0, 0, labelR, 0, Math.PI*2);
                        const lblGrad = ctx.createLinearGradient(-labelR, -labelR, labelR, labelR);
                        lblGrad.addColorStop(0, `hsl(${hue}, 40%, 60%)`);
                        lblGrad.addColorStop(1, `hsl(${hue}, 40%, 30%)`);
                        ctx.fillStyle = lblGrad;
                        ctx.fill();
                        
                        // --- ORIENTATION DOT ---
                        ctx.beginPath();
                        ctx.arc(labelR * 0.65, 0, 3, 0, Math.PI*2); 
                        ctx.fillStyle = 'rgba(255,255,255,0.6)';
                        ctx.fill();
                        // -----------------------

                        // Inner Ring
                        ctx.beginPath(); ctx.arc(0, 0, 4, 0, Math.PI*2);
                        ctx.fillStyle = '#000'; ctx.fill();
                        ctx.strokeStyle = 'rgba(0,0,0,0.2)';
                        ctx.lineWidth = 1;
                        ctx.beginPath(); ctx.arc(0,0, labelR*0.9, 0, Math.PI*2); ctx.stroke();

                        // --- LIGHT EFFECTS (SHEEN) ---
                        // Counter-rotate so light stays fixed
                        ctx.save();
                        ctx.rotate(-spin - 0.8);
                        
                        const sheenGrad = ctx.createLinearGradient(-recordR, -recordR, recordR, recordR);
                        sheenGrad.addColorStop(0, 'transparent');
                        sheenGrad.addColorStop(0.4, 'transparent');
                        // Brightness bumps slightly with treble
                        const shineOp = 0.08 + (treble/255)*0.2;
                        sheenGrad.addColorStop(0.5, `rgba(255,255,255,${shineOp})`);
                        sheenGrad.addColorStop(0.6, 'transparent');
                        sheenGrad.addColorStop(1, 'transparent');
                        
                        ctx.fillStyle = sheenGrad;
                        // Top Wedge
                        ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0, recordR, Math.PI * 1.2, Math.PI * 1.8); ctx.fill();
                        // Bottom Wedge
                        ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0, recordR, Math.PI * 0.2, Math.PI * 0.8); ctx.fill();
                        ctx.restore(); 
                        
                        ctx.restore(); // End Disc

                        // Spindle Pin
                        ctx.save(); ctx.translate(cx, cy);
                        const spinGrad = ctx.createRadialGradient(-2,-2, 0, 0,0, 4);
                        spinGrad.addColorStop(0, '#fff'); spinGrad.addColorStop(1, '#555');
                        ctx.fillStyle = spinGrad;
                        ctx.beginPath(); ctx.arc(0,0, 3.5, 0, Math.PI*2); ctx.fill();
                        ctx.restore();

                        // Tone Arm
                        const armPivotX = w * 0.88; 
                        const armPivotY = h * 0.12;
                        const armLength = Math.min(w,h) * 0.58;
                        const dx = cx - armPivotX; const dy = cy - armPivotY;
                        const playProgress = (audio.currentTime / (audio.duration || 1)) || 0;
                        const armAngle = Math.atan2(dy, dx) - 0.28 + (playProgress * 0.22);

                        ctx.save();
                        ctx.translate(armPivotX, armPivotY);
                        ctx.rotate(armAngle);
                        ctx.shadowColor = 'rgba(0,0,0,0.3)';
                        ctx.shadowBlur = 15; ctx.shadowOffsetY = 15; ctx.shadowOffsetX = 5;

                        const armW = 8;
                        const chromeGrad = ctx.createLinearGradient(0, -armW/2, 0, armW/2);
                        chromeGrad.addColorStop(0, '#555'); chromeGrad.addColorStop(0.3, '#fff'); chromeGrad.addColorStop(0.7, '#ccc'); chromeGrad.addColorStop(1, '#444');
                        ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(armLength, 0); ctx.lineTo(armLength + 18, 8); 
                        ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.lineWidth = armW; ctx.strokeStyle = chromeGrad; ctx.stroke();

                        ctx.shadowBlur = 5; 
                        ctx.beginPath(); ctx.translate(armLength + 18, 8); ctx.rotate(0.32);
                        ctx.rect(-5, -6, 28, 12); ctx.fillStyle = '#111'; ctx.fill();
                        
                        ctx.beginPath(); ctx.moveTo(22, 0); ctx.bezierCurveTo(30, 0, 30, -12, 34, -10);
                        ctx.lineWidth = 2; ctx.strokeStyle = '#ddd'; ctx.stroke();
                        ctx.restore(); 

                        // Pivot
                        ctx.save(); ctx.translate(armPivotX, armPivotY);
                        ctx.shadowColor = 'rgba(0,0,0,0.4)'; ctx.shadowBlur = 10; ctx.shadowOffsetY = 5;
                        ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2);
                        const pivotGrad = ctx.createRadialGradient(-6, -6, 2, 0, 0, 20);
                        pivotGrad.addColorStop(0, '#fff'); pivotGrad.addColorStop(0.5, '#bbb'); pivotGrad.addColorStop(1, '#333');
                        ctx.fillStyle = pivotGrad; ctx.fill();
                        ctx.shadowColor = 'transparent';
                        ctx.beginPath(); ctx.arc(0, 0, 5, 0, Math.PI*2); ctx.fillStyle = '#111'; ctx.fill();
                        ctx.restore();
                    }
                }
                
                if (state.miniVizActive && viz.mpCvs) {
                    const mw = viz.mpCvs.width = viz.mpCvs.offsetWidth;
                    const mh = viz.mpCvs.height = viz.mpCvs.offsetHeight;
                    const mCtx = viz.mpCtx;
                    const surfaceColor = getComputedStyle(document.body).getPropertyValue('--surface');
                    mCtx.fillStyle = surfaceColor; mCtx.fillRect(0,0,mw,mh);
                    mCtx.fillStyle = `hsla(${hue}, 80%, 60%, 0.8)`; 
                    viz.particles.forEach(p => { mCtx.beginPath(); mCtx.arc(p.x * mw, p.y * mh, p.r, 0, Math.PI*2); mCtx.fill(); });
                    const mcx = mw / 2, mcy = mh / 2;
                    mCtx.save(); mCtx.translate(mcx, mcy);
                    const textScale = 1 + (idlePulse * 0.1) + (smoothBass / 255) * 0.2; 
                    mCtx.scale(textScale, textScale);
                    mCtx.font = 'bold 10px "Asap", sans-serif'; mCtx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text-main');
                    mCtx.textAlign = 'center'; mCtx.textBaseline = 'middle';
                    const glowIntensity = (smoothBass / 255);
                    mCtx.shadowBlur = 5 + glowIntensity * 15;
                    mCtx.shadowColor = `hsla(${hue}, 80%, 60%, ${0.5 + glowIntensity * 0.5})`;
                    mCtx.fillText('नाद', 0, 2); mCtx.restore();
                }
            }
        };

        function openDB() { return new Promise(r => { const q=indexedDB.open(DB_NAME,1); q.onupgradeneeded=e=>{const d=e.target.result; if(!d.objectStoreNames.contains(STORE_TRACKS))d.createObjectStore(STORE_TRACKS,{keyPath:'id'}); if(!d.objectStoreNames.contains(STORE_IMAGES))d.createObjectStore(STORE_IMAGES,{keyPath:'path'});}; q.onsuccess=()=>r(q.result); }); }
        function put(st,v) { return new Promise(r=>{const tx=db.transaction(st,'readwrite');tx.objectStore(st).put(v);tx.oncomplete=r;}); }
        function getAll(st) { return new Promise(r=>{const tx=db.transaction(st,'readonly');tx.objectStore(st).getAll().onsuccess=e=>r(e.target.result);}); }

        document.addEventListener('DOMContentLoaded', () => {
            if (window.Capacitor) {
                init();
            } else {
                let checks = 0;
                const i = setInterval(() => {
                    if (window.Capacitor) { clearInterval(i); init(); } else if (checks > 10) { clearInterval(i); init(); }
                    checks++;
                }, 100);
            }
        });
        if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(reg => console.log('Service Worker registered!', reg)).catch(err => console.log('Service Worker registration failed: ', err)); }); }
    </script>
</body>
</html>